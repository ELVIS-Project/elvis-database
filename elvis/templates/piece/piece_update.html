{% extends "base.html" %}


<!-- The javascript function for the typeahead functionality on the fields. -->

{% block extra_hd %}

    {% load staticfiles %}
    <script type='text/javascript' src="{% static "js/elvis-scripts/autocomplete.js" %}"></script>
    <script type='text/javascript' src="{% static "js/elvis-scripts/dynamicFileTable.js" %}"></script>
    <script type='text/javascript' src="{% static "bootstrap/plugins/bootstrap-filestyle.js" %}"></script>
    <script type='text/javascript' src="{% static "js/bootstrap-select.min.js" %}"></script>
    <link href="{% static "css/bootstrap-select.css" %}" rel="stylesheet" media="screen"/>

    <title>Update a Piece</title>

    <style>
        .popover
        {
            max-width: 500px;
            width: auto;
        }
    </style>
    <script>
        $(document).ready(function ($)
        {
            var oldPiece = {};
            var changes = {};
            changes['modify'] = [];
            changes['delete'] = [];
            changes['add'] = [];

            autocomplete("title", "title_suggestion_menu", "pieceSuggest");
            autocomplete("composer", "composer_suggestion_menu", "composerSuggest");
            autocomplete("collections", "collection_suggestion_menu", "collectionSuggest", 'list');
            autocomplete("languages", "language_suggestion_menu", "languageSuggest", 'list');
            autocomplete("genres", "genre_suggestion_menu", "genreSuggest", 'list');
            autocomplete("locations", "location_suggestion_menu", "locationSuggest", 'list');
            autocomplete("sources", "source_suggestion_menu", "sourceSuggest", 'list');
            autocomplete("instruments_voices", "instrumentation_suggestion_menu", "instrumentSuggest", 'list');
            autocomplete("tags", "tags_suggestion_menu", "tagSuggest", 'list');

            var mov_table = $("#movement_table");
            mov_table.dynamicTable({
                button: $("#new_mov"),
                table_name: "mov",
                movement: true
            });

            var file_table = $("#piece_file_table");
            file_table.dynamicTable({
                button: $("#new_piece_file"),
                table_name: "files"
            });

            fillUpdateForm();
            $('[data-toggle="popover"]').popover();


            // The dropdown form for additional composer information.
            var $newComposerMenu = $("#composer-create-new-menu");
            var $composerInput = $("#composer");
            $newComposerMenu.hide();

            $composerInput.on("focusout", function (event)
            {
                var query = $("#composer").val();

                if (query.length > 0)
                {
                    $.ajax({
                        url: "/composers/",
                        data: {q: query},
                        success: function (data)
                        {
                            if (data['count'] == 0)
                            {
                                $newComposerMenu.children().remove(".top-message");
                                $newComposerMenu.prepend("<div class='top-message'><span class='help-block'>" +
                                        "<hr>We don't have <strong>" + query + "</strong> in our database. " +
                                        "Submitting a piece by an unknown composer will add the composer to the database. <br>" +
                                        "Do you have additional information to add to this new composer?<br><br></span></div>");
                                $newComposerMenu.slideDown("slow");
                            }
                        }
                    });
                }
            });

            $composerInput.on("keydown", function (event)
            {
                if (event['keyCode'] !== 13)
                {
                    $newComposerMenu.slideUp("slow");
                }
            });

            {#            $(window).on('beforeunload', function (event)#}
            {#            {#}
            {#                if (event['target']['activeElement']['id'] === 'goto-piece')#}
            {#                {#}
            {#                    $(window).off('beforeunload');#}
            {#                }#}
            {#                else#}
            {#                {#}
            {#                    return 'Leaving this page will clear your form.'#}
            {#                }#}
            {#            });#}

            //Disable default behaviour for hitting 'enter' for all inputs except the comment.
            $('input:not(#comment)').on("keydown", function (event)
            {
                if (event.keyCode === 13)
                {
                    event.preventDefault()
                }
            });

            $("#piece-submit").click(function()
            {
                findChanges();
                if (changes['delete'].length > 0 || changes['add'].length > 0 ||changes['modify'].length > 0 )
                {
                    var body_string = "";
                    if (changes['delete'].length > 0)
                    {
                        var deletion_string = "<h4>Delete</h4><ul>";
                        for (var i = 0; i < changes['delete'].length; i++)
                        {
                            var item = changes['delete'][i];
                            if (item['type'] === 'A')
                            {
                                deletion_string += "<li>Delete file <em>" + item['name'] + "</em> attached to <strong>" + item['parent'] + "</strong>.</li>"
                            }
                            else
                            {
                                deletion_string += "<li>Delete movement <strong>" + item['name'] + "</strong>.</li>"
                            }
                        }
                        deletion_string += "</ul>";
                        body_string += deletion_string;
                    }
                    if (changes['add'].length > 0)
                    {
                        var addition_string = "<h4>Add</h4><ul>";
                        for (var i = 0; i < changes['add'].length; i++)
                        {
                            var item = changes['add'][i];
                            if (item['type'] === 'A')
                            {
                                addition_string += "<li>Add file <em>" + item['name'] + "</em> attached to <strong>" + item['parent'] + "</strong>.</li>"
                            }
                            else
                            {
                                addition_string += "<li>Add movement <strong>" + item['name'] + "</strong> to <strong>{{ content.title }}</strong></li>"
                            }
                        }
                        addition_string += "</ul>";
                        body_string += addition_string;
                    }
                    if (changes['modify'].length > 0)
                    {
                        var isObjectFound = false;
                        var modify_string = "<h4>Moving</h4><ul>";
                        for (var i = 0; i < changes['modify'].length; i++)
                        {
                            var item = changes['modify'][i];
                            if (item['type'] === 'A')
                            {
                                isObjectFound = true;
                                modify_string += "<li>Moving file <em>" + item['name'] + "</em> from <strong>" + item['oldParent'] + "</strong> to <strong>" + item['newParentTitle'] + "</strong>.</li>"
                            }
                        }
                        modify_string += "</ul>";
                        if (isObjectFound)
                        {
                            body_string += modify_string;
                        }
                    }

                    if (body_string !== "")
                    {
                        $base_modal_header.html("<h4 class='modal-title'>Confirm Database Changes</h4>");
                        $base_modal_body.html(body_string);
                        $base_modal_footer.html('.modal-footer').html("<button type='button' class='btn btn-default' id='restart-button'>Restart</button>" +
                                "<button class='btn btn-default' id='confirm-changes'>Looks good!</a>");
                        $base_modal.modal('show');
                        $("#restart-button").click(function ()
                        {
                            location.reload();
                        });
                        $("#confirm-changes").click(function ()
                        {
                            $("#new-piece-form").submit();
                        })
                    }
                    else
                    {
                        $("#new-piece-form").submit();
                    }
                }
                else
                {
                    $("#new-piece-form").submit();
                }

            });

            // Logic for form validation and submission, as well as the modal which appears on submission.,
            $("#new-piece-form").submit(function (event)
            {
                event.preventDefault();
                $base_modal_header.html("<h4 class='modal-title'>Creating Piece...</h4>");
                $base_modal_body.html("<div class='progress'>" +
                        "<div class='progress-bar progress-bar-striped active' role='progressbar' style='width: 100%'></div> " +
                        "</div>");
                $base_modal_footer.html("");
                $base_modal.modal('show');

                var formData = new FormData(this);
                formData.append('changes', JSON.stringify(changes));
                $.ajax({
                    type: "post",
                    url: window.location.href,
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (data)
                    {
                        if (data['errors'] === undefined)
                        {
                            $base_modal_header.html("<h4 class='modal-title'>Done!</h4>");
                            $base_modal_body.html("<p>Piece succesfuly updated!</p>");
                            $base_modal_footer.html('.modal-footer').html( "<button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>" +
                                    "<a href='" + data['url'] + "' class='btn btn-default' id='goto-piece'>Go to Piece</a>");
                        }
                        else
                        {
                            var errors = "";
                            for (var key in data['errors'])
                            {
                                if (key === "religiosity")
                                {
                                    $("input[name='religiosity']").parent().removeClass("btn-default").addClass("btn-danger")
                                }
                                else if (key === "vocalization")
                                {
                                    $("input[name='vocalization']").parent().removeClass("btn-default").addClass("btn-danger")
                                }
                                else if (key === "collections")
                                {
                                    continue
                                }
                                else
                                {
                                    $("#" + key).parent().addClass("has-error");
                                }

                                $("#" + key + "_error").html("<b style='color:red'>" + data['errors'][key][0] + "</b>");
                                errors = errors + "<strong>" + (key.charAt(0).toUpperCase() + key.slice(1)).replace(/_/g, ' ') + "</strong>: " + data['errors'][key][0] + "<br>"
                            }
                            $base_modal_header.html("<h4 class='modal-title'>Form Error<h4>");
                            $base_modal_body.html("<p>Your submission has the following errors: <br>" + errors + "</p>");
                            $base_modal_footer.html("<button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>");
                        }

                    },
                    error: function (data)
                    {
                        $base_modal_header.html("<h4 class='modal-title'>Server Error<h4>");
                        $base_modal_body.html("<p>An error occurred while uploading your file. Please try again, or, if the error persists, " +
                                "<a href='mailto:elvisdatabase@gmail.com?Subject=Upload%20Error'>contact us</a></p>");
                        $base_modal_footer.html("<button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>");
                    }
                })
            });

            var $upload_fields = $(".upload-input-field");
            $upload_fields.focus(function (event)
            {
                $(event.target.parentElement.children[0]).popover('toggle');
            });
            $upload_fields.focusout(function (event)
            {
                $(event.target.parentElement.children[0]).popover('hide');
            });

            //Limit date inputs to 4 characters.
            $("input[type=number]").keypress(function (event)
            {
                if (event.which !== 0 && event.which !== 8)
                {
                    if (this.value.length > 3 || (event.which < 48 || event.which > 57))
                    {
                        return false
                    }
                }
            });

            //$("#upload-page-content").html("<p class='lead text-center'>Sorry, uploads are temporarily disabled while the database is updated.</p>")

            // Get a json representation of the piece, and fill the form with its values.
            function fillUpdateForm()
            {
                $.ajax({
                    datatype: "json",
                    url: "/piece/{{ content.item_id }}/?format=json",
                    success: function (data)
                    {
                        oldPiece = data;
                        fillPieceForm();
                        fillDynamicTables();
                    }
                });
            }

            // Fill the text and number form inputs.
            function fillPieceForm()
            {
                $("#title").val(oldPiece['title']);
                oldPiece['composer'] = oldPiece['composer'].name;
                $("#composer").val(oldPiece['composer']);
                $("#comment").val(oldPiece['comment']);
                $("#composition_start_date").val(oldPiece['date_of_composition']);
                $("#composition_end_date").val(oldPiece['date_of_composition2']);
                $("#number_of_voices").val(oldPiece['number_of_voices']);
                oldPiece['languages'] = writeList(oldPiece['languages']);
                oldPiece['collections'] = writeList(oldPiece['collections'], true);
                oldPiece['genres'] = writeList(oldPiece['genres']);
                oldPiece['locations'] = writeList(oldPiece['locations']);
                oldPiece['instruments_voices'] = writeList(oldPiece['instruments_voices']);
                oldPiece['sources'] = writeList(oldPiece['sources']);
                oldPiece['tags'] = writeList(oldPiece['tags']);
                $("#collections").val(oldPiece['collections']);
                $("#languages").val(oldPiece['languages']);
                $("#genres").val(oldPiece['genres']);
                $("#locations").val(oldPiece['locations']);
                $("#instruments_voices").val(oldPiece['instruments_voices']);
                $("#sources").val(oldPiece['sources']);
                $("#tags").val(oldPiece['tags']);

                var $religButtons = $("#religiosity");
                for (var i = 0; i < 3; i++)
                {
                    if ($religButtons.children()[i].innerText == oldPiece['religiosity'])
                    {
                        $religButtons.children()[i].className += " active ";
                        $($religButtons.children()[i].children[0]).prop("checked", "true");
                        break;
                    }
                }
                var $vocalButtons = $("#vocalization");
                for (var i = 0; i < 3; i++)
                {
                    if ($vocalButtons.children()[i].innerText == oldPiece['vocalization'])
                    {
                        $vocalButtons.children()[i].className += " active ";
                        $($vocalButtons.children()[i].children[0]).prop("checked", "true");
                        break;
                    }
                }
            }

            // Populate and fill the dynamicTables.
            function fillDynamicTables()
            {
                var file_table = $("#piece_file_table");
                var mov_table = $("#movement_table");
                var fc = 1;

                for (var i = 0; i < oldPiece['attachments'].length; i++)
                {
                    file_table.dynamicTable('addRow', true);
                    var $file = file_table.find("#files_existing_files_" + (fc));
                    var $source = file_table.find("#_existingfiles_source_" + (fc));
                    var row = file_table.find("#_existingfiles" + (fc));
                    row.attr('name', oldPiece['attachments'][i]['id']);
                    row.css('background-color', '#E8E8E8');
                    $file.attr("href", oldPiece['attachments'][i]['attachment']).text(oldPiece['attachments'][i]['file_name']);
                    $source.val(oldPiece['attachments'][i]['source']);
                    oldPiece['attachments'][i]['parent'] = "piece";

                    fc++;
                }

                for (var i = 0; i < oldPiece['movements'].length; i++)
                {
                    mov_table.dynamicTable('addRow', true);
                    var row = mov_table.find("#_existingmov" + (i + 1));
                    row.attr('name',oldPiece['movements'][i]['item_id'] );
                    row.css('background-color', '#E8E8E8');
                    var $title = mov_table.find("#_existingmov_title_" + (i + 1));
                    var $instruments = mov_table.find("#_existingmov" + (i + 1) + "_instrumentation");
                    var $tags = mov_table.find("#_existingmov" + (i + 1) + "_free_tags");
                    var $num_voices = mov_table.find("#_existingmov" + (i + 1) + "_number_of_voices");
                    var $comment = mov_table.find("#_existingmov" + (i + 1) + "_comment");
                    var $vocalization = mov_table.find("#_existingmov" + (i + 1) + "_vocalization");
                    for (var j = 0; j < 3; j++)
                    {
                        if ($vocalization.children()[j].innerText === oldPiece['movements'][i]['vocalization'])
                        {
                            $vocalization.children()[j].className += " active ";
                            $($vocalization.children()[j].children[0]).prop("checked", "true");
                            break;
                        }
                    }
                    oldPiece['movements'][i]['instruments_voices'] = writeList(oldPiece['movements'][i]['instruments_voices']);
                    oldPiece['movements'][i]['tags'] = writeList(oldPiece['movements'][i]['tags']);
                    $title.val(oldPiece['movements'][i].title);
                    $instruments.val(oldPiece['movements'][i].instruments_voices);
                    $tags.val(oldPiece['movements'][i].tags);
                    $num_voices.val(oldPiece['movements'][i].number_of_voices);
                    $comment.val(oldPiece['movements'][i].comment);
                    for (var j = 0; j < oldPiece['movements'][i]['attachments'].length; j++)
                    {
                        file_table.dynamicTable('addRow', true);
                        var row = file_table.find("#_existingfiles" + (fc));
                        row.css('background-color', '#E8E8E8');
                        var $file = file_table.find("#files_existing_files_" + (fc));
                        var $attach = file_table.find("#_existingfiles_parent_" + (fc));
                        var $source = file_table.find("#_existingfiles_source_" + (fc));
                        var row = file_table.find("#_existingfiles" + (fc));
                        row.attr('name', oldPiece['movements'][i]['attachments'][j]['id']);
                        $file.attr("href", oldPiece['movements'][i]['attachments'][j]['attachment']).text(oldPiece['movements'][i]['attachments'][j]['file_name']);
                        $source.val(oldPiece['movements'][i]['attachments'][j]['source']);
                        $attach.selectpicker('val', "_existingmov_title_" + (i + 1));
                        oldPiece['movements'][i]['attachments'][j]['parent'] = "_existingmov_title_" + (i + 1);
                        fc++;
                    }
                    file_table.dynamicTable('drawAttachSelects');
                }

                //listener for deleting existing movements or files
                $("[id^=del_mov], [id^=del_files]").click(function (event)
                {
                    var row = $(event['target']).parents("[id^=_existing]")[0];
                    var type,
                        id,
                        name,
                        parent;
                    if (row.id.indexOf('mov') !== -1)
                        type = "M";
                    else
                        type = "A";
                    if (type == "A")
                    {
                        parent = row.children[2].children[1].children[0].title;
                        name = row.children[1].children[0].text;
                        id = row.getAttribute('name');
                        changes['delete'].push({type: type, id: id, name: name, parent: parent});
                    }
                    else
                    {
                        name = row.children[2].children[0].value;
                        id = row.getAttribute('name');
                        changes['delete'].push({type: type, id: id, name: name});
                    }

                });
                $base_modal_header.html("<h4 class='modal-title'>Modifying an existing piece...<h4>");
                $base_modal_body.html("<p>This form has been pre-filled with the current state of <em>{{ content.title }}</em>.<ul><li>You may modify any of its properties.</li>" +
                        "<li>Do not modfiy any fields that you do not wish to change.</li> <li>Existing movements and files are colored dark grey - you may modify or delete these as well.</li>" +
                        "<li>You may also add new movements and files.</li></ul>" +
                        "<strong>No changes are applied until you click the submit button </strong> at the bottom of the page. If you make a mistake, or need to restart the process, simply reload the page. </p>");
                $base_modal_footer.html("<button type='button' class='btn btn-success' data-dismiss='modal'>Got it</button>");
                $base_modal.modal('show');
            }

            function writeList(jlist, collection)
            {
                var result = "";
                if (collection)
                {
                    for (var i = 0; i < jlist.length; i++)
                    {
                        if (jlist[i].public)
                        {
                            result += jlist[i].title + "; "
                        }
                    }
                }
                else
                {
                    for (var i = 0; i < jlist.length; i++)
                    {
                        result += jlist[i].name + "; "
                    }
                }
                return result
            }

            function findChanges()
            {
                // Compare text and number fields to their previous values, save
                // changes in the changes dict.
                var $inputs = $(".upload-input-field");
                for (var i = 0; i < $inputs.length; i++)
                {
                    var id = $inputs[i].getAttribute('id');
                    if (id === "composition_start_date")
                        var id2 = "date_of_composition";
                    else if (id === "composition_end_date")
                        id2 = "date_of_composition2";
                    else
                        id2 = id;
                    if ($("#" + id).val() != oldPiece[id2])
                    {
                        if (id === "comment" && $("#" + id).val() === "" && oldPiece[id2] === null)
                            continue;
                        //A text field from the top of the form doesnt match the previous value.
                        changes['modify'].push({
                            type: 'F',
                            id: id2,
                            value: $("#" + id).val()
                        });
                    }
                }
                var $religButtons = $("#religiosity");
                for (var i = 0; i < 3; i++)
                {
                    if ($religButtons.children()[i].className.indexOf("active") !== -1)
                    {
                        if ($religButtons.children()[i].innerText == oldPiece['religiosity'])
                        {
                            break
                        }
                        else
                        {
                            changes['modify'].push({
                                type: 'F', id: 'religiosity',
                                value: $religButtons.children()[i].innerText
                            })
                        }
                    }
                }
                var $vocalButtons = $("#vocalization");
                for (var i = 0; i < 3; i++)
                {
                    if ($vocalButtons.children()[i].className.indexOf("active") !== -1)
                    {
                        if ($vocalButtons.children()[i].innerText == oldPiece['vocalization'])
                        {
                            break
                        }
                        else
                        {
                            changes['modify'].push({
                                type: 'F', id: 'vocalization',
                                value: $vocalButtons.children()[i].innerText
                            })
                        }
                    }
                }

                // Find changed movements, record their changes.
                var $existing_movements = mov_table.children('[id^=_existingmov]');
                for (var i = 0; i < $existing_movements.length; i += 2)
                {
                    // Get info from form
                    var modifications = {};
                    var oldMov = null;
                    var fields = [];
                    var $titleRow = $($existing_movements[i]);
                    var $advancedRow = $($existing_movements[i + 1]);
                    var id = parseInt($titleRow[0].getAttribute('name'));
                    fields.push(['title', $titleRow.find("[id^=_existingmov_title_]")[0].value]);
                    fields.push(['instruments_voices', $advancedRow.find("[id$=_instrumentation]")[0].value]);
                    fields.push(['tags', $advancedRow.find("[id$=_free_tags]")[0].value]);
                    fields.push(['number_of_voices', $advancedRow.find("[id$=_number_of_voices]")[0].value]);
                    fields.push(['comment', $advancedRow.find("[id$=_comment]")[0].value]);
                    var selected_vocal = $($advancedRow.find("[id$=_vocalization]")[0]).children(".active")[0];
                    if (selected_vocal)
                        fields.push(['vocalization', selected_vocal.children[0].value]);

                    // Get old movement info
                    for (var j = 0; j < oldPiece['movements'].length; j++)
                    {
                        if (oldPiece['movements'][j]['item_id'] === id)
                        {
                            oldMov = oldPiece['movements'][j];
                            break
                        }
                    }

                    //Compare the two and add changed values to changes.
                    var key = 0;
                    var value = 1;
                    for (var j = 0; j < fields.length; j++)
                    {
                        if (oldMov[fields[j][key]] != fields[j][value])
                        {
                            if (fields[j][key] === "comment" && fields[j][value] === "" && oldMov[fields[j][key]] === null)
                                continue;
                            modifications[fields[j][key]] = fields[j][value]
                        }
                    }
                    if (!$.isEmptyObject(modifications))
                    {
                        modifications['id'] = id;
                        modifications['type'] = "M";
                        changes['modify'].push(modifications)
                    }
                }
                // Find and log new movements.
                var $new_movements = mov_table.children('[id^=mov]');
                for (var i = 0; i < $new_movements.length; i += 2)
                {
                    var $titleRow = $($new_movements[i]);
                    var title = $titleRow.find("[id^=mov_title_]")[0].value;
                    if (title === "")
                        continue;

                    changes['add'].push({type:"M", name: title})
                }

                //Find changed attachments - record changes
                var $existing_attachments = file_table.children('[id^=_existingfiles]');
                for (var i = 0; i < $existing_attachments.length; i++)
                {
                    var modifications = {};
                    var oldAtt = null;
                    var fields = [];
                    var row = $($existing_attachments[i]);
                    var id = parseInt(row.attr('name'));
                    fields.push(['parent', row.find("[id^=_existingfiles_parent_]")[0].value]);
                    fields.push(['source', row.find("[id^=_existingfiles_source_]")[0].value]);

                    //Find old attachment.
                    //First search piece attachments
                    for (var j = 0; j < oldPiece['attachments'].length; j++)
                    {
                        if (oldPiece['attachments'][j]['id'] === id)
                        {
                            oldAtt = oldPiece['attachments'][j];
                            var oldParent= 'the piece';
                            break;
                        }
                    }
                    //If not found, search movement attachments
                    if (oldAtt === null)
                    {
                        for (var j = 0; j < oldPiece['movements'].length; j++)
                        {
                            for (var k = 0; k < oldPiece['movements'][j]['attachments'].length; k++)
                            {
                                if (oldPiece['movements'][j]['attachments'][k]['id'] === id)
                                {
                                    oldAtt = oldPiece['movements'][j]['attachments'][k];
                                    var oldParent = oldPiece['movements'][j]['title'];
                                    break;
                                }
                            }
                            if (oldAtt !== null)
                            {
                                break
                            }
                        }
                    }
                    //Compare the two
                    for (var j = 0; j < fields.length; j++)
                    {
                        if (oldAtt[fields[j][key]] !== fields[j][value])
                        {
                            if (fields[j][key] === "source" && fields[j][value] === "" && oldAtt[fields[j][key]] === null)
                                continue;
                            modifications[fields[j][key]] = fields[j][value]
                        }
                    }

                    //If differences exist, push th
                    if (!$.isEmptyObject(modifications))
                    {
                        modifications['id'] = id;
                        modifications['type'] = "A";
                        modifications['name'] = row.children()[1].children[0].text;
                        modifications['oldParent'] = oldParent;
                        modifications['newParentTitle'] = row.children()[2].children[1].children[0].title;
                        if (modifications['parent'] !== "piece")
                        {
                            modifications['newParent'] = row.children()[2].children[0].value;
                        }
                        changes['modify'].push(modifications)
                    }
                }
                // Find and log new attachments.
                var $new_attachments = file_table.children('[id^=files]');
                for (var i = 0; i < $new_attachments.length; i ++)
                {
                    var row = $($new_attachments[i]);
                    var title = row.children()[1].children[1].children[1].value;
                    if (title === "")
                        continue;

                    var parent = row.children()[2].children[1].children[0].title;
                    if (parent === "Attach to Piece")
                        parent = "the piece";

                    changes['add'].push({type:"A", name: title, parent: parent})
                }
            }
        });
    </script>

{% endblock %}


{% block wrap %}

    <div class="page-header">
        <h2>Update <em>{{ content.title }}</em> by {{ content.composer.name }}
        </h2>
    </div>
    <div id="upload-page-content">
        <form action="/pieces/" method="post" id="new-piece-form"
              enctype="multipart/form-data">{% csrf_token %}
            <span class="help-block">
                The fields in this form have been pre-filled with the data of this piece. You may
                modify any field just as you would when creating a piece.
            </span>
            <br>

            <div class="input-group">
              <span class="input-group-addon" data-toggle="popover"
                    data-placement="top" data-trigger="focus"
                    data-html='true'
                    title="<b>Title</b><span class='label label-primary pull-right'>Required</span>"
                    data-viewport="#content-container"
                    data-content="Note: Duplicate titles will produce duplicate pieces in the database: this is to allow for
                    composers who may have more than one piece with the same name.">Title</span>
                <input type="text" id="title" name="title" autocomplete="off"
                       class="form-control upload-input-field">
            </div>
            <div id="title_suggestion_menu" style="padding-left:120px"></div>
            <div id="title_error"></div>
            <br>

            <div class="input-group">
                    <span class="input-group-addon" data-toggle="popover"
                          data-placement="top" data-trigger="focus"
                          data-html='true' data-viewport="#content-container"
                          title="<b>Composer Name</b><span class='label label-primary pull-right'>Required</span>"
                          data-content="<ul><li>If present, select your composer from the dropdown suggestion menu in order to minimize duplicates.</li>
                          <li>If you add a new composer, use the spelling from Grove.</li><li>If you don’t know the composer, input Anonymous.</li></ul>">Composer</span>
                <input type="text" id="composer" name="composer"
                       autocomplete='off'
                       class="form-control upload-input-field">
            </div>
            <div id="composer_suggestion_menu"
                 style="padding-left:120px"></div>
            <div id="composer_error"></div>
            <div id="composer-create-new-menu"
                 style="padding-left:50px; padding-right:50px">
                <div class="row" style="padding-left:20px; padding-right:20px">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <input type='number' name="composer_birth_date"
                                       id="composer_birth_date" max="2000"
                                       class="form-control unstyled"/>
                                <span class="input-group-addon">Birth</span>
                            </div>
                            <div id="composer_birth_date_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <input type='number' name="composer_death_date"
                                       id="composer_death_date" max="2000"
                                       class="form-control unstyled"/>
                                <span class="input-group-addon">Death</span>
                            </div>
                            <div id="composer_death_date_error"></div>
                        </div>
                    </div>
                </div>
                <hr>
            </div>
            <br>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <div class="input-group">
                                <span class="input-group-addon"
                                      data-toggle="popover"
                                      data-placement="top"
                                      data-trigger="focus" data-html='true'
                                      data-viewport="#content-container"
                                      title="<b>Composition Start Date</b> <span class='label label-warning pull-right'>Optional</span>"
                                      data-content="The year work began on the piece.<br>
                                      <ul><li>If only one date is known, submit it as the 'Composition End Date'.</li>
                                        <li>If you don’t know the date(s) of the piece, input a reasonable date range (e.g. adult years of composer’s life, or date range of sources in which it
                                      is found; you can also use dates from Grove).</li></ul>">Composition Start Date</span>
                            <input type='number' name="composition_start_date"
                                   id="composition_start_date"
                                   autocomplete='off' max="2000"
                                   placeholder="Not specified in piece."
                                   class="form-control upload-input-field"/>
                        </div>
                        <div id="composition_start_date_error"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <div class="input-group">
                                <span class="input-group-addon"
                                      data-toggle="popover"
                                      data-placement="top"
                                      data-trigger="focus" data-html='true'
                                      data-viewport="#content-container"
                                      title="<b>Composition End Date</b><span class='label label-primary pull-right'>Required</span>"
                                      data-content="The year the piece was completed, or the first date of publication.<br><ul><li>If you don’t know the date(s) of the piece, input a reasonable date range (e.g. adult years of composer’s life,
                                      or date range of sources in which it is found; you can also use dates from Grove).</li></ul>">Composition End Date</span>
                            <input type='number' name="composition_end_date"
                                   id="composition_end_date"
                                   autocomplete='off' max="2000"
                                   placeholder="Not specified in piece."
                                   class="form-control upload-input-field"/>
                        </div>
                        <div id="composition_end_date_error"></div>
                    </div>
                </div>
            </div>

            <h2>Additional Information</h2>
            <hr>
        <span class="help-block">
            These fields make it easier to find the piece using the database search engine. Most fields can accept a list of inputs separated by semicolons.
            For example, if the piece has a harpsichord, violin and cello, you can input "harpsichord; violin; cello" in the instrumentation field. If
            this piece has movements, which you can define below, a number of these fields can be overridden on a per-movement basis.
        </span>

            <div class="row">
                <div class="col-md-6">
                    <div class="btn-group btn-group-justified form-inline radio"
                         id="religiosity" data-toggle="buttons">
                        <label class="btn btn-default">
                            <input type="radio" name="religiosity"
                                   value="Sacred"> Sacred
                        </label>
                        <label class="btn btn-default">
                            <input type="radio" name="religiosity"
                                   value="Secular"> Secular
                        </label>
                        <label class="btn btn-default">
                            <input type="radio" name="religiosity"
                                   value="Ambiguous"> Ambiguous
                        </label>
                    </div>
                    <div id="religiosity_error"></div>
                </div>
                <div class="col-md-6">
                    <div class="btn-group btn-group-justified form-inline radio"
                         id="vocalization" data-toggle="buttons">
                        <label class="btn btn-default">
                            <input type="radio" name="vocalization"
                                   value="Vocal"> Vocal
                        </label>
                        <label class="btn btn-default">
                            <input type="radio" name="vocalization"
                                   value="Instrumental"> Instrumental
                        </label>
                        <label class="btn btn-default">
                            <input type="radio" name="vocalization"
                                   value="Mixed"> Mixed
                        </label>
                    </div>
                    <div id="vocalization_error"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <div class="input-group">
                                <span class="input-group-addon"
                                      data-toggle="popover"
                                      data-placement="top"
                                      data-trigger="focus" data-html='true'
                                      data-viewport="#content-container"
                                      title="<b>Number of Voices</b> <span class='label label-primary pull-right'>Required</span>"
                                      data-content="Follow these rules for polyphonic instruments (keyboard, lute, guitar):<br><br>
                                      <ul>
                                       <li>If the piece has clearly defined independent voices for the whole piece (e.g. 2-part invention) list the number of voices</li>
                                       <li>If the individual voices are not clearly defined, or the voice leading is free, input 0.</li>
                                       <li>List the basso continuo as one voice.</li>
                                      </ul>">
                                    Num. of Voices</span>
                            <input type='number' name="number_of_voices"
                                   autocomplete="off"
                                   placeholder="Not specified in piece."
                                   id="number_of_voices" max="100"
                                   class="form-control unstyled upload-input-field"/>
                        </div>
                        <div id="number_of_voices_error"></div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <div class="input-group">
                                <span class="input-group-addon"
                                      data-toggle="popover"
                                      data-placement="top"
                                      data-trigger="focus" data-html='true'
                                      data-viewport="#content-container"
                                      title="<b>Languages</b><span class='label label-warning pull-right'>Contextual</span>"
                                      data-content="Languages are required if the piece is <b>Vocal</b> or <b>Mixed</b>, but <i>should be left blank for</i> <b>Instrumental</b> pieces.">Text Language</span>
                            <input type='text' name="languages" id="languages"
                                   autocomplete="off"
                                   placeholder="Not specified in piece."
                                   class="form-control unstyled upload-input-field"/>
                        </div>
                        <div id="language_suggestion_menu"
                             style="padding-left:120px"></div>
                        <div id="languages_error"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <div class="input-group">
                                <span class="input-group-addon"
                                      data-toggle="popover"
                                      data-placement="top"
                                      data-trigger="focus" data-html='true'
                                      data-viewport="#content-container"
                                      title="<b>Genres</b> <span class='label label-primary pull-right'>Required</span>"
                                      data-content="If present, select a genres from the drop-down list.">Genres</span>
                            <input type='text' name="genres" id="genres"
                                   autocomplete="off"
                                   placeholder="Not specified in piece."
                                   class="form-control unstyled upload-input-field"/>
                        </div>
                        <div id="genre_suggestion_menu"
                             style="padding-left:120px"></div>
                        <div id="genres_error"></div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <div class="input-group">
                                    <span class="input-group-addon"
                                          data-toggle="popover"
                                          data-placement="top"
                                          data-trigger="focus" data-html='true'
                                          data-viewport="#content-container"
                                          title="<b>Place of Origin</b> <span class='label label-warning pull-right'>Optional</span>"
                                          data-content="Indicate the region where the piece might have been composed. General terms are preferred (e.g. Low Countries; Austria, not Vienna; Italy, not Rome)">Place of Origin</span>
                            <input type='text' name="locations" id='locations'
                                   autocomplete="off"
                                   placeholder="Not specified in piece."
                                   class="form-control unstyled upload-input-field"/>
                        </div>
                        <div id="location_suggestion_menu"
                             style="padding-left:120px"></div>
                        <div id="locations_error"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <div class="input-group">
                                <span class="input-group-addon"
                                      data-toggle="popover"
                                      data-placement="top"
                                      data-trigger="focus" data-html='true'
                                      data-viewport="#content-container"
                                      title="<b>Instrumentation</b> <span class='label label-primary pull-right'>Required</span>"
                                      data-content="Use semicolons as a separator for the list of instruments in the piece.">Instrumentation</span>
                            <input type='text' name="instruments_voices"
                                   autocomplete="off" id="instruments_voices"
                                   placeholder="Not specified in piece."
                                   class="form-control unstyled upload-input-field"/>
                        </div>
                        <div id="instrumentation_suggestion_menu"
                             style="padding-left:120px"></div>
                        <div id="instruments_voices_error"></div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <div class="input-group">
                                <span class="input-group-addon"
                                      data-toggle="popover"
                                      data-placement="top"
                                      data-trigger="focus" data-html='true'
                                      data-viewport="#content-container"
                                      title="<b>Sources</b> <span class='label label-warning pull-right'>Optional</span>"
                                      data-content="Use this field to specify the name(s) of the manuscript or print that was the source of this score.">Sources</span>
                            <input type='text' name="sources" id="sources"
                                   autocomplete="off"
                                   placeholder="Not specified in piece."
                                   class="form-control unstyled upload-input-field"/>
                        </div>
                        <div id="source_suggestion_menu"
                             style="padding-left:120px"></div>
                        <div id="sources_error"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <div class="input-group">
                    <span class="input-group-addon" data-toggle="popover"
                          data-placement="top" data-trigger="focus"
                          data-html='true'
                          data-viewport="#content-container"
                          title="<b>Tags</b> <span class='label label-warning pull-right'>Optional</span>"
                          data-content="You may add any other tags you believe would help organize and define this piece here. Try not to
                          duplicate information from the previous fields.">Tags</span>
                            <input type='text' name="tags" id="tags"
                                   autocomplete="off"
                                   class="form-control unstyled upload-input-field"
                                   placeholder="D-sharp Minor; 4/4"/>
                        </div>
                        <div id="tags_suggestion_menu"
                             style="padding-left:120px"></div>
                        <div id="tags_error"></div>
                    </div>
                </div>
            </div>
            <br>

            <div class="form-group">
            <textarea class="form-control upload-input-field" rows="7" name="comment" id="comment"
                      style="resize:vertical"
                      placeholder="Not specified in piece."></textarea>
            </div>
            <br>

            <h2>Movements</h2>
            <hr>
            <span class="help-block">
                If the work is divided into movements, acts, or other parts, declare them in this table.
                Many inputs may be overridden on a per-movement basis by clicking the 'Show Advanced' button.
                Movement that already exist in this piece are shaded dark-grey.
        </span>

            <div class="well">
                <h4>Movements</h4>
                <table class="table table-hover">
                    <colgroup>
                        <col class="text-center" style="width: 5%;">
                        <col style="width: 5%;">
                        <col style="width: 70%;">
                        <col style="width: 20%;">
                    </colgroup>
                    <tbody id="movement_table">
                    <tr>
                        <th class="text-center">Remove</th>
                        <th class="text-center">#</th>
                        <th>Movement Title</th>
                        <th>Advanced</th>
                    </tr>
                    <!-- User can add rows for files here -->
                    </tbody>
                </table>
                <hr>
                <div>
                    <button id="new_mov" type="button" class="btn btn-default">
                        Add Movement
                    </button>
                </div>
            </div>
            <br>

            <h2>Files</h2>
            <hr>


        <span class="help-block">
            Upload files with <a href="#" onClick="return false;"
                                 data-toggle="popover" data-placement="top"
                                 data-trigger="hover"
                                 title="<b>Acceptable Formats</b>"
                                 data-html='true'
                                 data-content=".mei, .xml, .pdf, .mxl, .krn, .nwc, .tntxt, .capx, .abc, .midi">
            acceptable formats</a> here. If the file is for a specific act or movement as entered above, select that entry from the drop-down menu in the "Attach To" column.
        </span>

            <div class="well">
                <h4>Files</h4>
                <table class="table table-hover">
                    <colgroup>
                        <col class="text-center" style="width: 5%;">
                        <col style="width: 45%;">
                        <col style="width: 15%;">
                        <col style="width: 35%;">
                    </colgroup>
                    <tbody id="piece_file_table">
                    <tr>
                        <th class="text-center">Remove</th>
                        <th>Files</th>
                        <th>Attach To</th>
                        <th>File Source</th>
                    </tr>
                    <!-- User can add rows for files here -->
                    </tbody>
                </table>
                <div>
                    <button id="new_piece_file" type="button"
                            class="btn btn-default">Add File
                    </button>
                </div>
            </div>
            <br>

            <hr>
            <div class="text-right">
                <button type='button' id='piece-submit'
                        class='btn btn-success'>Submit
                </button>
            </div>
            <br>
        </form>
    </div>


{% endblock %}

