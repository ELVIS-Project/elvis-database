$(document).ready(function(e){function t(){e.ajax({datatype:"json",url:window.location.href+"?format=json",success:function(e){l=e,i(),o(),n()}})}function o(){e("#title").val(l.title),l.composer=l.composer.name,e("#composer").val(l.composer),e("#comment").val(l.comment),e("#composition_start_date").val(l.composition_start_date),e("#composition_end_date").val(l.composition_end_date),e("#number_of_voices").val(l.number_of_voices),l.languages=a(l.languages),l.collections=a(l.collections,!0),l.genres=a(l.genres),l.locations=a(l.locations),l.instruments_voices=a(l.instruments_voices),l.sources=a(l.sources),l.tags=a(l.tags),e("#collections").val(l.collections),e("#languages").val(l.languages),e("#genres").val(l.genres),e("#locations").val(l.locations),e("#instruments_voices").val(l.instruments_voices),e("#sources").val(l.sources),e("#tags").val(l.tags);for(var t=e("#religiosity"),o=0;3>o;o++)if(t.children()[o].children[0].value===l.religiosity){t.children()[o].className+=" active ",e(t.children()[o].children[0]).prop("checked","true");break}for(var n=e("#vocalization"),o=0;3>o;o++)if(n.children()[o].children[0].value===l.vocalization){n.children()[o].className+=" active ",e(n.children()[o].children[0]).prop("checked","true");break}}function n(){for(var t=e("#piece_file_table"),o=e("#movement_table"),n=1,i=0;i<l.attachments.length;i++){t.dynamicTable("addRow",!0);var s=t.find("#files_existing_files_"+n),c=t.find("#_existingfiles_source_"+n),m=t.find("#_existingfiles"+n);m.attr("name",l.attachments[i].id),m.css("background-color","#E8E8E8"),s.attr("href",l.attachments[i].attachment).text(l.attachments[i].file_name),c.val(l.attachments[i].source),l.attachments[i].parent="piece",n++}for(var i=0;i<l.movements.length;i++){o.dynamicTable("addRow",!0);var m=o.find("#_existingmov"+(i+1));m.attr("name",l.movements[i].item_id),m.css("background-color","#E8E8E8");for(var d=o.find("#_existingmov_title_"+(i+1)),u=o.find("#_existingmov"+(i+1)+"_instrumentation"),h=o.find("#_existingmov"+(i+1)+"_free_tags"),f=o.find("#_existingmov"+(i+1)+"_number_of_voices"),v=o.find("#_existingmov"+(i+1)+"_comment"),g=o.find("#_existingmov"+(i+1)+"_vocalization"),p=0;3>p;p++)if(g.children()[p].children[0].value===l.movements[i].vocalization){g.children()[p].className+=" active ",e(g.children()[p].children[0]).prop("checked","true");break}l.movements[i].instruments_voices=a(l.movements[i].instruments_voices),l.movements[i].tags=a(l.movements[i].tags),d.val(l.movements[i].title),u.val(l.movements[i].instruments_voices),h.val(l.movements[i].tags),f.val(l.movements[i].number_of_voices),v.val(l.movements[i].comment);for(var p=0;p<l.movements[i].attachments.length;p++){t.dynamicTable("addRow",!0);var m=t.find("#_existingfiles"+n);m.css("background-color","#E8E8E8");var s=t.find("#files_existing_files_"+n),_=t.find("#_existingfiles_parent_"+n),c=t.find("#_existingfiles_source_"+n),m=t.find("#_existingfiles"+n);m.attr("name",l.movements[i].attachments[p].id),s.attr("href",l.movements[i].attachments[p].attachment).text(l.movements[i].attachments[p].file_name),c.val(l.movements[i].attachments[p].source),_.selectpicker("val","_existingmov_title_"+(i+1)),l.movements[i].attachments[p].parent="_existingmov_title_"+(i+1),n++}t.dynamicTable("drawAttachSelects")}e("[id^=del_mov], [id^=del_files]").click(function(t){var o,n,i,a,s=e(t.target).parents("[id^=_existing]")[0];o=-1!==s.id.indexOf("mov")?"M":"A","A"==o?(a=s.children[2].children[1].children[0].title,i=s.children[1].children[0].text,n=s.getAttribute("name"),r["delete"].push({type:o,id:n,name:i,parent:a})):(i=s.children[2].children[0].value,n=s.getAttribute("name"),r["delete"].push({type:o,id:n,name:i}))})}function i(){"true"!==sessionStorage.getItem("saw_instructions")&&($base_modal_header.html("<h4 class='modal-title'>Modifying an existing piece...<h4>"),$base_modal_body.html("<p>This form has been pre-filled with the current state of <em>"+l.title+"</em>.<ul><li>You may modify any of its properties.</li><li>Do not modfiy any fields that you do not wish to change.</li> <li>Existing movements and files are colored dark grey - you may modify or delete these as well.</li><li>You may also add new movements and files.</li></ul><strong>No changes are applied until you click the submit button </strong> at the bottom of the page. If you make a mistake, or need to restart the process, simply reload the page. </p>"),$base_modal_footer.html("<button type='button' class='btn btn-success' data-dismiss='modal'>Got it</button>"),$base_modal.modal("show"),sessionStorage.setItem("saw_instructions","true"))}function a(e,t){var o="";if(t)for(var n=0;n<e.length;n++)e[n]["public"]&&(o+=e[n].title+"; ");else for(var n=0;n<e.length;n++)o+=e[n].name+"; ";return o}function s(){for(var t=e(".upload-input-field"),o=0;o<t.length;o++){var n=t[o].getAttribute("id");if("composition_start_date"===n)var i="composition_start_date";else i="composition_end_date"===n?"composition_end_date":n;if(e("#"+n).val()!=l[i]){if("comment"===n&&""===e("#"+n).val()&&null===l[i])continue;r.modify.push({type:"F",id:i,value:e("#"+n).val()})}}for(var a=e("#religiosity"),o=0;3>o;o++)if(-1!==a.children()[o].className.indexOf("active")){if(a.children()[o].children[0].value==l.religiosity)break;r.modify.push({type:"F",id:"religiosity",value:a.children()[o].children[0].value})}for(var s=e("#vocalization"),o=0;3>o;o++)if(-1!==s.children()[o].className.indexOf("active")){if(s.children()[o].children[0].value==l.vocalization)break;r.modify.push({type:"F",id:"vocalization",value:s.children()[o].children[0].value})}for(var d=c.children("[id^=_existingmov]"),o=0;o<d.length;o+=2){var u={},h=null,f=[],v=e(d[o]),g=e(d[o+1]),n=parseInt(v[0].getAttribute("name"));f.push(["title",v.find("[id^=_existingmov_title_]")[0].value]),f.push(["instruments_voices",g.find("[id$=_instrumentation]")[0].value]),f.push(["tags",g.find("[id$=_free_tags]")[0].value]),f.push(["number_of_voices",g.find("[id$=_number_of_voices]")[0].value]),f.push(["comment",g.find("[id$=_comment]")[0].value]);var p=e(g.find("[id$=_vocalization]")[0]).children(".active")[0];p&&f.push(["vocalization",p.children[0].value]);for(var _=0;_<l.movements.length;_++)if(l.movements[_].item_id===n){h=l.movements[_];break}for(var b=0,y=1,_=0;_<f.length;_++)if(h[f[_][b]]!=f[_][y]){if("comment"===f[_][b]&&""===f[_][y]&&null===h[f[_][b]])continue;u[f[_][b]]=f[_][y]}e.isEmptyObject(u)||(u.id=n,u.type="M",r.modify.push(u))}for(var w=c.children("[id^=mov]"),o=0;o<w.length;o+=2){var v=e(w[o]),x=v.find("[id^=mov_title_]")[0].value;""!==x&&r.add.push({type:"M",name:x})}for(var k=m.children("[id^=_existingfiles]"),o=0;o<k.length;o++){var u={},$=null,f=[],A=e(k[o]),n=parseInt(A.attr("name"));f.push(["parent",A.find("[id^=_existingfiles_parent_]")[0].value]),f.push(["source",A.find("[id^=_existingfiles_source_]")[0].value]);for(var _=0;_<l.attachments.length;_++)if(l.attachments[_].id===n){$=l.attachments[_];var E="Attach to Piece";break}if(null===$)for(var _=0;_<l.movements.length;_++){for(var S=0;S<l.movements[_].attachments.length;S++)if(l.movements[_].attachments[S].id===n){$=l.movements[_].attachments[S];var E=l.movements[_].title;break}if(null!==$)break}for(var _=0;_<f.length;_++)if($[f[_][b]]!==f[_][y]){if("source"===f[_][b]&&""===f[_][y]&&null===$[f[_][b]])continue;u[f[_][b]]=f[_][y]}e.isEmptyObject(u)||(u.id=n,u.type="A",u.name=A.children()[1].children[0].text,u.oldParent=E,u.newParentTitle=A.children()[2].children[1].children[0].title,"piece"!==u.parent&&(u.newParent=A.children()[2].children[0].value),r.modify.push(u))}for(var C=m.children("[id^=files]"),o=0;o<C.length;o++){var A=e(C[o]),x=A.children()[1].children[1].children[1].value;if(""!==x){var D=A.children()[2].children[1].children[0].title;"Attach to Piece"===D&&(D="the piece"),r.add.push({type:"A",name:x,parent:D})}}}var l={},r={};r.modify=[],r["delete"]=[],r.add=[],autocomplete("title","title_suggestion_menu","pieceSuggest"),autocomplete("composer","composer_suggestion_menu","composerSuggest"),autocomplete("collections","collection_suggestion_menu","collectionSuggest","list"),autocomplete("languages","language_suggestion_menu","languageSuggest","list"),autocomplete("genres","genre_suggestion_menu","genreSuggest","list"),autocomplete("locations","location_suggestion_menu","locationSuggest","list"),autocomplete("sources","source_suggestion_menu","sourceSuggest","list"),autocomplete("instruments_voices","instrumentation_suggestion_menu","instrumentSuggest","list"),autocomplete("tags","tags_suggestion_menu","tagSuggest","list");var c=e("#movement_table");c.dynamicTable({button:e("#new_mov"),table_name:"mov",movement:!0});var m=e("#piece_file_table");m.dynamicTable({button:e("#new_piece_file"),table_name:"files"}),t(),e('[data-toggle="popover"]').popover();var d=e("#composer-create-new-menu"),u=e("#composer");d.hide(),u.on("focusout",function(){var t=e("#composer").val();t.length>0&&e.ajax({url:"/composers/",data:{q:t},success:function(e){0==e.count&&(d.children().remove(".top-message"),d.prepend("<div class='top-message'><span class='help-block'><hr>We don't have <strong>"+t+"</strong> in our database. Submitting a piece by an unknown composer will add the composer to the database. <br>Do you have additional information to add to this new composer?<br><br></span></div>"),d.slideDown("slow"))}})}),u.on("keydown",function(e){13!==e.keyCode&&d.slideUp("slow")}),e(":input").on("input",function(){e(window).on("beforeunload",function(t){return"goto-piece"!==t.target.activeElement.id&&"success-refresh"!==t.target.activeElement.id?"Leaving this page will clear your form.":void e(window).off("beforeunload")}),e(":input").off("input")}),e("input:not(#comment)").on("keydown",function(e){13===e.keyCode&&e.preventDefault()}),e("#piece-submit").click(function(){if(s(),r["delete"].length>0||r.add.length>0||r.modify.length>0){var t="";if(r["delete"].length>0){for(var o="<h4>Delete</h4><ul>",n=0;n<r["delete"].length;n++){var i=r["delete"][n];o+="A"===i.type?"<li>Delete file <em>"+i.name+"</em> attached to <strong>"+i.parent+"</strong>.</li>":"<li>Delete movement <strong>"+i.name+"</strong>.</li>"}o+="</ul>",t+=o}if(r.add.length>0){for(var a="<h4>Add</h4><ul>",n=0;n<r.add.length;n++){var i=r.add[n];a+="A"===i.type?"<li>Add file <em>"+i.name+"</em> attached to <strong>"+i.parent+"</strong>.</li>":"<li>Add movement <strong>"+i.name+"</strong> to <strong>"+l.title+"</strong></li>"}a+="</ul>",t+=a}if(r.modify.length>0){for(var c=!1,m="<h4>Moving</h4><ul>",n=0;n<r.modify.length;n++){var i=r.modify[n];"A"===i.type&&(c=!0,m+="<li>Moving file <em>"+i.name+"</em> from <strong>"+i.oldParent+"</strong> to <strong>"+i.newParentTitle+"</strong>.</li>")}m+="</ul>",c&&(t+=m)}""!==t?($base_modal_header.html("<h4 class='modal-title'>Confirm Database Changes</h4>"),$base_modal_body.html(t),$base_modal_footer.html(".modal-footer").html("<button type='button' class='btn btn-default' id='restart-button'>Restart</button><button class='btn btn-default' id='confirm-changes'>Looks good!</a>"),$base_modal.modal("show"),e("#restart-button").click(function(){location.reload()}),e("#confirm-changes").click(function(){e("#new-piece-form").submit()})):e("#new-piece-form").submit()}else e("#new-piece-form").submit()}),e("#new-piece-form").submit(function(t){t.preventDefault(),$base_modal_header.html("<h4 class='modal-title'>Creating Piece...</h4>"),$base_modal_body.html("<div class='progress'><div class='progress-bar progress-bar-striped active' role='progressbar' style='width: 100%'></div> </div>"),$base_modal_footer.html(""),$base_modal.modal("show");var o=new FormData(this);o.append("changes",JSON.stringify(r)),e.ajax({type:"post",url:window.location.href,data:o,processData:!1,contentType:!1,success:function(t){if(void 0===t.errors)$base_modal_header.html("<h4 class='modal-title'>Done!</h4>"),$base_modal_body.html("<p>Piece succesfuly updated!</p>"),$base_modal_footer.html(".modal-footer").html("<a href='"+window.location.href+"' class='btn btn-default' id='success-refresh'>Refresh Page</a><a href='"+t.url+"' class='btn btn-default' id='goto-piece'>Go to Piece</a>");else{var o="";for(var n in t.errors){if("religiosity"===n)e("input[name='religiosity']").parent().removeClass("btn-default").addClass("btn-danger");else if("vocalization"===n)e("input[name='vocalization']").parent().removeClass("btn-default").addClass("btn-danger");else{if("collections"===n)continue;e("#"+n).parent().addClass("has-error")}e("#"+n+"_error").html("<b style='color:red'>"+t.errors[n][0]+"</b>"),o=o+"<strong>"+(n.charAt(0).toUpperCase()+n.slice(1)).replace(/_/g," ")+"</strong>: "+t.errors[n][0]+"<br>"}$base_modal_header.html("<h4 class='modal-title'>Form Error<h4>"),$base_modal_body.html("<p>Your submission has the following errors: <br>"+o+"</p>"),$base_modal_footer.html("<button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>")}},error:function(){$base_modal_header.html("<h4 class='modal-title'>Server Error<h4>"),$base_modal_body.html("<p>An error occurred while updating this piece. Please try again, or, if the error persists, <a href='mailto:elvisdatabase@gmail.com?Subject=Upload%20Error'>contact us</a></p>"),$base_modal_footer.html("<button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>")}})});var h=e(".upload-input-field");h.focus(function(t){e(t.target.parentElement.children[0]).popover("toggle")}),h.focusout(function(t){e(t.target.parentElement.children[0]).popover("hide")}),e("input[type=number]").keypress(function(e){return 0!==e.which&&8!==e.which&&(this.value.length>3||e.which<48||e.which>57)?!1:void 0})});