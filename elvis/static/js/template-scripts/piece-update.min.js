$(document).ready(function(e){function t(){e.ajax({datatype:"json",url:window.location.href+"?format=json",success:function(e){c=e,a(),i(),n(),o()}})}function o(){e('[data-toggle="popover"]').popover();var t=e(".upload-input-field");t.focus(function(t){e(t.target.parentElement.children[0]).popover("show")}),t.focusout(function(t){e(t.target.parentElement.children[0]).popover("hide")}),e("#collection-input-group").mouseenter(function(t){e(t.target.parentElement.children[0]).popover("show")}),e("#collection-input-group").mouseleave(function(t){e(t.target.parentElement.children[0]).popover("hide")}),e("input[type=number]").keypress(function(e){return 0!==e.which&&8!==e.which&&(this.value.length>3||e.which<48||e.which>57)?!1:void 0});var o=e("#composer-create-new-menu"),i=e("#composer");o.hide(),i.on("focusout",function(t){var i=e("#composer").val();i.length>0&&e.ajax({url:"/composers/",data:{q:i},success:function(e){0==e.count&&(o.children().remove(".top-message"),o.prepend("<div class='top-message'><span class='help-block'><hr>We don't have <strong>"+i+"</strong> in our database. Submitting a piece by an unknown composer will add the composer to the database. <br>Do you have additional information to add to this new composer?<br><br></span></div>"),o.slideDown("slow"))}})}),i.on("keydown",function(e){13!==e.keyCode&&o.slideUp("slow")}),e(":input").on("input",function(){e(window).on("beforeunload",function(t){return"goto-piece"!==t.target.activeElement.id&&"success-refresh"!==t.target.activeElement.id?"Leaving this page will clear your form.":void e(window).off("beforeunload")}),e(":input").off("input")}),e("input:not(#comment)").on("keydown",function(e){13===e.keyCode&&e.preventDefault()})}function i(){e("#title").val(c.title),c.composer=c.composer.name,e("#composer").val(c.composer),e("#comment").val(c.comment),e("#composition_start_date").val(c.composition_start_date),e("#composition_end_date").val(c.composition_end_date),e("#number_of_voices").val(c.number_of_voices),c.languages=s(c.languages),c.collections=s(c.collections,!0),c.genres=s(c.genres),c.locations=s(c.locations),c.instruments_voices=s(c.instruments_voices),c.sources=s(c.sources),c.tags=s(c.tags),e("#collections").val(c.collections),e("#languages").val(c.languages),e("#genres").val(c.genres),e("#locations").val(c.locations),e("#instruments_voices").val(c.instruments_voices),e("#sources").val(c.sources),e("#tags").val(c.tags);for(var t=e("#religiosity"),o=0;3>o;o++)if(t.children()[o].children[0].value===c.religiosity){t.children()[o].className+=" active ",e(t.children()[o].children[0]).prop("checked","true");break}for(var i=e("#vocalization"),o=0;3>o;o++)if(i.children()[o].children[0].value===c.vocalization){i.children()[o].className+=" active ",e(i.children()[o].children[0]).prop("checked","true");break}}function n(){for(var t=e("#piece_file_table"),o=e("#movement_table"),i=1,n=0;n<c.attachments.length;n++){t.dynamicTable("addRow",!0);var a=t.find("#files_existing_files_"+i),r=t.find("#_existingfiles_source_"+i),l=t.find("#_existingfiles"+i);l.attr("name",c.attachments[n].id),l.css("background-color","#E8E8E8"),a.attr("href",c.attachments[n].attachment).text(c.attachments[n].file_name),r.val(c.attachments[n].source),c.attachments[n].parent="piece",i++}for(var n=0;n<c.movements.length;n++){o.dynamicTable("addRow",!0);var l=o.find("#_existingmov"+(n+1));l.attr("name",c.movements[n].item_id),l.css("background-color","#E8E8E8");for(var m=o.find("#_existingmov_title_"+(n+1)),u=o.find("#_existingmov"+(n+1)+"_instrumentation"),v=o.find("#_existingmov"+(n+1)+"_free_tags"),h=o.find("#_existingmov"+(n+1)+"_number_of_voices"),f=o.find("#_existingmov"+(n+1)+"_comment"),g=o.find("#_existingmov"+(n+1)+"_vocalization"),p=0;3>p;p++)if(g.children()[p].children[0].value===c.movements[n].vocalization){g.children()[p].className+=" active ",e(g.children()[p].children[0]).prop("checked","true");break}c.movements[n].instruments_voices=s(c.movements[n].instruments_voices),c.movements[n].tags=s(c.movements[n].tags),c.movements[n].position=n+1,m.val(c.movements[n].title),u.val(c.movements[n].instruments_voices),v.val(c.movements[n].tags),h.val(c.movements[n].number_of_voices),f.val(c.movements[n].comment);for(var p=0;p<c.movements[n].attachments.length;p++){t.dynamicTable("addRow",!0);var l=t.find("#_existingfiles"+i);l.css("background-color","#E8E8E8");var a=t.find("#files_existing_files_"+i),_=t.find("#_existingfiles_parent_"+i),r=t.find("#_existingfiles_source_"+i),l=t.find("#_existingfiles"+i);l.attr("name",c.movements[n].attachments[p].id),a.attr("href",c.movements[n].attachments[p].attachment).text(c.movements[n].attachments[p].file_name),r.val(c.movements[n].attachments[p].source),_.selectpicker("val","_existingmov_title_"+(n+1)),c.movements[n].attachments[p].parent="_existingmov_title_"+(n+1),i++}t.dynamicTable("drawAttachSelects")}e("[id^=del_mov], [id^=del_files]").click(function(t){var o,i,n,a,s=e(t.target).parents("[id^=_existing]")[0];o=-1!==s.id.indexOf("mov")?"M":"A","A"==o?(a=s.children[2].children[1].children[0].title,n=s.children[1].children[0].text,i=s.getAttribute("name"),d["delete"].push({type:o,id:i,name:n,parent:a})):(n=s.children[2].children[0].value,i=s.getAttribute("name"),d["delete"].push({type:o,id:i,name:n}))})}function a(){"true"!==sessionStorage.getItem("saw_instructions")&&($base_modal_header.html("<h4 class='modal-title'>Modifying an existing piece...<h4>"),$base_modal_body.html("<p>This form has been pre-filled with the current state of <em>"+c.title+"</em>.<ul><li>You may modify any of its properties.</li><li>Do not modify any fields that you do not wish to change.</li> <li>Existing movements and files are colored dark grey - you may modify or delete these as well.</li><li>You may also add new movements and files.</li></ul><strong>No changes are applied until you click the submit button </strong> at the bottom of the page. If you make a mistake, or need to restart the process, simply reload the page. </p>"),$base_modal_footer.html("<button type='button' class='btn btn-success' data-dismiss='modal'>Got it</button>"),$base_modal.modal("show"),sessionStorage.setItem("saw_instructions","true"))}function s(e,t){var o="";if(t)for(var i=0;i<e.length;i++)e[i]["public"]&&(o+=e[i].title+"; ");else for(var i=0;i<e.length;i++)o+=e[i].name+"; ";return o}function r(){d.modify=[],d.add=[];for(var t=e(".upload-input-field"),o=0;o<t.length;o++){var i=t[o].getAttribute("id");if("composition_start_date"===i)var n="composition_start_date";else n="composition_end_date"===i?"composition_end_date":i;if(e("#"+i).val()!=c[n]){if("comment"===i&&""===e("#"+i).val()&&null===c[n])continue;d.modify.push({type:"F",id:n,value:e("#"+i).val()})}}for(var a=e("#religiosity"),o=0;3>o;o++)if(-1!==a.children()[o].className.indexOf("active")){if(a.children()[o].children[0].value==c.religiosity)break;d.modify.push({type:"F",id:"religiosity",value:a.children()[o].children[0].value})}for(var s=e("#vocalization"),o=0;3>o;o++)if(-1!==s.children()[o].className.indexOf("active")){if(s.children()[o].children[0].value==c.vocalization)break;d.modify.push({type:"F",id:"vocalization",value:s.children()[o].children[0].value})}for(var r=m.children("[id^=_existingmov]"),o=0;o<r.length;o+=2){var l={},v=null,h=[],f=e(r[o]),g=e(r[o+1]),i=parseInt(f[0].getAttribute("name"));h.push(["title",f.find("[id^=_existingmov_title_]")[0].value]),h.push(["position",f.find("[id$=_position]")[0].value]),h.push(["instruments_voices",g.find("[id$=_instrumentation]")[0].value]),h.push(["tags",g.find("[id$=_free_tags]")[0].value]),h.push(["number_of_voices",g.find("[id$=_number_of_voices]")[0].value]),h.push(["comment",g.find("[id$=_comment]")[0].value]);var p=e(g.find("[id$=_vocalization]")[0]).children(".active")[0];p&&h.push(["vocalization",p.children[0].value]);for(var _=0;_<c.movements.length;_++)if(c.movements[_].item_id===i){v=c.movements[_];break}for(var b=0,y=1,_=0;_<h.length;_++)if(v[h[_][b]]!=h[_][y]){if("comment"===h[_][b]&&""===h[_][y]&&null===v[h[_][b]])continue;l[h[_][b]]=h[_][y]}e.isEmptyObject(l)||(l.id=i,l.type="M",l.oldTitle=v.title,d.modify.push(l))}for(var w=m.children("[id^=mov]"),o=0;o<w.length;o+=2){var f=e(w[o]),x=f.find("[id^=mov_title_]")[0].value,k=f.find("[id$=_position]")[0].value;""!==x&&d.add.push({type:"M",name:x,position:k})}for(var $=u.children("[id^=_existingfiles]"),o=0;o<$.length;o++){var l={},E=null,h=[],A=e($[o]),i=parseInt(A.attr("name"));h.push(["parent",A.find("[id^=_existingfiles_parent_]")[0].value]),h.push(["source",A.find("[id^=_existingfiles_source_]")[0].value]);for(var _=0;_<c.attachments.length;_++)if(c.attachments[_].id===i){E=c.attachments[_];var C="Attach to Piece";break}if(null===E)for(var _=0;_<c.movements.length;_++){for(var S=0;S<c.movements[_].attachments.length;S++)if(c.movements[_].attachments[S].id===i){E=c.movements[_].attachments[S];var C=c.movements[_].title;break}if(null!==E)break}for(var _=0;_<h.length;_++)if(E[h[_][b]]!==h[_][y]){if("source"===h[_][b]&&""===h[_][y]&&null===E[h[_][b]])continue;l[h[_][b]]=h[_][y]}e.isEmptyObject(l)||(l.id=i,l.type="A",l.name=A.children()[1].children[0].text,l.oldParent=C,l.oldSource=E.source,l.newParentTitle=A.children()[2].children[1].children[0].title,"piece"!==l.parent&&(l.newParent=A.children()[2].children[0].value),d.modify.push(l))}for(var T=u.children("[id^=files]"),o=0;o<T.length;o++){var A=e(T[o]),x=A.children()[1].children[1].children[1].value;if(""!==x){var z=A.children()[2].children[1].children[0].title;"Attach to Piece"===z&&(z="the piece"),d.add.push({type:"A",name:x,parent:z})}}}function l(t){for(var o="",i=e(":input"),n=0;n<i.length;n++){var a=i[n].getAttribute("aria-label");t.errors[i[n].name]&&"Religious Nature"!==a&&"Voice Type"!==a?(o+="<strong>"+a+"</strong> is required. <br>",e("#"+i[n].id).addClass("validation-error")):e("#"+i[n].id).removeClass("validation-error")}if(t.errors.religiosity?(o+="<strong>Religious Nature</strong> is required. <br>",e("#religiosity").children().addClass("validation-error")):e("#religiosity").children().removeClass("validation-error"),t.errors.vocalization?(o+="<strong>Voice Type</strong> is required. <br>",e("#vocalization").children().addClass("validation-error")):e("#vocalization").children().removeClass("validation-error"),t.errors.__all__)for(var n=0;n<t.errors.__all__.length;n+=2){var s=t.errors.__all__[n];if(-1!==s.indexOf("files")){var r=null,l=s.replace(/^\D+/g,"");if(r=-1===s.indexOf("existing")?e("[id$=files_"+l+"]").val():e("[id$=files_"+l+"]").text()){var c=r.split("\\"),d=c[c.length-1];o+="<strong>File</strong><em> "+d+"</em> requires a source.<br>",e("#"+s).css("border-color","red").addClass("validation-error")}}-1!==s.indexOf("mov")&&(o+="<strong>Movements</strong> requires a title!<br>",e("#"+s).css("border-color","red").addClass("validation-error"))}return e(".validation-error").on("focus",function(){"vocalization"===this.parentElement.id?e("#vocalization").children().css("border-color","#ccc").removeClass("validation-error"):"religiosity"===this.parentElement.id?e("#religiosity").children().css("border-color","#ccc").removeClass("validation-error"):e(this).css("border-color","#ccc").removeClass("validation-error")}),o}var c={},d={};d.modify=[],d["delete"]=[],d.add=[],autocomplete("title","title_suggestion_menu","pieceSuggest"),autocomplete("composer","composer_suggestion_menu","composerSuggest"),autocomplete("collections","collection_suggestion_menu","collectionSuggest","list"),autocomplete("languages","language_suggestion_menu","languageSuggest","list"),autocomplete("genres","genre_suggestion_menu","genreSuggest","list"),autocomplete("locations","location_suggestion_menu","locationSuggest","list"),autocomplete("sources","source_suggestion_menu","sourceSuggest","list"),autocomplete("instruments_voices","instrumentation_suggestion_menu","instrumentSuggest","list"),autocomplete("tags","tags_suggestion_menu","tagSuggest","list");var m=e("#movement_table");m.dynamicTable({button:e("#new_mov"),table_name:"mov",movement:!0});var u=e("#piece_file_table");u.dynamicTable({button:e("#new_piece_file"),table_name:"files"}),t(),e("#piece-submit").click(function(){if(r(),d["delete"].length>0||d.add.length>0||d.modify.length>0){var t="",o="",i="",n="";if(d["delete"].length>0){o="<h4>Delete</h4><ul>";for(var a=0;a<d["delete"].length;a++){var s=d["delete"][a];o+="A"===s.type?"<li>Delete file <em>"+s.name+"</em> attached to <strong>"+s.parent+"</strong>.</li>":"<li>Delete movement <strong>"+s.name+"</strong>.</li>"}o+="</ul>",t+=o}if(d.add.length>0){i="<h4>Add</h4><ul>";for(var a=0;a<d.add.length;a++){var s=d.add[a];i+="A"===s.type?"<li>Add file <em>"+s.name+"</em> attached to <strong>"+s.parent+"</strong>.</li>":"<li>Add movement <strong>"+s.name+"</strong> to <strong>"+c.title+"</strong></li>"}i+="</ul>",t+=i}if(d.modify.length>0){var l=!1;n="<h4>Moving</h4><ul>";for(var a=0;a<d.modify.length;a++){var s=d.modify[a];"A"===s.type&&s.oldParent!==s.newParentTitle&&(l=!0,n+="<li>Moving file <em>"+s.name+"</em> from <strong>"+s.oldParent+"</strong> to <strong>"+s.newParentTitle+"</strong>.</li>")}n+="</ul>",l&&(t+=n)}""!==t?($base_modal_header.html("<h4 class='modal-title'>Confirm Database Changes</h4>"),$base_modal_body.html(t),$base_modal_footer.html(".modal-footer").html("<div class='row'><div class='col-xs-2'><button type='button' class='btn btn-warning' id='restart-button'>Restart</button></div><div class='col-xs-10'><button type='button' class='btn btn-default btn' data-dismiss='modal'>Change something</button><button class='btn btn-success' id='confirm-changes'>Looks good!</a></div></div>"),$base_modal.modal("show"),e("#restart-button").click(function(){location.reload()}),e("#confirm-changes").click(function(){e("#new-piece-form").submit()})):e("#new-piece-form").submit()}else e("#new-piece-form").submit()}),e("#new-piece-form").submit(function(t){t.preventDefault(),$base_modal_header.html("<h4 class='modal-title'>Modifying Piece...</h4>"),$base_modal_body.html("<div class='progress'><div class='progress-bar progress-bar-striped active' role='progressbar' style='width: 100%'></div> </div>"),$base_modal_footer.html(""),$base_modal.modal("show");var o=new FormData(this);o.append("changes",JSON.stringify(d)),e.ajax({type:"post",url:window.location.href,data:o,processData:!1,contentType:!1,success:function(t){if(void 0===t.errors)$base_modal_header.html("<h4 class='modal-title'>Done!</h4>"),$base_modal_body.html("<p>Piece succesfuly updated!</p>"),$base_modal_footer.html(".modal-footer").html("<a href='"+window.location.href+"' class='btn btn-default' id='success-refresh'>Refresh Page</a><a href='"+t.url+"' class='btn btn-default' id='goto-piece'>Go to Piece</a>");else{var o=l(t);$base_modal_header.html("<h4 class='modal-title'>Form Error<h4>"),$base_modal_body.html("<p>Your submission has the following errors: <br>"+o+"</p>"),$base_modal_footer.html("<button id='close-and-goto-button' type='button' class='btn btn-default' data-dismiss='modal'>Close</button>"),e("#close-and-goto-button").click(function(){e("html, body").animate({scrollTop:e(".validation-error").offset().top},500)})}},error:function(e){$base_modal_header.html("<h4 class='modal-title'>Server Error<h4>"),$base_modal_body.html("<p>An error occurred while updating this piece. Please try again, or, if the error persists, <a href='mailto:elvisdatabase@gmail.com?Subject=Upload%20Error'>contact us</a></p>"),$base_modal_footer.html("<button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>")}})})});