!function(t){function e(e,n,a,o){function i(){if(o){var t=u.val().split(";");t[t.length-1]=l;for(var e=t[0]+"; ",n=1;n<t.length;n++)e=e+t[n].trim()+"; ";u.val(e)}else u.val(l)}var l,s=-1,r=-1,c=!0,d=!0,u=t("#"+e),_=t("#"+n),m=_.children().children();u.on("keydown",function(t){var e=t.keyCode;40===e&&(t.preventDefault(),m.eq(s).toggleClass("active"),s=(s+1)%r,m.eq(s).toggleClass("active"),l=m.eq(s).text()),38===e&&(t.preventDefault(),m.eq(s).toggleClass("active"),s-=1,0>s&&(s=r-1),m.eq(s).toggleClass("active"),l=m.eq(s).text()),13===e&&r>0&&(t.preventDefault(),i(),_.html(""),s=-1,r=0,u.focusout()),13===e&&(t.preventDefault(),u.focusout()),186===e&&(_.html(""),s=-1,r=0,l="")}),u.on("keyup focusin",function(e){var n=e.keyCode;if(n>63&&91>n||8===n||"focusin"===e.type){if(o)var i=u.val().split(";"),p=encodeURI(i[i.length-1].trim());else p=encodeURI(u.val());(8===n||p.length-u.val().length>1)&&(c=!0);var b=t(this).parent().width()-120;(d||c)&&l!==u.val()&&t.ajax({url:"/suggest/",data:{q:p,d:a},success:function(t){_.html(""),r=t.length,s=0,c&&0!==r&&(c=!1),d=r>0?!0:!1;for(var e="",n=0;n<t.length;n++)e+=n===s?"<li class='list-group-item active' id='suggestion-item"+n+"'>"+t[n].name+"</li>":"<li class='list-group-item' id='suggestion-item"+n+"'>"+t[n].name+"</li>";_.html("<ul class='listgroup' style='position: absolute; padding-left: 0px; z-index:10; cursor: pointer; width:"+b+"px'>"+e+"</ul>"),m=_.children().children(),l=m.eq(s).text()},dataType:"json"})}}),u.on("focusout",function(){_.html(""),c=!0}),_.on("mouseover",function(e){var n=t(e.target);if(n.hasClass("list-group-item")){m.eq(s).toggleClass("active",!1),n.toggleClass("active",!0);var a=n.attr("id");s=a[a.length-1],l=m.eq(s).text()}}),_.on("mousedown",function(t){t.target&&(i(),_.html(""),s=-1,r=0)})}t.fn.dynamicTable=function(e){return"object"!=typeof e&&e?n[e]?n[e].apply(this,Array.prototype.slice.call(arguments,1)):void t.error(e+" is not a valid dynamicTable option"):this.each(function(){var n=t(this);if(!n.data("dynamicTable")){var o=new a(this,e);n.data("dynamicTable",o)}})};var n={addRow:function(e){t(this).data("dynamicTable").addRow(e)},drawAttachSelects:function(){t(this).data("dynamicTable").drawAttachSelects()}},a=function(n,a){function o(n){if(n)var a="_existing";else var a="";if(c.movement)c.t_size=(c.$table.children().length+1)/2,c.$table.append("<tr id='"+a+c.table_name+c.row_count+"'><td class='text-center'><button id='del_"+c.table_name+c.row_count+"' type='button' tabindex='-1' class='btn btn-default'><span class='glyphicon glyphicon-remove'></span></button></td><td class='text-center' style='padding-top:14px'>"+c.t_size+"</td><td><input name='"+a+c.table_name+"_title_"+c.row_count+"' id='"+a+c.table_name+"_title_"+c.row_count+"' class='form-control' autocomplete='off'data-toggle='popover' data-placement='top' data-trigger='focus' data-html='true' title='<b>Movement Title</b>'data-content='If no title is provided, this movement will be ignored on upload. It is not necessary to number movements, as they will retain the ordering in which they are here presented.'> </td><td><button id='show_advanced_"+c.table_name+c.row_count+"' type='button' tabindex='-1'class='btn btn-default'>Show Advanced</button></td></tr><tr id='"+a+c.table_name+c.row_count+"_tags' hidden='hidden'> <td colspan='4'><div class='row' style='padding-left:12%; padding-right:15px'><div class='col-md-7'><div class='form-group'><div class='input-group'><span class='input-group-addon'>Instrumentation</span><input name='"+a+c.table_name+c.row_count+"_instrumentation' id='"+a+c.table_name+c.row_count+"_instrumentation' type='text' class='form-control unstyled'></div><div id='"+a+c.table_name+c.row_count+"_instrumentation_suggestions' style='padding-left:120px'></div></div></div><div class='col-md-5'><div class='btn-group btn-group-justified form-inline radio' style='margin-top: 0px' id='"+a+c.table_name+c.row_count+"_vocalization' data-toggle='buttons'><label class='btn btn-default'><input type='radio' name='"+a+c.table_name+c.row_count+"_vocalization' value='Vocal'>Vocal</label><label class='btn btn-default'><input type='radio' name='"+a+c.table_name+c.row_count+"_vocalization' value='Instrumental'>Instrumental</label><label class='btn btn-default'><input type='radio' name='"+a+c.table_name+c.row_count+"_vocalization' value='Mixed'>Mixed</label></div></div></div><div class='row' style='padding-left:12%; padding-right:15px'><div class='col-md-8'><div class='form-group'><div class='input-group'><span class='input-group-addon'>Tags</span><input name='"+a+c.table_name+c.row_count+"_free_tags' id='"+a+c.table_name+c.row_count+"_free_tags' type='text' class='form-control unstyled'></div><div id='"+a+c.table_name+c.row_count+"_free_tags_suggestions' style='padding-left:120px'></div></div></div><div class='col-md-4'><div class='form-group'><div class='input-group'><span class='input-group-addon'>Number of Voices</span><input name='"+a+c.table_name+c.row_count+"_number_of_voices' id='"+a+c.table_name+c.row_count+"_number_of_voices' type='number' class='form-control unstyled'></div></div></div></div><div class='row' style='padding-left:12%; padding-right:15px'><div class='col-md-12'><strong>Comments:</strong> <div class='form-group'><textarea rows='7' class='form-control' name='"+a+c.table_name+c.row_count+"_comment' id='"+a+c.table_name+c.row_count+"_comment' style='resize:vertical'></textarea></div></div></td></tr>"),e(a+c.table_name+c.row_count+"_free_tags",a+c.table_name+c.row_count+"_free_tags_suggestions","tagSuggest",!0),e(a+c.table_name+c.row_count+"_instrumentation",a+c.table_name+c.row_count+"_instrumentation_suggestions","instrumentSuggest",!0);else{c.t_size=c.$table.children().length;var o="<tr id='"+a+c.table_name+c.row_count+"'><td class='text-center'><button id='del_"+c.table_name+c.row_count+"' type='button' tabindex='-1' class='btn btn-default'><span class='glyphicon glyphicon-remove'></span></button></td>";o+=n?"<td><a name='"+c.table_name+a+"_files_"+c.row_count+"' id='"+c.table_name+a+"_files_"+c.row_count+"'></a></td>":"<td><input name='"+c.table_name+a+"_files_"+c.row_count+"' id='"+c.table_name+a+"_files_"+c.row_count+"' type='file' multiple='multiple'></td>",c.$table.append(o+"<td><select class='selectpicker show-tick' name='"+a+c.table_name+"_parent_"+c.row_count+"'id='"+a+c.table_name+"_parent_"+c.row_count+"'><option value='piece'>Attach to Piece</option></select></td><td><input name='"+a+c.table_name+"_source_"+c.row_count+"' id='"+a+c.table_name+"_source_"+c.row_count+"' class='form-control' autocomplete='off' data-toggle='popover' data-placement='top' data-trigger='focus' data-html='true' title='<b>File Source</b>'data-content='Indicate the source of the file here, such as <em>Choral Wiki</em> or <em>Transcribed by Uploader</em>. If no source is provided, this file will be ignored. This file will be renamed automatically, so does not require a title.'> </td></tr>"),t("#"+a+c.table_name+"_files_"+c.row_count).filestyle({buttonBefore:!0,iconName:"glyphicon-file",buttonText:c.file_button_name})}i(c.row_count,n),c.row_count++}function i(e,n){if(n)var a="_existing";else var a="";s(),t("#del_"+c.table_name+e).on("click",function(e){var n=parseInt(e.currentTarget.getAttribute("id").substring(c.table_name.length+4));t("#"+c.table_name+"_files"+n).filestyle("destroy"),c.$table.children().remove("#"+a+c.table_name+n+"_tags"),c.$table.children().remove("#"+a+c.table_name+n),"files"!==c.table_name&&l(),s()}),t("#"+a+c.table_name+"_title_"+e).on("keydown",function(t){return 13===t.keyCode?(t.preventDefault(),!1):void 0}),t("#"+a+c.table_name+"_title_"+e).focusout(function(){s()}),t("#show_advanced_"+c.table_name+c.row_count).click(function(e){t(e.target.parentElement.parentElement.nextElementSibling).toggle()}),t("input[type=number]").off().keypress(function(t){return 0!==t.which&&8!==t.which&&(this.value.length>3||t.which<48||t.which>57)?!1:void 0})}function l(){for(var t=1;t<c.$table.children().length;t++)if(t%2!==0){var e=c.$table.children()[t];e.children[1].innerHTML=(t+1)/2}}function s(){var e=t("[id^=mov_title], [id^=_existingmov_title] "),n="<option value='piece'>Attach to Piece</option>",a=[],o=t("[id^=files_parent_],[id^=_existingfiles_parent_]"),i=0,l=null;for(i=0;i<e.length;i++)""!==e[i].value&&(0==i&&(n+="<option data-divider='true'></option>"),n+="<option value='"+e[i].id+"'>"+e[i].value+"</option>",a.push(e[i].id));for(i=0;i<o.length;i++)l=o[i].value,o[i].innerHTML=n,""===l||-1===t.inArray(l,a)?t(o[i]).selectpicker("refresh").selectpicker("val","piece"):t(o[i]).selectpicker("refresh").selectpicker("val",l)}var r=t(n),c=t.extend({file_button_name:"Click to select",row_count:1,t_size:0,table_name:null,movement:!1,button:null,$table:r},a);c.button.on("click",function(){c.button.blur(),o()}),this.addRow=function(t){return o(t)},this.drawAttachSelects=function(){return s()}}}(jQuery);