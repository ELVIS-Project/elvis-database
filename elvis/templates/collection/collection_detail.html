{% extends "base.html" %}

{% block extra_hd %}
    {% load staticfiles %}
    <script type='text/javascript' src="{% static "js/jquery.tablesorter.js" %}"></script>

    <title>{{ content.title }}</title>
    <script>
        $(document).ready(function ($)
        {
            $("#piece-table").tablesorter({
                headers: {0: {sorter: false}},
                textExtraction: "complex",
                sortList: [[2,0]]
            });

            $("#mov-table").tablesorter({
                headers: {0: {sorter: false}},
                textExtraction: "complex",
                sortList: [[2,0]]
            });

            $("#private-button").click(function (event)
            {
                $.ajax({
                    type: "post",
                    url: "/collections/",
                    data: {action: 'make-private', id: {{ content.item_id }}},
                    success: function (data)
                    {
                        console.log("Made {{ content.title }} private.");
                        location.reload();
                    }
                })
            });

            $("#public-button").click(function (event)
            {
                $.ajax({
                    type: "post",
                    url: "/collections/",
                    data: {action: 'make-public', id: {{ content.item_id }}},
                    success: function (data)
                    {
                        console.log("Made {{ content.title }} public.");
                        location.reload();
                    }
                })
            });

            $("#delete-button").click(function (event)
            {
                $base_modal_header.html("<h4 class='modal-title'>Confirm Deletion.</h4>");
                $base_modal_body.html("<p>Are you sure you want to delete this Collection?</p>");
                $base_modal_footer.html('<button type="button" class="btn btn-default" data-dismiss="modal">No</button>' +
                        '<button id="confirm-delete-button" type="button" class="btn btn-danger" data-dismiss="modal">' +
                        '<span class="glyphicon glyphicon-remove"></span>Yes</button>');
                $base_modal.modal('show');
                $("#confirm-delete-button").click(function (event)
                {
                    $.ajax({
                        type: "post",
                        url: "/collections/",
                        data: {action: 'delete', id: {{ content.item_id }}},
                        success: function (data)
                        {
                            console.log("Deleted {{ content.title }}");
                            document.location.href = '/collections/?creator={{ user.username }}';
                        }
                    })
                })
            });
        });
    </script>
{% endblock %}

{% block wrap %}
    <div class="page-header">
        <h2>{{ content.title }}
            <small>{{ content.pieces | length }}
                Pieces, {{ content.movements | length }} Movements
            </small>
            <span class="pull-right">
                {% if user.id == content.creator.pk  or user.is_superuser %}
                    <button type="button" class="btn btn-default"
                            id="delete-button">Delete
                    </button>
                    {% if content.public %}
                        <button type="button" class="btn btn-default"
                                id="private-button">Make Private
                        </button>
                    {% else %}
                        <button type="button" class="btn btn-default"
                                id="public-button">Make Public
                        </button>
                    {% endif %}
                {% endif %}
                {% include "includes/download-button-inc.html" with download_type="elvis_collection" download_item_id=content.item_id title="Add to Downloads" in_cart=content.in_cart %}
            </span>
        </h2>


        <p>Created by {{ content.creator.full_name }}
                on {{ content.created | date:"d F Y, f a" }}<br> Last
                updated {{ content.updated | date:"d F Y, f a" }}</p>
    </div>
    {% if content.comment %}
        <pre>{{ content.comment }}</pre>
    {% endif %}




    {% if content.pieces %}
        <h3>Pieces ({{ content.pieces | length }})</h3>
        <table class="table" id="piece-table">
            <thead>
            <tr>
                <th width="5%">Add</th>
                <th width="30%">Title</th>
                <th width="20%">Composer</th>
                <th width="25%">Movements</th>
                <th width="10%">Date</th>
            </tr>
            </thead>
            <tbody>
            {% for piece in content.pieces %}
                <tr>
                    <td>{% include "includes/download-badge-inc.html" with download_type="elvis_piece" download_item_id=piece.item_id title="Add to Downloads" in_cart=piece.in_cart %}</td>
                    <td><a href="{{ piece.url }}">{{ piece.title }}</a></td>
                    <td><a href="{{ piece.composer.url }}">{{ piece.composer.name}}</a></td>
                    <td>{% if piece.movement_count %}<span class="label label-primary">{{ piece.movement_count }} movement{{  piece.movement_count | pluralize }} included</span></a>{% else %}<span class="label label-default">No movements</span>{% endif %}</td>
                    <td width="10%">{{ piece.date_of_composition2 }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endif %}

    {% if content.movements %}
        <h3>Movements ({{ content.movement_count }})</h3>
        <table class="table" id="mov-table">
            <colgroup>
                <col class="text-center" style="width: 5%;">
                <col hidden="hidden">
                <col style="width: 30%;">
                <col style="width: 20%;">
                <col style="width: 25%;">
                <col style="width: 10%;">
            </colgroup>
            <thead >
            <tr>
                <th>Add</th>
                <th>Title</th>
                <th>Composer</th>
                <th>Piece</th>
                <th>Date</th>
            </tr>
            </thead>
            <tbody>
            {% for mov in content.movements %}
                <tr>
                    <td>{% include "includes/download-badge-inc.html" with download_type="elvis_movement" download_item_id=mov.item_id title="Add to Downloads" in_cart=mov.in_cart %}</td>
                    <td><a href="{{ mov.url }}">{{ mov.title }}</a> </td>
                    <td><a href="{{ mov.composer.url }}">{{ mov.composer.name}}</a></td>
                    <td>{% if mov.piece %}<a href="{{ mov.piece.url }}"><span class="label label-success">{{ mov.piece.title }}</span></a>{% else %}<span class="label label-default">No piece</span>{% endif %}</td>
                    <td>{{ mov.date_of_composition2 }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endif %}

{% endblock %}