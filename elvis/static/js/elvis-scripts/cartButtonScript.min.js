function cartButtonRefresh(){var t=$("#collection-count");$(".cart-badge, .cart-button").off("click").tooltip().on("click",function(n){return n.preventDefault(),n.stopImmediatePropagation(),$button=$(this),$button.tooltip("hide"),$button.hasClass("disabled")?($button.blur(),!1):($button.addClass("disabled"),type=$button.hasClass("cart-badge")?"badge":"button",action=$button.hasClass("btn-success")?"add":"remove",void $.ajax({type:"post",url:"/download-cart/",data:$button.parents(".recursive-patch-download-form").serialize(),success:function(n){clearTimeout(cart_timeout),$base_modal.modal("hide"),t.fadeOut(100,function(){t.text("("+n.count+")")}),t.fadeIn(100),init_cart_buttons()},error:function(t){$base_modal_header.html("<h4 class='modal-title'>Error modifying downloads!</h4>"),$base_modal_body.html("<p>Something went wrong and your cart was not modified!</p>"),$base_modal_footer.html("<button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>"),$base_modal.modal("show")}}))})}function redirect_to_login(){$(".cart-badge, .cart-button").off("click").tooltip().on("click",function(t){window.location="/login/?error=download"})}function init_cart_buttons(){null===$forms&&($forms=$(".recursive-patch-download-form")),null===items&&(items=build_item_dict($forms)),$.ajax({url:"/download-cart/",data:{check_in_cart:JSON.stringify(light_items)},success:function(t){if(null!==t)for(var n=Object.keys(t),o=0;o<n.length;o++){var a=n[o],e=t[a].in_cart;e!==items[a].in_cart&&(items[a].in_cart=e,light_items[a].in_cart=e,"button"==items[a].button_type?draw_button(t[a],items[a].$elem):draw_badge(t[a],items[a].$elem))}cartButtonRefresh()},error:function(t){redirect_to_login()}})}function build_item_dict(t){items={};for(var n=0;n<t.size();n++){var o=t[n].children;items[o[2].value]={button_type:o[0].value,type:o[1].value,$elem:$(t[n]),in_cart:str_to_bool(o[3].value)},light_items[o[2].value]={type:o[1].value,in_cart:str_to_bool(o[3].value)}}return items}function str_to_bool(t){return"true"===t.toLowerCase()?!0:!1}function draw_button(t,n){var o=$(n);o.children(":button").remove(),t.in_cart===!0?(o.children("[name=action]").val("remove"),o.append('<button type="button" class="btn btn-danger cart-button">Remove from Downloads </button>')):t.in_cart===!1&&(o.children("[name=action]").val("add"),o.append('<button type="button" class="btn btn-success cart-button">Add to Downloads </button>'))}function draw_badge(t,n){var o=$(n);o.children(":button").remove();var a="",e="";"Piece"===t.in_cart?(a='<button type="button" class="btn btn-mini btn-info disabled cart-badge" data-container="body" data-toggle="tooltip" data-placement="top" title="In cart under piece."><span class="glyphicon glyphicon-lock"> </span> </button>',e="add"):t.in_cart===!0?(a='<button type="button" class="btn btn-mini btn-danger cart-badge" data-container="body" data-toggle="tooltip" data-placement="top" title="Remove from Downloads"><span class="glyphicon glyphicon-minus"> </span> </button>',e="remove"):t.in_cart===!1&&(a='<button type="button" class="btn btn-mini btn-success cart-badge" data-container="body" data-toggle="tooltip" data-placement="top" title="Add to Downloads"><span class="glyphicon glyphicon-plus"> </span> </button> ',e="add"),o.append(a),o.children("[name=action]").val(e)}var type=null,action=null,$button=null,cart_timeout=null,items=null,light_items={},$forms=null;