{% extends "base.html" %}

{% block wrap %}

<!-- The javascript function for the typeahead functionality on the fields. -->

<script>
$(document).ready(function($)
{
    // This code could be very easily duplicate to support autocomplete on another input,
    // but I need to set up a new suggester module to consider that...

    var menuActive = -1;
    var menuSize = 0;
    var $composerSearch =  $('#composer-search');
    var $composerSuggestionMenu = $('#composer-suggestion-menu');

    $composerSearch.on("keydown", function(event)
    {
        var key = event['keyCode'];

        if (key == 40 || key == 38)
        {
            event.preventDefault();
        }
    });

    $composerSearch.on("keyup", function(event)
    {
        var key = event['keyCode'];

        //This block triggers on a-z and del to populate the suggestion list.
        if ((key > 63 && key < 91) || key == 8)
        {
            var query = $("#composer-search").val();

            //Sends the query to /suggest/ and prints the results to the suggestion-menu
            $.ajax({
                url: "/suggest/",
                data: {q: query},
                success: function(data)
                {
                    $composerSuggestionMenu.html("");
                    menuSize = data.length;
                    menuActive = 0;

                    for (i = 0; i < data.length; i++)
                    {
                        if (i == menuActive)
                        {
                            $composerSuggestionMenu.append(
                            "<li class='list-group-item active' id='suggestion-item"+i+"'>"+ data[i].name + "</li>");
                        }
                        else
                        {
                            $composerSuggestionMenu.append("<li class='list-group-item' id='suggestion-item"+i+"'>"+ data[i].name + "</li>");
                        }
                    }
                },
                dataType: "json"
            });
        }

        // Arrow key down moves the active block down the menu
        if (key == 40)
        {
            $("#suggestion-item" + menuActive).toggleClass("active");
            menuActive = (menuActive + 1)% menuSize;
            $("#suggestion-item" + menuActive).toggleClass("active");
        }

        //Arrow key up moves the active block up the menu
        if (key == 38)
        {
            $("#suggestion-item" + menuActive).toggleClass("active");
            menuActive = (menuActive - 1);

            if (menuActive < 0)
                menuActive = menuSize-1;

            $("#suggestion-item" + menuActive).toggleClass("active");
            return;
        }

        //Enter key sends the active menu item to the input and deselects the input
        if (key == 13 && menuActive != -1)
        {
            $("#composer-search").val($("#suggestion-item"+menuActive).text());
            $('#composer-suggestion-menu').html("");
            menuActive = -1;
            menuSize=0;
        }

        //Tab clears the suggestions before doing its default activity (switching input fields)
        if (key == 9)
        {
            $('#composer-suggestion-menu').html("");
            menuActive = -1;
        }
    });

    //Mouseover on suggestion item activates it
    $("#composer-suggestion-menu").on("mouseover", function(event)
    {
        var mouseTarget = $(event['target']);
        if(mouseTarget.hasClass("list-group-item"))
        {
            $("[id^=suggestion-item]").toggleClass("active", false);
            $(event['target']).toggleClass("active", true);
            var mouseoverTargetid = $(event['target']).attr('id');
            menuActive = mouseoverTargetid[mouseoverTargetid.length-1];
        }
    });

    //Clicking suggestion item sends its value to the input field
    $("#composer-suggestion-menu").on("click", function(event)
    {
        if(event['target'])
        {
            $("#composer-search").val($("#suggestion-item"+menuActive).text())
            $('#composer-suggestion-menu').html("");
            menuActive = -1;
            menuSize=0;
        }
    })
})
</script>

<h2>Upload a Piece</h2>
<div class="input-group">
  <span class="input-group-addon" id="basic-addon1">Composer</span>
  <input type="text" id=composer-search class="form-control" placeholder="Username" aria-describedby="basic-addon1">
</div>
<ul class="list-group" style="position: absolute; z-index: 10">
    <div id="composer-suggestion-menu"></div>
</ul>

<br>
<div class="input-group">
  <span class="input-group-addon" id="basic-addon1">Title</span>
  <input type="text" class="form-control" placeholder="Username" aria-describedby="basic-addon1">
</div>

<!--
<input type="text" id="composer_search" class="form-control" placeholder="Composer" aria-describedby="basic-addon1">
-->

<!--
<form action="/pieces/" method="post">
    {% csrf_token %}
    <input type="hidden" name="csrfmiddlewaretoken" value="fxEDKF7Zr49WliezO22MYHdH85iYnvDA">
    <li><label for="id_title">Title:</label> <input id="id_title" name="title" type="text"></li>
    <li><div id="composer-list">
    <label for="id_composer">Composer:</label> <input class="typeahead" id="id_composer" name="composer" type="text">
    </div></li>
    <li><label for="id_collection">Collection:</label> <input id="id_collection" name="collection" type="text"></li>
    <li><label for="id_comp_start">Comp start:</label> <input id="id_comp_start" name="comp_start" type="text"></li>
    <li><label for="id_comp_end">Comp end:</label> <input id="id_comp_end" name="comp_end" type="text"></li>
    <li><label for="id_number_of_voices">Number of voices:</label> <input id="id_number_of_voices" name="number_of_voices" type="number"></li>
    <li><label for="id_genre">Genre:</label> <input id="id_genre" name="genre" type="text"></li>
    <li><label for="id_voices">Voices:</label> <input id="id_voices" name="voices" type="text"></li>
    <li><label for="id_composer_country">Composer country:</label> <input id="id_composer_country" name="composer_country" type="text"></li>
    <li><label for="id_language">Language:</label> <input id="id_language" name="language" type="text"></li>
    <li><label for="id_source">Source:</label> <input id="id_source" name="source" type="text"></li>
    <li><label for="id_tags">Tags:</label> <input id="id_tags" name="tags" type="text"></li>
    <li><label for="id_comment">Comment:</label> <input id="id_comment" name="comment" type="text"></li>
    <li><label for="id_attachment">Attachment:</label> <input id="id_attachment" name="attachment" type="file"></li>
    <li><label for="id_movements">Movements:</label> <input id="id_movements" name="movements" type="text"></li>
    <input type="submit" value="Submit" />
    </form>
</form>
-->
{%  endblock %}

