
<!-- LM: VERY PRELIMINARY search ui --> 

<!-- TODO reorganise data presentation --> 
<!-- TODO faceted/filtered search -->
{% if content.results %}

<style type="text/css">

.panel-body.facets {
   overflow-y: scroll;
   max-height: 160px;
}

</style>
<script type='text/javascript' src='{{STATIC_URL}}js/jquery.scrollTo.min.js'></script>
<script type="text/javascript"> 
    // this code manages the facet collapse
    $(function()
    {
        var hidden = false;
        $('#collapse-init').click(
            // Importing the bootstrap js required for collapsing disables the panels; see below for non-bootstrap specific js
            function()
            {
                if (hidden) 
                {
                    hidden = false;
                    $('.panel-collapse.facets').collapse('show');
                    //$('.panel-title').attr('data-toggle', '');
                    //$('.panel-collapse').attr('class', 'panel-collapse collapse in');
                    $(this).text('Hide Facets');
                } 
                else 
                {
                    hidden = true;
                    $('.panel-collapse.facets').collapse('hide');
                    //$('.panel-title').attr('data-toggle', 'collapse'); // use 'collapse' for user collapseable panels
                    //$('.panel-collapse').attr('class', 'panel-collapse collapse');
                    $(this).text('Show Facets');
                }
            }
        );
    });

    // this code manages what happens when a facet link is clicked.
   $(function()
    {
        var facetLabels = $(".facet-label");
        var lastSearch = "";
        /*document.getElementById("facet-search").onkeyup = (function(event)
        {
            if(event.keyCode == 13)
            {
                var searchFacet = document.getElementById("facet-search").value.toLowerCase();
                for(var i=0; i<facetLabels.length; i++)
                {
                    if(searchFacet != "" && facetLabels[i].innerHTML.toLowerCase().indexOf(searchFacet) > -1)
                    {
                        facetLabels[i].style.fontWeight = "bold";
                        facetLabels[i].style.background = "#E0E0E0";
                        find(searchFacet);
                    }
                    else
                    {
                        facetLabels[i].style.fontWeight = "";
                        facetLabels[i].style.background = "";
                    }
                }
                document.getElementById("facet-search").focus();
            }       
        }); */

        $('#facet-search').keyup(function()
        {
            var searchFacet = $(this).val().toLowerCase();
            for(var i=0; i<facetLabels.length; i++)
            {
                if(searchFacet.length > 2 && facetLabels[i].innerHTML.toLowerCase().indexOf(searchFacet) > -1)
                {
                    facetLabels[i].style.fontWeight = "bold";
                    facetLabels[i].style.background = "#E0E0E0";
                    if(searchFacet != lastSearch)
                    {
                        //find(searchFacet);
                        //document.getElementById("facet-search").focus();
                        //alert(facetLabels[i].parentNode.parentNode.parentNode.id);
                        //alert(facetLabels[i].parentNode.id);
                        //facetLabels[i].parentNode.parentNode.parentNode.scrollTop = facetLabels[i].parentNode.offsetTop;
                        //facetLabels[i].scrollIntoView(false);
                        //facetLabels[i].parentNode.parentNode.parentNode.scrollTo(facetLabels[i]);
                        //$(facetLabels[i].parentNode.parentNode.parentNode).scrollTop($(facetLabels[i].parentNode.parentNode.parentNode).scrollTop()+$(facetLabels[i]).position().top);
                        $(facetLabels[i].parentNode.parentNode.parentNode).stop().scrollTo($(facetLabels[i]), 200);
                    }
                }
                else
                {
                    facetLabels[i].style.fontWeight = "";
                    facetLabels[i].style.background = "";
                }
            }
            lastSearch = searchFacet;
        }).keyup(); 


        var qstr = window.location.search.replace("?", "");
        var qstr_params = $.parseParams(qstr);

        $.each(qstr_params, function(param, val) 
        {   
            if (typeof val == "object") 
            {
                $.each(val, function(num, v) 
                {
                    $("input[data-facet-name='" + param + "'][data-facet-value='" + v + "']").attr('checked', true);
                });
            } 
            else 
            {
                $("input[data-facet-name='" + param + "'][data-facet-value='" + val + "']").attr('checked', true);
            }
        });

        $(".facet-link").on('click', function(event)
        {
            var facetName = $(this).data('facet-name');          
            var facetValue = $(this).data('facet-value');

            if ($(this).is(':checked')) 
            {
                qstr_add = "&" + facetName + "=" + facetValue;
                window.location.search = qstr + qstr_add;
            } 
            else 
            {
                qstr_remove = qstr.replace('&' + facetName + "=" + encodeURI(facetValue), "");
                window.location.search = qstr_remove;
            }
            event.preventDefault();
        });
    })

</script>
{% load filter_methods %}

<!-- Get search query to resend without pagination... for downloading everything  Items {{ content.results.start_index |add:"1" }} to {{ content.results.end_index |add:"1" }} of {{ content.results.paginator.count }} Results-->
<div class="row">
    <div class="col-md-9">
        <h3> Results: </h3>
       
        {% if user.is_authenticated %}
        <form id="all-patch-download-form" action="/rpatchdownloads/" method="post">
            {% csrf_token %}
            <input type="hidden" class="this_url" name="this_url"  value="" /> 
            <input type="hidden" class="search_query" name="search_query" id="search_query" value="" />


            <script type="text/javascript">
              document.getElementById("search_query").value = window.location.href;
            </script>

            <button type="submit" id="all_download" onClick="return confirm('Are you sure you want to recursively add all results to your downloads?\nWarning: use with caution -- this may add undesired items!')" class="btn btn-success btn-sm pull-right" >
              Add All Results in Current Query to Downloads <span class="glyphicon glyphicon-plus"></span> 
            </button> 
        </form>


        

        <form id="list-patch-download-form" action="/rpatchdownloads/" method="post"  >
          {% csrf_token %}
          
            <button type="submit" id="list_download"  class="btn btn-success btn-sm pull-middle" >
              Add Results on Current Page to Downloads <span class="glyphicon glyphicon-plus"></span> 
            </button> 


            {% for result in content.results %}
              {% if result.type == "elvis_composer" or result.type == "elvis_piece" or result.type == "elvis_movement" or result.type == "elvis_corpus" or result.type == "elvis_tag" %}
              <input type="hidden" name="item_id" value="{{ result.item_id }}" />
              <input type="hidden" name="item_type" value="{{ result.type }}" />
              {% endif %}
            {% endfor %} 

            <input type="hidden" class="this_url" name="this_url"  value="" />
        </form> 
        {% endif %}
      
      <p></p>


        <div class="list-group" >
        {% for result in content.results %}
            {% if result.type == "elvis_composer" %}
                <a href="/composer/{{ result.item_id }}" class="list-group-item">
                    <span class="label label-primary pull-right">Composer</span>
                    <h4>{% include "includes/download-badge-inc.html" with download_type="elvis_composer" download_item_id=result.item_id %}{{ result.composer_name }}</h4>
                    <p class="list-group-item-text">{{ result.birth_date | date:"Y" }}&ndash;{{ result.death_date | date:"Y" }}</p>
                </a>
            {% elif result.type == "elvis_corpus" %}
                <a href="/corpus/{{ result.item_id }}" class="list-group-item">
                    <span class="label label-primary pull-right">Corpus</span> 
                    <h4>{% include "includes/download-badge-inc.html" with download_type="elvis_corpus" download_item_id=result.item_id %}{{ result.title }}</h4>
                    <p class="list-group-item-text"> Created by {{result.creator_name}} on {{result.created}} </p>
                    <p class="list-group-item-text"> {{result.comment}} </p>
                </a>
            {% elif result.type == "elvis_movement" %}
                <a href="/movement/{{ result.item_id }}" class="list-group-item">
                    <span class="label label-primary pull-right">Movement</span>
                    <h4> {% include "includes/download-badge-inc.html" with download_type="elvis_movement" download_item_id=result.item_id %} {{ result.title }}</h4>
                    <p class="list-group-item-text"> Piece: {{result.parent_piece_name}} </p>
                    <p class="list-group-item-text"> Composer: {{result.composer_name}} <br> Composed On: {{ result.date_of_composition | date:"Y" }} </p>
                    <p class="list-group-item-text"> Number of Voices: {{result.number_of_voices}} </p>
                    <p class="list-group-item-text"> Tags: {% for tag in result.tags %} {{tag}} {% endfor %}</p>
                    <p class="list-group-item-text"> {{result.comment}} </p>
                </a>
            {% elif result.type == "elvis_piece" %}
                <a href="/piece/{{ result.item_id }}" class="list-group-item">
                    <span class="label label-primary pull-right">Piece</span>
                    <h4> {% include "includes/download-badge-inc.html" with download_type="elvis_piece" download_item_id=result.item_id %} {{ result.title }}</h4>
                    <p class="list-group-item-text"> Composer: {{result.composer_name}} <br> Composed On: {{ result.date_of_composition | date:"Y" }} </p>
                    <p class="list-group-item-text"> Number of Voices: {{result.number_of_voices}} </p>
                    <p class="list-group-item-text"> Tags: {% for tag in result.tags %} {{tag}} {% endfor %}</p>
                    <p class="list-group-item-text"> {{result.comment}} </p>
                </a>
            {% elif result.type == "elvis_comment" %}
                <a href="/comment/{{ result.item_id }}" class="list-group-item">
                    <span class="label label-primary pull-right">Comment</span>
                    <h4>{{ result.name }}</h4>
                    <p class="list-group-item-text"> Created by {{result.creator_name}} on {{result.created}} </p>
                    <p class="list-group-item-text"> {{result.comment_text}} </p>
                </a>
            {% elif result.type == "elvis_tag" %}
                <a href="/tag/{{ result.item_id }}" class="list-group-item">
                    <span class="label label-primary pull-right">Tag</span>
                    <h4> {% include "includes/download-badge-inc.html" with download_type="elvis_tag" download_item_id=result.item_id %} {{ result.name }}</h4>
                    <p class="list-group-item-text"> {{result.description}}</p>
                </a>
            {% endif %}
        {% endfor %}
        </div>

        <div class="pager">
            <span class="step-links">
                {% if content.results.has_previous %}
                    <a href="?{{ content.current_query }}&page={{ content.results.previous_page_number }}">&larr; Previous Page</a>
                {% endif %}

                <span class="current">
                  | Results {{ content.results.start_index |add:"1" }} to {{ content.results.end_index |add:"1" }} of {{ content.results.paginator.count }} | Page {{ content.results.number }} of {{ content.results.paginator.num_pages }} |.
                </span>

                {% if content.results.has_next %}
                    <a href="?{{ content.current_query }}&page={{ content.results.next_page_number }}">Next Page &rarr;</a>
                {% endif %}
            </span>
        </div>

    </div>

    <div class="col-md-3">

        <div class="row">
            <h3>Narrow Your Search:</h3> 
            <button id="collapse-init" class="btn btn-primary btn-sm">
                Hide Facets
            </button>
            <input type="text" class="facet-search pull-right" id="facet-search" style="text-align:center" placeholder="Look for a Facet">
            <p></p>
        </div>


        <div class="row panel-group" id="accordion-facets">  
            {% for name, facets in content.facets.facet_fields.items %}
            {% if facets %}
            <div class="panel panel-default">
                    <div class="panel-heading facets" style="height:50%;">
                        <h1 class="panel-title" data-toggle="collapse" data-target="#collapse-{{name}}" style="font-size:100%;"> 
                            {{ content.FACET_NAMES|get_value:name }}  
                        </h1>
                    </div>

                    <div id="collapse-{{name}}" class="panel-collapse collapse facets in">
                        <div class="panel-body facets" id="facet-panel-{{name}}">
                                {% for facet, count in facets %}
                                    <li style="list-style: none;">
                                        <div id="facet-container-{{facet}}" style="white-space:nowrap;">
                                            <input type="checkbox" class="facet-link" data-facet-name="{{ name }}" data-facet-value="{{ facet }}">
                                            <label class="facet-label"> {% if name == 'type' %} {{ content.TYPE_NAMES|get_value:facet }} {% else %} {{ facet }} {% endif %}  ({{ count }})
                                            </label>
                                        </div>
                                    </li>
                                {% endfor %}
                        </div>
                    </div>
            </div>
            {% endif %}
            {% endfor %}

        </div>

    </div>

</div>

    
    

{% else %}
    <h5>No Results found.</h5>
{% endif %}
