$(document).ready(function(e){function t(t){t="undefined"!=typeof t?t:"result-page";var a=window.location.search.replace("?",""),s=e.parseParams(a),l=Object.keys(s);if(a){for(var o=0;o<l.length;o++)"typefilt[]"!==l[o]?"filefilt[]"!==l[o]?"vocalizationfilt"!==l[o]?"religiosityfilt"!==l[o]?"sortby"!==l[o]?e("[name="+l[o]+"]").val(s[l[o]]):e("#sortby").selectpicker("val",s[l[o]]):e("#religiosityfilt").selectpicker("val",s[l[o]]):e("#vocalizationfilt").selectpicker("val",s[l[o]]):e("#filefilt").selectpicker("val",s[l[o]]):e("#typefilt").selectpicker("val",s[l[o]]);i(s,!1,t)}else e("#result-page").fadeOut(300)}function a(e,t){var a="?",i=Object.keys(e);for(var s in i)if("string"!=typeof e[i[s]]&&"page"!==i[s])for(var l=0;l<e[i[s]].length;l++)a+=i[s]+"="+e[i[s]][l]+"&";else a+=i[s]+"="+e[i[s]]+"&";a=a.slice(0,-1),window.history.pushState(t,"Search","/search/"+a)}function i(t,i,l){i="undefined"!=typeof i?i:!0,l="undefined"!=typeof l?l:"result-page",e.ajax({type:"get",url:"search",data:t,success:function(o){i&&a(t,o),e("#"+l).fadeOut(300,function(){s(o)}).fadeIn(300,function(){cartButtonRefresh()})}})}function s(t){var a=e("#search-results-list");if(a.html(""),e("#page-links").html(""),e("#accordion-facets").html(""),void 0===t.object_list||0===t.object_list.length)return e("#result-heading").hide(),e("#no-result-heading").show(),!1;e("#no-result-heading").hide(),e("#result-count").text(t.paginator.count),e("#result-heading").show();for(var i=0;i<t.object_list.length;i++){var s=t.object_list[i];if("elvis_composer"!==s.type)if("elvis_collection"!==s.type)if("elvis_movement"!==s.type)if("elvis_piece"!==s.type);else{if(s.composition_end_date)var c=s.composition_end_date.slice(0,4);else var c="Unknown";var r="<div class='row search-result-row row-eq-height'><div class='col-xs-1 search-result-add' id='result-list-add"+i+"'><div id='add"+i+"'></div></div><a href='/piece/"+s.item_id+"' id='result-list-item"+i+"' class='search-result-item col-xs-11'><span class='label label-success right-label'>Piece</span><h4> "+s.title+"</h4><p class='list-group-item-text'> Composer: "+s.composer_name+"</p><p class='list-group-item-text'> Date: "+c+"</p>";void 0!==s.tags&&(r+="<p class='list-group-item-text'> Tags: "+s.tags+"</p>"),r+="</a></div>",a.append(r),create_download_form("elvis_piece",s.item_id,"add"+i)}else{if(s.composition_end_date)var c=s.composition_end_date.slice(0,4);else var c="Unknown";var r="<div class='row search-result-row row-eq-height'><div class='col-xs-1 search-result-add' id='result-list-add"+i+"'><div id='add"+i+"'></div></div><a href='/movement/"+s.item_id+"' id='result-list-item"+i+"' class='search-result-item col-xs-11'><span class='label label-primary right-label'>Movement</span><h4>"+s.title+"</h4>";void 0!==s.parent_piece_name&&(r+="<p class='list-group-item-text'> Piece: "+s.parent_piece_name+"</p>"),r+="<p class='list-group-item-text'> Composer: "+s.composer_name+"</p><p class='list-group-item-text'> Date: "+c+"</p>",void 0!==s.tags&&(r+="<p class='list-group-item-text'> Tags: "+s.tags+"</p>"),r+="</a></div>",a.append(r),create_download_form("elvis_movement",s.item_id,"add"+i)}else a.append("<div class='row search-result-row row-eq-height'><div class='col-xs-1 search-result-add' id='result-list-add"+i+"'><div id='add"+i+"'></div></div><a href='/collection/"+s.item_id+"' id='result-list-item"+i+"' class='search-result-item col-xs-11'><span class='label label-info right-label' style='margin-top:10px'>Collection</span><h4>"+s.title+"</h4><p class='list-group-item-text'>Created By: "+s.creator_name+" on "+s.created.substring(0,10)+"</p></a></div>"),create_download_form("elvis_collection",s.item_id,"add"+i);else{if(s.birth_date)var d=s.birth_date.slice(0,4);else d="Unknown";if(s.death_date)var p=s.death_date.slice(0,4);else p="Unknown";a.append("<div class='row search-result-row row-eq-height'><div class='col-xs-1 search-result-add' id='result-list-add"+i+"'><div id='add"+i+"'></div></div><a href='/composer/"+s.item_id+"' id='result-list-item"+i+"' class='search-result-item col-xs-11'><span class='label label-default right-label'>Composer</span><h4>"+s.name+"</h4><p class='list-group-item-text'>"+d+"-"+p+"</p></a></div>"),create_download_form("elvis_composer",s.item_id,"add"+i)}}l(t),o(t),n()}function l(t){var a=e("#page-links"),s="<ul class='pagination'>";return void 0===t.object_list?(a.html(""),!1):(1===t.number?(s+="<li class='disabled'><a href='first' onClick='return false;' id='first-button'>First</a></li>",s+="<li class='disabled'><a href='previous' onClick='return false;' id='previous-button'>Previous</a></li>"):(s+="<li><a href='first' onClick='return false;' id='first-button'>First</a></li>",s+="<li><a href='previous' onClick='return false;' id='previous-button'>Previous</a></li>"),s+="<li class='disabled'><a href='#' onClick='return false;'>Page "+t.number+" of "+t.paginator.total_pages+"</a></li>",t.number===t.paginator.total_pages?(s+="<li class='disabled'><a href='next' onClick='return false;' id='next-button'>Next</a></li>",s+="<li class='disabled'><a href='last' onClick='return false;' id='  last-button'> Last </a></li>"):(s+="<li><a href='next' onClick='return false;' id='next-button'>Next</a></li>",s+="<li><a href='last' onClick='return false;' id='last-button'> Last </a></li>"),s+="</ul>",a.html(s),e("#first-button").click(function(t){if(!e(this.parentElement).hasClass("disabled")){var a=e.parseParams(window.location.search.replace("?",""));delete a.page,i(a,!0)}}),e("#previous-button").click(function(a){if(!e(this.parentElement).hasClass("disabled")){var s=e.parseParams(window.location.search.replace("?",""));s.page=t.number-1,i(s,!0)}}),e("#next-button").click(function(a){if(!e(this.parentElement).hasClass("disabled")){var s=e.parseParams(window.location.search.replace("?",""));s.page=t.number+1,i(s,!0)}}),void e("#last-button").click(function(a){if(!e(this.parentElement).hasClass("disabled")){var s=e.parseParams(window.location.search.replace("?",""));s.page=t.paginator.total_pages,i(s,!0)}}))}function o(a){var i=e("#accordion-facets"),s=Object.keys(a.facet_names),l=a.facets.facet_fields,o="";for(var n in s)if(0!==Object.keys(l[s[n]]).length){var r=s[n],d="<div class='panel panel-default'><div class='panel-heading facets'><h3 class='panel-title facets' data-toggle='collapse' data-target='#collapse-"+r+"'>"+a.facet_names[s[n]]+"</h3></div>",p="<div id='collapse-"+r+"' class='panel-collapse collapse facets in'><div class='panel-body facets' id='facet-panel-"+r+"'>",u=l[s[n]];for(var f in u){var h=l[s[n]];if("type"===s[n])var v=f.slice(6)[0].toUpperCase()+f.slice(7);else var v=f;p+="<div class='facet-list'><div id='facet-"+s[n]+"-"+c(f)+"' class='facet-wrapper'><label class='facet-label' for='facet-link-"+c(f)+"-"+s[n]+"'><input type='checkbox' class='facet-link' style='margin: 4px 4px 0' data-facet-name='"+s[n]+"' data-facet-value='"+c(f)+"' id='facet-link-"+c(f)+"-"+s[n]+"'>"+v+"  ("+h[f]+")</label></div></div>"}p+="</div></div></div>",o+=d+p}i.html(o);for(var m=window.location.search.replace("?",""),g=e.parseParams(m),s=Object.keys(g),f=0;f<s.length;f++)"object"==typeof g[s[f]]?e.each(g[s[f]],function(t){e("input[data-facet-name='"+s[f]+"'][id='facet-link-"+c(g[s[f]][t])+"-"+s[f]+"']").attr("checked",!0)}):e("input[data-facet-name='"+s[f]+"'][id='facet-link-"+c(g[s[f]])+"-"+s[f]+"']").attr("checked",!0);e(".facet-link").on("click",function(i){var s=e(this).data("facet-name"),l=e(this).data("facet-value");e(this).is(":checked")?(m=window.location.search.replace("?",""),m+="&"+s+"="+l,window.history.pushState(a,"Search","/search/?"+m),t("search-results-list")):(m=window.location.search.replace("?",""),m=m.replace("&"+s+"="+l,""),window.history.pushState(a,"Search","/search/?"+m),t("search-results-list"))})}function n(){for(var t=e(".recursive-patch-download-form"),a=[],i=0;i<t.size();i++)a.push({type:t[i][0].value,id:t[i][1].value,num:i});e.ajax({url:"/downloads/",data:{check_in_cart:JSON.stringify(a)},success:function(a){console.log(a);for(var i=0;i<t.size();i++)"Piece"!==a[i].in_cart?a[i].in_cart!==!0?a[i].in_cart===!1&&e(t[i]).prepend('<button type="button" class="btn btn-mini btn-success cart-badge" data-container="body" data-toggle="tooltip" data-placement="top" title="Add to Downloads"><span class="glyphicon glyphicon-plus"> </span> </button> '):(e(t[i].children[2]).val("remove"),e(t[i]).prepend('<button type="button" class="btn btn-mini btn-danger cart-badge" data-container="body" data-toggle="tooltip" data-placement="top" title="Remove from Downloads"><span class="glyphicon glyphicon-minus"> </span> </button>')):e(t[i]).prepend('<button type="button" class="btn btn-mini btn-info disabled" data-container="body" data-toggle="tooltip" data-placement="top" title="Movement in Downloads under parent Piece. Remove Piece to modify."><span class="glyphicon glyphicon-lock"> </span> </button>')}})}function c(e){var t=encodeURI(e);return t=t.replace("'","%27")}e(".input-group-addon").tooltip(),e(".selectpicker").selectpicker(),autocomplete("namefilt","namefilt-suggestions","composerSuggest","bool"),autocomplete("tagfilt","tagfilt-suggestions","tagSuggest","bool"),autocomplete("genrefilt","genrefilt-suggestions","genreSuggest","bool"),autocomplete("instrumentfilt","instrumentfilt-suggestions","instrumentSuggest","bool"),autocomplete("sourcesfilt","sourcesfilt-suggestions","sourceSuggest","bool"),autocomplete("locationsfilt","locationsfilt-suggestions","locationSuggest","bool"),t(),e(window).bind("popstate",function(){t()}),e("#asearch-submit").click(function(){e(this).blur(),e("#advanced-search-form").submit()}),e(".asearch-input").on("keydown",function(t){13===t.keyCode&&e("#advanced-search-form").submit()}),e("#advanced-search-form").submit(function(t){t.preventDefault();var a=e.parseParams(e(this).serialize());a.typefilt=e("#typefilt").val(),a.filefilt=e("#filefilt").val(),a.sortby=e("#sortby").val(),a.vocalizationfilt=e("#vocalizationfilt").val(),a.religiosityfilt=e("#religiosityfilt").val();for(var s in a)(""===a[s]||null===a[s])&&delete a[s];i(a)}),e("#gsearch-submit").click(function(){e(this).blur(),e("#general-search-form").submit()}),e("#general-search-form").submit(function(t){t.preventDefault();var a=e("#gsearch-input").val();i({q:a})}),e("#all-download").click(function(){document.getElementById("search_query").value=window.location.href,e.ajax({type:"post",url:"/downloads/",data:e("#all-patch-download-form").serialize(),success:function(t){var a=e("#collection-count");a.fadeOut(100,function(){a.text("("+t.count+")")}),a.fadeIn(100)}})}),e("#datefiltt, #datefiltf ").keypress(function(e){return 0!==e.which&&8!==e.which&&(this.value.length>3||e.which<48||e.which>57)?!1:void 0})});