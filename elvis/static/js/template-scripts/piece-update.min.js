$(document).ready(function(e){function t(){e.ajax({datatype:"json",url:window.location.href+"?format=json",success:function(e){l=e,n(),i(),o()}})}function i(){e("#title").val(l.title),l.composer=l.composer.name,e("#composer").val(l.composer),e("#comment").val(l.comment),e("#composition_start_date").val(l.composition_start_date),e("#composition_end_date").val(l.composition_end_date),e("#number_of_voices").val(l.number_of_voices),l.languages=a(l.languages),l.collections=a(l.collections,!0),l.genres=a(l.genres),l.locations=a(l.locations),l.instruments_voices=a(l.instruments_voices),l.sources=a(l.sources),l.tags=a(l.tags),e("#collections").val(l.collections),e("#languages").val(l.languages),e("#genres").val(l.genres),e("#locations").val(l.locations),e("#instruments_voices").val(l.instruments_voices),e("#sources").val(l.sources),e("#tags").val(l.tags);for(var t=e("#religiosity"),i=0;3>i;i++)if(t.children()[i].children[0].value===l.religiosity){t.children()[i].className+=" active ",e(t.children()[i].children[0]).prop("checked","true");break}for(var o=e("#vocalization"),i=0;3>i;i++)if(o.children()[i].children[0].value===l.vocalization){o.children()[i].className+=" active ",e(o.children()[i].children[0]).prop("checked","true");break}}function o(){for(var t=e("#piece_file_table"),i=e("#movement_table"),o=1,n=0;n<l.attachments.length;n++){t.dynamicTable("addRow",!0);var s=t.find("#files_existing_files_"+o),c=t.find("#_existingfiles_source_"+o),m=t.find("#_existingfiles"+o);m.attr("name",l.attachments[n].id),m.css("background-color","#E8E8E8"),s.attr("href",l.attachments[n].attachment).text(l.attachments[n].file_name),c.val(l.attachments[n].source),l.attachments[n].parent="piece",o++}for(var n=0;n<l.movements.length;n++){i.dynamicTable("addRow",!0);var m=i.find("#_existingmov"+(n+1));m.attr("name",l.movements[n].item_id),m.css("background-color","#E8E8E8");for(var d=i.find("#_existingmov_title_"+(n+1)),u=i.find("#_existingmov"+(n+1)+"_instrumentation"),h=i.find("#_existingmov"+(n+1)+"_free_tags"),v=i.find("#_existingmov"+(n+1)+"_number_of_voices"),f=i.find("#_existingmov"+(n+1)+"_comment"),g=i.find("#_existingmov"+(n+1)+"_vocalization"),p=0;3>p;p++)if(g.children()[p].children[0].value===l.movements[n].vocalization){g.children()[p].className+=" active ",e(g.children()[p].children[0]).prop("checked","true");break}l.movements[n].instruments_voices=a(l.movements[n].instruments_voices),l.movements[n].tags=a(l.movements[n].tags),l.movements[n].position=n+1,d.val(l.movements[n].title),u.val(l.movements[n].instruments_voices),h.val(l.movements[n].tags),v.val(l.movements[n].number_of_voices),f.val(l.movements[n].comment);for(var p=0;p<l.movements[n].attachments.length;p++){t.dynamicTable("addRow",!0);var m=t.find("#_existingfiles"+o);m.css("background-color","#E8E8E8");var s=t.find("#files_existing_files_"+o),_=t.find("#_existingfiles_parent_"+o),c=t.find("#_existingfiles_source_"+o),m=t.find("#_existingfiles"+o);m.attr("name",l.movements[n].attachments[p].id),s.attr("href",l.movements[n].attachments[p].attachment).text(l.movements[n].attachments[p].file_name),c.val(l.movements[n].attachments[p].source),_.selectpicker("val","_existingmov_title_"+(n+1)),l.movements[n].attachments[p].parent="_existingmov_title_"+(n+1),o++}t.dynamicTable("drawAttachSelects")}e("[id^=del_mov], [id^=del_files]").click(function(t){var i,o,n,a,s=e(t.target).parents("[id^=_existing]")[0];i=-1!==s.id.indexOf("mov")?"M":"A","A"==i?(a=s.children[2].children[1].children[0].title,n=s.children[1].children[0].text,o=s.getAttribute("name"),r["delete"].push({type:i,id:o,name:n,parent:a})):(n=s.children[2].children[0].value,o=s.getAttribute("name"),r["delete"].push({type:i,id:o,name:n}))})}function n(){"true"!==sessionStorage.getItem("saw_instructions")&&($base_modal_header.html("<h4 class='modal-title'>Modifying an existing piece...<h4>"),$base_modal_body.html("<p>This form has been pre-filled with the current state of <em>"+l.title+"</em>.<ul><li>You may modify any of its properties.</li><li>Do not modify any fields that you do not wish to change.</li> <li>Existing movements and files are colored dark grey - you may modify or delete these as well.</li><li>You may also add new movements and files.</li></ul><strong>No changes are applied until you click the submit button </strong> at the bottom of the page. If you make a mistake, or need to restart the process, simply reload the page. </p>"),$base_modal_footer.html("<button type='button' class='btn btn-success' data-dismiss='modal'>Got it</button>"),$base_modal.modal("show"),sessionStorage.setItem("saw_instructions","true"))}function a(e,t){var i="";if(t)for(var o=0;o<e.length;o++)e[o]["public"]&&(i+=e[o].title+"; ");else for(var o=0;o<e.length;o++)i+=e[o].name+"; ";return i}function s(){r.modify=[],r.add=[];for(var t=e(".upload-input-field"),i=0;i<t.length;i++){var o=t[i].getAttribute("id");if("composition_start_date"===o)var n="composition_start_date";else n="composition_end_date"===o?"composition_end_date":o;if(e("#"+o).val()!=l[n]){if("comment"===o&&""===e("#"+o).val()&&null===l[n])continue;r.modify.push({type:"F",id:n,value:e("#"+o).val()})}}for(var a=e("#religiosity"),i=0;3>i;i++)if(-1!==a.children()[i].className.indexOf("active")){if(a.children()[i].children[0].value==l.religiosity)break;r.modify.push({type:"F",id:"religiosity",value:a.children()[i].children[0].value})}for(var s=e("#vocalization"),i=0;3>i;i++)if(-1!==s.children()[i].className.indexOf("active")){if(s.children()[i].children[0].value==l.vocalization)break;r.modify.push({type:"F",id:"vocalization",value:s.children()[i].children[0].value})}for(var d=c.children("[id^=_existingmov]"),i=0;i<d.length;i+=2){var u={},h=null,v=[],f=e(d[i]),g=e(d[i+1]),o=parseInt(f[0].getAttribute("name"));v.push(["title",f.find("[id^=_existingmov_title_]")[0].value]),v.push(["position",f.find("[id$=_position]")[0].value]),v.push(["instruments_voices",g.find("[id$=_instrumentation]")[0].value]),v.push(["tags",g.find("[id$=_free_tags]")[0].value]),v.push(["number_of_voices",g.find("[id$=_number_of_voices]")[0].value]),v.push(["comment",g.find("[id$=_comment]")[0].value]);var p=e(g.find("[id$=_vocalization]")[0]).children(".active")[0];p&&v.push(["vocalization",p.children[0].value]);for(var _=0;_<l.movements.length;_++)if(l.movements[_].item_id===o){h=l.movements[_];break}for(var b=0,y=1,_=0;_<v.length;_++)if(h[v[_][b]]!=v[_][y]){if("comment"===v[_][b]&&""===v[_][y]&&null===h[v[_][b]])continue;u[v[_][b]]=v[_][y]}e.isEmptyObject(u)||(u.id=o,u.type="M",r.modify.push(u))}for(var w=c.children("[id^=mov]"),i=0;i<w.length;i+=2){var f=e(w[i]),x=f.find("[id^=mov_title_]")[0].value,k=f.find("[id$=_position]")[0].value;""!==x&&r.add.push({type:"M",name:x,position:k})}for(var $=m.children("[id^=_existingfiles]"),i=0;i<$.length;i++){var u={},A=null,v=[],E=e($[i]),o=parseInt(E.attr("name"));v.push(["parent",E.find("[id^=_existingfiles_parent_]")[0].value]),v.push(["source",E.find("[id^=_existingfiles_source_]")[0].value]);for(var _=0;_<l.attachments.length;_++)if(l.attachments[_].id===o){A=l.attachments[_];var S="Attach to Piece";break}if(null===A)for(var _=0;_<l.movements.length;_++){for(var C=0;C<l.movements[_].attachments.length;C++)if(l.movements[_].attachments[C].id===o){A=l.movements[_].attachments[C];var S=l.movements[_].title;break}if(null!==A)break}for(var _=0;_<v.length;_++)if(A[v[_][b]]!==v[_][y]){if("source"===v[_][b]&&""===v[_][y]&&null===A[v[_][b]])continue;u[v[_][b]]=v[_][y]}e.isEmptyObject(u)||(u.id=o,u.type="A",u.name=E.children()[1].children[0].text,u.oldParent=S,u.newParentTitle=E.children()[2].children[1].children[0].title,"piece"!==u.parent&&(u.newParent=E.children()[2].children[0].value),r.modify.push(u))}for(var D=m.children("[id^=files]"),i=0;i<D.length;i++){var E=e(D[i]),x=E.children()[1].children[1].children[1].value;if(""!==x){var P=E.children()[2].children[1].children[0].title;"Attach to Piece"===P&&(P="the piece"),r.add.push({type:"A",name:x,parent:P})}}}var l={},r={};r.modify=[],r["delete"]=[],r.add=[],autocomplete("title","title_suggestion_menu","pieceSuggest"),autocomplete("composer","composer_suggestion_menu","composerSuggest"),autocomplete("collections","collection_suggestion_menu","collectionSuggest","list"),autocomplete("languages","language_suggestion_menu","languageSuggest","list"),autocomplete("genres","genre_suggestion_menu","genreSuggest","list"),autocomplete("locations","location_suggestion_menu","locationSuggest","list"),autocomplete("sources","source_suggestion_menu","sourceSuggest","list"),autocomplete("instruments_voices","instrumentation_suggestion_menu","instrumentSuggest","list"),autocomplete("tags","tags_suggestion_menu","tagSuggest","list");var c=e("#movement_table");c.dynamicTable({button:e("#new_mov"),table_name:"mov",movement:!0});var m=e("#piece_file_table");m.dynamicTable({button:e("#new_piece_file"),table_name:"files"}),t(),e('[data-toggle="popover"]').popover();var d=e("#composer-create-new-menu"),u=e("#composer");d.hide(),u.on("focusout",function(){var t=e("#composer").val();t.length>0&&e.ajax({url:"/composers/",data:{q:t},success:function(e){0==e.count&&(d.children().remove(".top-message"),d.prepend("<div class='top-message'><span class='help-block'><hr>We don't have <strong>"+t+"</strong> in our database. Submitting a piece by an unknown composer will add the composer to the database. <br>Do you have additional information to add to this new composer?<br><br></span></div>"),d.slideDown("slow"))}})}),u.on("keydown",function(e){13!==e.keyCode&&d.slideUp("slow")}),e(":input").on("input",function(){e(window).on("beforeunload",function(t){return"goto-piece"!==t.target.activeElement.id&&"success-refresh"!==t.target.activeElement.id?"Leaving this page will clear your form.":void e(window).off("beforeunload")}),e(":input").off("input")}),e("input:not(#comment)").on("keydown",function(e){13===e.keyCode&&e.preventDefault()}),e("#piece-submit").click(function(){if(s(),r["delete"].length>0||r.add.length>0||r.modify.length>0){var t="",i="",o="",n="";if(r["delete"].length>0){i="<h4>Delete</h4><ul>";for(var a=0;a<r["delete"].length;a++){var c=r["delete"][a];i+="A"===c.type?"<li>Delete file <em>"+c.name+"</em> attached to <strong>"+c.parent+"</strong>.</li>":"<li>Delete movement <strong>"+c.name+"</strong>.</li>"}i+="</ul>",t+=i}if(r.add.length>0){o="<h4>Add</h4><ul>";for(var a=0;a<r.add.length;a++){var c=r.add[a];o+="A"===c.type?"<li>Add file <em>"+c.name+"</em> attached to <strong>"+c.parent+"</strong>.</li>":"<li>Add movement <strong>"+c.name+"</strong> to <strong>"+l.title+"</strong></li>"}o+="</ul>",t+=o}if(r.modify.length>0){var m=!1;n="<h4>Moving</h4><ul>";for(var a=0;a<r.modify.length;a++){var c=r.modify[a];"A"===c.type&&(m=!0,n+="<li>Moving file <em>"+c.name+"</em> from <strong>"+c.oldParent+"</strong> to <strong>"+c.newParentTitle+"</strong>.</li>")}n+="</ul>",m&&(t+=n)}""!==t?($base_modal_header.html("<h4 class='modal-title'>Confirm Database Changes</h4>"),$base_modal_body.html(t),$base_modal_footer.html(".modal-footer").html("<div class='row'><div class='col-xs-2'><button type='button' class='btn btn-warning' id='restart-button'>Restart</button></div><div class='col-xs-10'><button type='button' class='btn btn-default btn' data-dismiss='modal'>Change something</button><button class='btn btn-success' id='confirm-changes'>Looks good!</a></div></div>"),$base_modal.modal("show"),e("#restart-button").click(function(){location.reload()}),e("#confirm-changes").click(function(){e("#new-piece-form").submit()})):e("#new-piece-form").submit()}else e("#new-piece-form").submit()}),e("#new-piece-form").submit(function(t){t.preventDefault(),$base_modal_header.html("<h4 class='modal-title'>Creating Piece...</h4>"),$base_modal_body.html("<div class='progress'><div class='progress-bar progress-bar-striped active' role='progressbar' style='width: 100%'></div> </div>"),$base_modal_footer.html(""),$base_modal.modal("show");var i=new FormData(this);i.append("changes",JSON.stringify(r)),e.ajax({type:"post",url:window.location.href,data:i,processData:!1,contentType:!1,success:function(t){if(void 0===t.errors)$base_modal_header.html("<h4 class='modal-title'>Done!</h4>"),$base_modal_body.html("<p>Piece succesfuly updated!</p>"),$base_modal_footer.html(".modal-footer").html("<a href='"+window.location.href+"' class='btn btn-default' id='success-refresh'>Refresh Page</a><a href='"+t.url+"' class='btn btn-default' id='goto-piece'>Go to Piece</a>");else{var i="";for(var o in t.errors){if("religiosity"===o)e("input[name='religiosity']").parent().removeClass("btn-default").addClass("btn-danger");else if("vocalization"===o)e("input[name='vocalization']").parent().removeClass("btn-default").addClass("btn-danger");else{if("collections"===o)continue;e("#"+o).parent().addClass("has-error")}e("#"+o+"_error").html("<b style='color:red'>"+t.errors[o][0]+"</b>"),i=i+"<strong>"+(o.charAt(0).toUpperCase()+o.slice(1)).replace(/_/g," ")+"</strong>: "+t.errors[o][0]+"<br>"}$base_modal_header.html("<h4 class='modal-title'>Form Error<h4>"),$base_modal_body.html("<p>Your submission has the following errors: <br>"+i+"</p>"),$base_modal_footer.html("<button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>")}},error:function(){$base_modal_header.html("<h4 class='modal-title'>Server Error<h4>"),$base_modal_body.html("<p>An error occurred while updating this piece. Please try again, or, if the error persists, <a href='mailto:elvisdatabase@gmail.com?Subject=Upload%20Error'>contact us</a></p>"),$base_modal_footer.html("<button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>")}})});var h=e(".upload-input-field");h.focus(function(t){e(t.target.parentElement.children[0]).popover("toggle")}),h.focusout(function(t){e(t.target.parentElement.children[0]).popover("hide")}),e("input[type=number]").keypress(function(e){return 0!==e.which&&8!==e.which&&(this.value.length>3||e.which<48||e.which>57)?!1:void 0})});