$(document).ready(function(e){function t(){e.ajax({datatype:"json",url:window.location.href+"?format=json",success:function(e){l=e,n(),o(),i()}})}function o(){e("#title").val(l.title),l.composer=l.composer.name,e("#composer").val(l.composer),e("#comment").val(l.comment),e("#composition_start_date").val(l.composition_start_date),e("#composition_end_date").val(l.composition_end_date),e("#number_of_voices").val(l.number_of_voices),l.languages=a(l.languages),l.collections=a(l.collections,!0),l.genres=a(l.genres),l.locations=a(l.locations),l.instruments_voices=a(l.instruments_voices),l.sources=a(l.sources),l.tags=a(l.tags),e("#collections").val(l.collections),e("#languages").val(l.languages),e("#genres").val(l.genres),e("#locations").val(l.locations),e("#instruments_voices").val(l.instruments_voices),e("#sources").val(l.sources),e("#tags").val(l.tags);for(var t=e("#religiosity"),o=0;3>o;o++)if(t.children()[o].children[0].value===l.religiosity){t.children()[o].className+=" active ",e(t.children()[o].children[0]).prop("checked","true");break}for(var i=e("#vocalization"),o=0;3>o;o++)if(i.children()[o].children[0].value===l.vocalization){i.children()[o].className+=" active ",e(i.children()[o].children[0]).prop("checked","true");break}}function i(){for(var t=e("#piece_file_table"),o=e("#movement_table"),i=1,n=0;n<l.attachments.length;n++){t.dynamicTable("addRow",!0);var s=t.find("#files_existing_files_"+i),r=t.find("#_existingfiles_source_"+i),d=t.find("#_existingfiles"+i);d.attr("name",l.attachments[n].id),d.css("background-color","#E8E8E8"),s.attr("href",l.attachments[n].attachment).text(l.attachments[n].file_name),r.val(l.attachments[n].source),l.attachments[n].parent="piece",i++}for(var n=0;n<l.movements.length;n++){o.dynamicTable("addRow",!0);var d=o.find("#_existingmov"+(n+1));d.attr("name",l.movements[n].item_id),d.css("background-color","#E8E8E8");for(var m=o.find("#_existingmov_title_"+(n+1)),u=o.find("#_existingmov"+(n+1)+"_instrumentation"),v=o.find("#_existingmov"+(n+1)+"_free_tags"),h=o.find("#_existingmov"+(n+1)+"_number_of_voices"),f=o.find("#_existingmov"+(n+1)+"_comment"),g=o.find("#_existingmov"+(n+1)+"_vocalization"),_=0;3>_;_++)if(g.children()[_].children[0].value===l.movements[n].vocalization){g.children()[_].className+=" active ",e(g.children()[_].children[0]).prop("checked","true");break}l.movements[n].instruments_voices=a(l.movements[n].instruments_voices),l.movements[n].tags=a(l.movements[n].tags),l.movements[n].position=n+1,m.val(l.movements[n].title),u.val(l.movements[n].instruments_voices),v.val(l.movements[n].tags),h.val(l.movements[n].number_of_voices),f.val(l.movements[n].comment);for(var _=0;_<l.movements[n].attachments.length;_++){t.dynamicTable("addRow",!0);var d=t.find("#_existingfiles"+i);d.css("background-color","#E8E8E8");var s=t.find("#files_existing_files_"+i),p=t.find("#_existingfiles_parent_"+i),r=t.find("#_existingfiles_source_"+i),d=t.find("#_existingfiles"+i);d.attr("name",l.movements[n].attachments[_].id),s.attr("href",l.movements[n].attachments[_].attachment).text(l.movements[n].attachments[_].file_name),r.val(l.movements[n].attachments[_].source),p.selectpicker("val","_existingmov_title_"+(n+1)),l.movements[n].attachments[_].parent="_existingmov_title_"+(n+1),i++}t.dynamicTable("drawAttachSelects")}e("[id^=del_mov], [id^=del_files]").click(function(t){var o,i,n,a,s=e(t.target).parents("[id^=_existing]")[0];o=-1!==s.id.indexOf("mov")?"M":"A","A"==o?(a=s.children[2].children[1].children[0].title,n=s.children[1].children[0].text,i=s.getAttribute("name"),c["delete"].push({type:o,id:i,name:n,parent:a})):(n=s.children[2].children[0].value,i=s.getAttribute("name"),c["delete"].push({type:o,id:i,name:n}))})}function n(){"true"!==sessionStorage.getItem("saw_instructions")&&($base_modal_header.html("<h4 class='modal-title'>Modifying an existing piece...<h4>"),$base_modal_body.html("<p>This form has been pre-filled with the current state of <em>"+l.title+"</em>.<ul><li>You may modify any of its properties.</li><li>Do not modify any fields that you do not wish to change.</li> <li>Existing movements and files are colored dark grey - you may modify or delete these as well.</li><li>You may also add new movements and files.</li></ul><strong>No changes are applied until you click the submit button </strong> at the bottom of the page. If you make a mistake, or need to restart the process, simply reload the page. </p>"),$base_modal_footer.html("<button type='button' class='btn btn-success' data-dismiss='modal'>Got it</button>"),$base_modal.modal("show"),sessionStorage.setItem("saw_instructions","true"))}function a(e,t){var o="";if(t)for(var i=0;i<e.length;i++)e[i]["public"]&&(o+=e[i].title+"; ");else for(var i=0;i<e.length;i++)o+=e[i].name+"; ";return o}function s(){c.modify=[],c.add=[];for(var t=e(".upload-input-field"),o=0;o<t.length;o++){var i=t[o].getAttribute("id");if("composition_start_date"===i)var n="composition_start_date";else n="composition_end_date"===i?"composition_end_date":i;if(e("#"+i).val()!=l[n]){if("comment"===i&&""===e("#"+i).val()&&null===l[n])continue;c.modify.push({type:"F",id:n,value:e("#"+i).val()})}}for(var a=e("#religiosity"),o=0;3>o;o++)if(-1!==a.children()[o].className.indexOf("active")){if(a.children()[o].children[0].value==l.religiosity)break;c.modify.push({type:"F",id:"religiosity",value:a.children()[o].children[0].value})}for(var s=e("#vocalization"),o=0;3>o;o++)if(-1!==s.children()[o].className.indexOf("active")){if(s.children()[o].children[0].value==l.vocalization)break;c.modify.push({type:"F",id:"vocalization",value:s.children()[o].children[0].value})}for(var r=d.children("[id^=_existingmov]"),o=0;o<r.length;o+=2){var u={},v=null,h=[],f=e(r[o]),g=e(r[o+1]),i=parseInt(f[0].getAttribute("name"));h.push(["title",f.find("[id^=_existingmov_title_]")[0].value]),h.push(["position",f.find("[id$=_position]")[0].value]),h.push(["instruments_voices",g.find("[id$=_instrumentation]")[0].value]),h.push(["tags",g.find("[id$=_free_tags]")[0].value]),h.push(["number_of_voices",g.find("[id$=_number_of_voices]")[0].value]),h.push(["comment",g.find("[id$=_comment]")[0].value]);var _=e(g.find("[id$=_vocalization]")[0]).children(".active")[0];_&&h.push(["vocalization",_.children[0].value]);for(var p=0;p<l.movements.length;p++)if(l.movements[p].item_id===i){v=l.movements[p];break}for(var b=0,y=1,p=0;p<h.length;p++)if(v[h[p][b]]!=h[p][y]){if("comment"===h[p][b]&&""===h[p][y]&&null===v[h[p][b]])continue;u[h[p][b]]=h[p][y]}e.isEmptyObject(u)||(u.id=i,u.type="M",u.oldTitle=v.title,c.modify.push(u))}for(var w=d.children("[id^=mov]"),o=0;o<w.length;o+=2){var f=e(w[o]),x=f.find("[id^=mov_title_]")[0].value,k=f.find("[id$=_position]")[0].value;""!==x&&c.add.push({type:"M",name:x,position:k})}for(var $=m.children("[id^=_existingfiles]"),o=0;o<$.length;o++){var u={},E=null,h=[],A=e($[o]),i=parseInt(A.attr("name"));h.push(["parent",A.find("[id^=_existingfiles_parent_]")[0].value]),h.push(["source",A.find("[id^=_existingfiles_source_]")[0].value]);for(var p=0;p<l.attachments.length;p++)if(l.attachments[p].id===i){E=l.attachments[p];var C="Attach to Piece";break}if(null===E)for(var p=0;p<l.movements.length;p++){for(var S=0;S<l.movements[p].attachments.length;S++)if(l.movements[p].attachments[S].id===i){E=l.movements[p].attachments[S];var C=l.movements[p].title;break}if(null!==E)break}for(var p=0;p<h.length;p++)if(E[h[p][b]]!==h[p][y]){if("source"===h[p][b]&&""===h[p][y]&&null===E[h[p][b]])continue;u[h[p][b]]=h[p][y]}e.isEmptyObject(u)||(u.id=i,u.type="A",u.name=A.children()[1].children[0].text,u.oldParent=C,u.oldSource=E.source,u.newParentTitle=A.children()[2].children[1].children[0].title,"piece"!==u.parent&&(u.newParent=A.children()[2].children[0].value),c.modify.push(u))}for(var T=m.children("[id^=files]"),o=0;o<T.length;o++){var A=e(T[o]),x=A.children()[1].children[1].children[1].value;if(""!==x){var z=A.children()[2].children[1].children[0].title;"Attach to Piece"===z&&(z="the piece"),c.add.push({type:"A",name:x,parent:z})}}}function r(t){for(var o="",i=e(":input"),n=0;n<i.length;n++){var a=i[n].getAttribute("aria-label");t.errors[i[n].name]&&"Religious Nature"!==a&&"Voice Type"!==a?(o+="<strong>"+a+"</strong> is required. <br>",e("#"+i[n].id).css("border-color","red").addClass("validation-error")):e("#"+i[n].id).css("border-color","#ccc").removeClass("validation-error")}if(t.errors.religiosity?(o+="<strong>Religious Nature</strong> is required. <br>",e("#religiosity").children().css("border-color","red").addClass("validation-error")):e("#religiosity").children().css("border-color","#ccc").removeClass("validation-error"),t.errors.vocalization?(o+="<strong>Voice Type</strong> is required. <br>",e("#vocalization").children().css("border-color","red").addClass("validation-error")):e("#vocalization").children().css("border-color","#ccc").removeClass("validation-error"),t.errors.__all__)for(var n=0;n<t.errors.__all__.length;n+=2){var s=t.errors.__all__[n];if(-1!==s.indexOf("files")){var r=null,l=s.replace(/^\D+/g,"");if(r=-1===s.indexOf("existing")?e("[id$=files_"+l+"]").val():e("[id$=files_"+l+"]").text()){var c=r.split("\\"),d=c[c.length-1];o+="<strong>File</strong><em> "+d+"</em> requires a source.<br>",e("#"+s).css("border-color","red").addClass("validation-error")}}-1!==s.indexOf("mov")&&(o+="<strong>Movements</strong> requires a title!<br>",e("#"+s).css("border-color","red").addClass("validation-error"))}return e(".validation-error").on("focus",function(){"vocalization"===this.parentElement.id?e("#vocalization").children().css("border-color","#ccc").removeClass("validation-error"):"religiosity"===this.parentElement.id?e("#religiosity").children().css("border-color","#ccc").removeClass("validation-error"):e(this).css("border-color","#ccc").removeClass("validation-error")}),o}var l={},c={};c.modify=[],c["delete"]=[],c.add=[],autocomplete("title","title_suggestion_menu","pieceSuggest"),autocomplete("composer","composer_suggestion_menu","composerSuggest"),autocomplete("collections","collection_suggestion_menu","collectionSuggest","list"),autocomplete("languages","language_suggestion_menu","languageSuggest","list"),autocomplete("genres","genre_suggestion_menu","genreSuggest","list"),autocomplete("locations","location_suggestion_menu","locationSuggest","list"),autocomplete("sources","source_suggestion_menu","sourceSuggest","list"),autocomplete("instruments_voices","instrumentation_suggestion_menu","instrumentSuggest","list"),autocomplete("tags","tags_suggestion_menu","tagSuggest","list");var d=e("#movement_table");d.dynamicTable({button:e("#new_mov"),table_name:"mov",movement:!0});var m=e("#piece_file_table");m.dynamicTable({button:e("#new_piece_file"),table_name:"files"}),t(),e('[data-toggle="popover"]').popover();var u=e("#composer-create-new-menu"),v=e("#composer");u.hide(),v.on("focusout",function(t){var o=e("#composer").val();o.length>0&&e.ajax({url:"/composers/",data:{q:o},success:function(e){0==e.count&&(u.children().remove(".top-message"),u.prepend("<div class='top-message'><span class='help-block'><hr>We don't have <strong>"+o+"</strong> in our database. Submitting a piece by an unknown composer will add the composer to the database. <br>Do you have additional information to add to this new composer?<br><br></span></div>"),u.slideDown("slow"))}})}),v.on("keydown",function(e){13!==e.keyCode&&u.slideUp("slow")}),e(":input").on("input",function(){e(window).on("beforeunload",function(t){return"goto-piece"!==t.target.activeElement.id&&"success-refresh"!==t.target.activeElement.id?"Leaving this page will clear your form.":void e(window).off("beforeunload")}),e(":input").off("input")}),e("input:not(#comment)").on("keydown",function(e){13===e.keyCode&&e.preventDefault()}),e("#piece-submit").click(function(){if(s(),c["delete"].length>0||c.add.length>0||c.modify.length>0){var t="",o="",i="",n="";if(c["delete"].length>0){o="<h4>Delete</h4><ul>";for(var a=0;a<c["delete"].length;a++){var r=c["delete"][a];o+="A"===r.type?"<li>Delete file <em>"+r.name+"</em> attached to <strong>"+r.parent+"</strong>.</li>":"<li>Delete movement <strong>"+r.name+"</strong>.</li>"}o+="</ul>",t+=o}if(c.add.length>0){i="<h4>Add</h4><ul>";for(var a=0;a<c.add.length;a++){var r=c.add[a];i+="A"===r.type?"<li>Add file <em>"+r.name+"</em> attached to <strong>"+r.parent+"</strong>.</li>":"<li>Add movement <strong>"+r.name+"</strong> to <strong>"+l.title+"</strong></li>"}i+="</ul>",t+=i}if(c.modify.length>0){var d=!1;n="<h4>Moving</h4><ul>";for(var a=0;a<c.modify.length;a++){var r=c.modify[a];"A"===r.type&&r.oldParent!==r.newParentTitle&&(d=!0,n+="<li>Moving file <em>"+r.name+"</em> from <strong>"+r.oldParent+"</strong> to <strong>"+r.newParentTitle+"</strong>.</li>")}n+="</ul>",d&&(t+=n)}""!==t?($base_modal_header.html("<h4 class='modal-title'>Confirm Database Changes</h4>"),$base_modal_body.html(t),$base_modal_footer.html(".modal-footer").html("<div class='row'><div class='col-xs-2'><button type='button' class='btn btn-warning' id='restart-button'>Restart</button></div><div class='col-xs-10'><button type='button' class='btn btn-default btn' data-dismiss='modal'>Change something</button><button class='btn btn-success' id='confirm-changes'>Looks good!</a></div></div>"),$base_modal.modal("show"),e("#restart-button").click(function(){location.reload()}),e("#confirm-changes").click(function(){e("#new-piece-form").submit()})):e("#new-piece-form").submit()}else e("#new-piece-form").submit()}),e("#new-piece-form").submit(function(t){t.preventDefault(),$base_modal_header.html("<h4 class='modal-title'>Modifying Piece...</h4>"),$base_modal_body.html("<div class='progress'><div class='progress-bar progress-bar-striped active' role='progressbar' style='width: 100%'></div> </div>"),$base_modal_footer.html(""),$base_modal.modal("show");var o=new FormData(this);o.append("changes",JSON.stringify(c)),e.ajax({type:"post",url:window.location.href,data:o,processData:!1,contentType:!1,success:function(t){if(void 0===t.errors)$base_modal_header.html("<h4 class='modal-title'>Done!</h4>"),$base_modal_body.html("<p>Piece succesfuly updated!</p>"),$base_modal_footer.html(".modal-footer").html("<a href='"+window.location.href+"' class='btn btn-default' id='success-refresh'>Refresh Page</a><a href='"+t.url+"' class='btn btn-default' id='goto-piece'>Go to Piece</a>");else{var o=r(t);$base_modal_header.html("<h4 class='modal-title'>Form Error<h4>"),$base_modal_body.html("<p>Your submission has the following errors: <br>"+o+"</p>"),$base_modal_footer.html("<button id='close-and-goto-button' type='button' class='btn btn-default' data-dismiss='modal'>Close</button>"),e("#close-and-goto-button").click(function(){e("html, body").animate({scrollTop:e(".validation-error").offset().top},500)})}},error:function(e){$base_modal_header.html("<h4 class='modal-title'>Server Error<h4>"),$base_modal_body.html("<p>An error occurred while updating this piece. Please try again, or, if the error persists, <a href='mailto:elvisdatabase@gmail.com?Subject=Upload%20Error'>contact us</a></p>"),$base_modal_footer.html("<button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>")}})});var h=e(".upload-input-field");h.focus(function(t){e(t.target.parentElement.children[0]).popover("toggle")}),h.focusout(function(t){e(t.target.parentElement.children[0]).popover("hide")}),e("input[type=number]").keypress(function(e){return 0!==e.which&&8!==e.which&&(this.value.length>3||e.which<48||e.which>57)?!1:void 0})});