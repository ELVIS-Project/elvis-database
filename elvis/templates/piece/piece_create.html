{% extends "base.html" %}


<!-- The javascript function for the typeahead functionality on the fields. -->

{% block extra_hd %}
    <title>Create Piece</title>

    <script type='text/javascript' src="{{ STATIC_URL }}js/elvis-scripts/autocomplete.js"></script>
    <script type='text/javascript' src="{{ STATIC_URL }}js/elvis-scripts/dynamicFileTable.js"></script>
    <script type='text/javascript' src="{{ STATIC_URL }}bootstrap/plugins/bootstrap-filestyle.js"></script>
    <style>
        .popover {
            max-width: 500px;
            width: auto;
        }
    </style>
<script>
$(document).ready(function($)
{
    autocomplete("title", "title_suggestion_menu", "pieceSuggest");
    autocomplete("composer", "composer_suggestion_menu", "composerSuggest");
    autocomplete("collections", "collection_suggestion_menu", "collectionSuggest", true);
    autocomplete("languages", "language_suggestion_menu", "languageSuggest", true);
    autocomplete("genres", "genre_suggestion_menu", "genreSuggest", true);
    autocomplete("locations", "location_suggestion_menu", "locationSuggest", true);
    autocomplete("sources", "source_suggestion_menu", "sourceSuggest", true);
    autocomplete("instruments_voices", "instrumentation_suggestion_menu", "instrumentSuggest", true);
    autocomplete("tags", "tags_suggestion_menu", "tagSuggest", true);
    dynamicFileTable("new_mov", "movement_table", "mov", "Movement Files", true);
    dynamicFileTable("new_piece_file", "piece_file_table", "piece", "Piece Files", false);

    $("#id_comp_pic").filestyle({input:false, iconName: "glyphicon-picture", buttonText: "Composer Picture", disabled: "true"});
    $('[data-toggle="popover"]').popover();

    // The dropdown form for additional composer information.
    var $newComposerMenu = $("#composer-create-new-menu");
    var $composerInput = $("#composer");
    $newComposerMenu.hide();

    $composerInput.on("focusout", function(event)
    {
        var query = $("#composer").val();

        if (query.length > 0)
        {
             $.ajax({
                url: "/composers/",
                data: {q: query},
                success: function (data)
                    {
                    if (data['count'] == 0)
                    {
                        $newComposerMenu.children().remove(".top-message");
                        $newComposerMenu.prepend("<div class='top-message'><span class='help-block'>" +
                            "<hr>We don't have <strong>" + query + "</strong> in our database. " +
                            "Submitting a piece by an unknown composer will add the composer to the database. <br>" +
                            "Do you have additional information to add to this new composer?<br><br></span></div>");
                        $newComposerMenu.slideDown("slow");
                    }
                }
            });
        }
    });

    $composerInput.on("keydown", function(event)
    {
        if (event['keyCode'] !== 13)
        {
            $newComposerMenu.slideUp("slow");
        }
    });

    $(window).on('beforeunload', function(event)
    {
        if (event['target']['activeElement']['id'] === 'goto-piece'){
            return;
        }
        else{
            return 'Leaving this page will clear your form.'
        }
    });

    //The next buttons on the tabs
    $(".next-tab").on("click", function()
    {
        event.preventDefault();
        $('#upload-tabs').children().filter('.active').next('li').find('a[data-toggle="tab"]').tab('show');
    });
    $(".back-tab").on("click", function()
    {
        event.preventDefault();
        $('#upload-tabs').children().filter('.active').prev('li').find('a[data-toggle="tab"]').tab('show');
    });

    //Disable default behaviour for hitting 'enter' for all inputs except the comment.
    $('input:not(#comment)').on("keydown", function(event){
        if (event.keyCode === 13)
        {
            event.preventDefault()
        }
    });


    // Logic for form validation and submission, as well as the modal which appears on submission.,
    var upload_modal_clone = $('#upload_modal').clone();

    $("#new-piece-form").submit(function(event)
    {
        event.preventDefault();
        $('#upload_modal').replaceWith(upload_modal_clone.clone());
        $('#upload_modal').modal('show');

        $.ajax({
            type: "post",
            url: "/pieces/",
            data: new FormData(this),
            processData: false,
            contentType: false,
            success: function (data)
            {
                if(data['errors'] === undefined)
                {
                    var $upload_modal = $('#upload_modal');
                    $upload_modal.find('.modal-title').html("Done!");
                    $upload_modal.find('.modal-footer').html("<a href='/pieces/create/'><button class='btn btn-default pull-left'>Upload Another Piece</button></a>" +
                                                             "<a href='"+data['url']+"'><button class='btn btn-default' id='goto-piece'>Go to Piece</button></a>");
                    $upload_modal.find('.progress-bar').removeClass("progress-bar-striped active");
                }
                else
                {
                    var errors = "";
                    for (var key in data['errors'])
                    {
                        if (key === "religiosity")
                        {
                            $("input[name='religiosity']").parent().removeClass("btn-default").addClass("btn-danger")
                        }
                        if (key === "vocalization")
                        {
                            $("input[name='vocalization']").parent().removeClass("btn-default").addClass("btn-danger")
                        }

                        else
                        {
                             $("#" + key).parent().addClass("has-error");
                        }

                            $("#" + key + "_error").html("<b style='color:red'>" + data['errors'][key][0] + "</b>");
                            errors = errors + "<strong>"+ (key.charAt(0).toUpperCase() + key.slice(1)).replace(/_/g, ' ' ) + "</strong>: " + data['errors'][key][0] + "<br>"
                    }
                    var $upload_modal = $('#upload_modal');
                    $upload_modal.find('.modal-title').html("Form Error");
                    $upload_modal.find('.progress').hide();
                    $upload_modal.find('.modal-body').prepend("Your submission has the following errors: <br>" + errors);
                    $upload_modal.find('.modal-footer').html("<button class='btn btn-default' id='close_modal'>Close</button>");
                }



                $('#close_modal').click(function(){
                    $upload_modal.modal('hide');
                    $('#upload-tabs').find("#tab_basics").find('a[data-toggle="tab"]').tab('show');
                });
                }
            })
        });

        var $upload_fields = $(".upload-input-field");
        $upload_fields.focus(function(event){
            $(event.target.parentElement.children[0]).popover('toggle');
        });
        $upload_fields.focusout(function(event){
            $(event.target.parentElement.children[0]).popover('hide');
        })
    })

</script>



{% endblock %}


{% block wrap %}

<!-- Modal -->
<div class="modal fade" id="upload_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Creating Piece</h4>
            </div>
            <div class="modal-body">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                        <span class="sr-only">100% Complete</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">

            </div>
        </div>
    </div>
</div>

<div class="page-header">
    <h2>Upload a Piece</h2>
</div>

<div class="upload-form">
    <ul class="nav nav-tabs" id="upload-tabs">
        <li class="active" id="tab_basics"><a data-toggle="tab" href="#basics">Basics</a></li>
        <li id="tab_advanced"><a data-toggle="tab" href="#advanced">Advanced</a></li>
        <li id="tab_attachments"><a data-toggle="tab" href="#attachments">Files</a></li>
    </ul>
    <form action="/pieces/" method="post" id="new-piece-form" enctype="multipart/form-data">
    {% csrf_token %}

        <div class="tab-content" style="padding-left:50px; padding-right:50px" id="upload-box">

            <div id="basics" class="tab-pane fade in active">
                <h4>Basic Piece Information</h4>
                <hr>
                <span class="help-block">
                    A title and composer are required fields to create a piece. Suggestions are offered for composers
                    which already exist in the database, and selecting one of these suggestions will add the piece
                    to the existing composers oeuvre. While you are encouraged to provide beginning and ending dates
                    for the composition, you are only required to provide one date.
                </span>
                <br>
                <div class="input-group">
                  <span class="input-group-addon" data-toggle="popover" data-placement="top" data-trigger="focus" data-html='true' title="<b>Title:</b> Required"
                        data-viewport="#new-piece-form" data-content="Duplicate titles will produce duplicate pieces in the database: this is to allow for
                        composers who may have many pieces with the same name.">Title</span>
                  <input type="text" id="title" name="title" autocomplete="off" class="form-control upload-input-field" placeholder="e.g. Ach Gott, vom Himmel sieh darein, BWV 2">
                </div>
                <div id="title_suggestion_menu" style="padding-left:120px"></div>
                <div id="title_error"></div>
                <br>
                <div class="input-group">
                    <span class="input-group-addon" data-toggle="popover" data-placement="top" data-trigger="focus" data-html='true' title="<b>Composer Name:</b> Required"
                          data-viewport="#new-piece-form" data-content="If present, select your composer from the dropdown suggestion menu in order to minimize duplicates.">Composer</span>
                    <input type="text" id="composer" name="composer" autocomplete='off' class="form-control upload-input-field" placeholder="e.g. Bach, Johann Sebastian">
                </div>
                <div id="composer_suggestion_menu" style="padding-left:120px"></div>
                <div id="composer_error"></div>
                <div id="composer-create-new-menu" style="padding-left:50px; padding-right:50px">
                    <div class="row" style="padding-left:20px; padding-right:20px">
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="input-group">
                                    <input type='date' name="composer_birth_date" id="composer_birth_date" max="2000-01-01" class="form-control unstyled"/>
                                    <span class="input-group-addon">Birth</span>
                                </div>
                                <div id="composer_birth_date_error"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="input-group">
                                    <input type='date' name="composer_death_date" id="composer_death_date" max="2000-01-01" class="form-control unstyled"/>
                                    <span class="input-group-addon">Death</span>
                                </div>
                                <div id="composer_death_date_error"></div>
                            </div>
                        </div>
                    </div>
                    <hr>
                </div>
                <br>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon" data-toggle="popover" data-placement="top" data-trigger="focus" data-html='true' title="<b>Composition Start Date:</b> Optional"
                                      data-viewport="#new-piece-form" data-content="If only one date is known, submit it as the 'Composition End Date'.">Composition Start Date</span>
                                <input type='date' name="composition_start_date" id="composition_start_date" autocomplete='off' max="2000-01-01" class="form-control unstyled upload-input-field"/>
                            </div>
                            <div id="composition_start_date_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon" data-toggle="popover" data-placement="top" data-trigger="focus" data-html='true' title="<b>Composition End Date:</b> Required"
                                      data-content="The date the piece was completed. If only the year is known, input 01/01/YYYY.">Composition End Date</span>
                                <input type='date' name="composition_end_date" id="composition_end_date" autocomplete='off' max="2000-01-01" class="form-control unstyled upload-input-field"/>
                            </div>
                            <div id="composition_end_date_error"></div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="text-right">
                    <button type='button' class='btn btn-success next-tab'>Next <span class='glyphicon glyphicon-chevron-right'></span></button>
                </div>
            </div>

            <div id="advanced" class="tab-pane fade">
                <h4>Additional Information</h4>
                <hr>
                <span class="help-block">
                    These fields make it easier to find the piece using the database search engine. Most fields can accept a list of inputs separated by semicolons.
                    For example, if the piece has a harpsichord, violin and cello, you can input "harpsichord; violin; cello" in the instrumentation field. If
                    this piece has movements, which you can define on the next tab, a number of these fields can be overridden on a per-movement basis.
                </span>
                <br>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon" data-toggle="popover" data-placement="top" data-trigger="focus" data-html='true' title="<b>Collection:</b> Optional"
                                      data-viewport="#upload-box" data-content="A collection is user-defined grouping of pieces. The collection can be based on date, uploader,
                                       composer - or any other parameter. If you input a collection name which is not already in the database, this new
                                       collection will be created and visible to the public. You can later make the collection private on the <a href='/collections/?creator={{ user.username }}' target='_blank'>My Collections</a> page">Collections</span>
                                <input type="text" id="collections" name="collections" autocomplete="off" class="form-control upload-input-field" placeholder="e.g. Prof.Fujinaga's Collection; McGill Collection">
                            </div>
                            <div id="collection_suggestion_menu" style="padding-left:120px"></div>
                            <div id="collections_error"></div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon" data-toggle="popover" data-placement="top" data-trigger="focus" data-html='true' title="<b>Languages:</b> Required*"
                                      data-viewport="#new-piece-form" data-content="Languages are required if the piece is <b>Vocal</b> or <b>Mixed</b>, but are optional on <b>Instrumental</b> pieces.">Text Language</span>
                                <input type='text' name="languages" id="languages" autocomplete="off" placeholder="e.g. English; German" class="form-control unstyled upload-input-field"/>
                            </div>
                            <div id="language_suggestion_menu" style="padding-left:120px"></div>
                            <div id="languages_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon" data-toggle="popover" data-placement="top" data-trigger="focus" data-html='true' title="<b>Genres:</b> Required"
                                       data-content="If present, select a genres from the suggestion list.">Genres</span>
                                <input type='text' name="genres" id="genres" autocomplete="off" placeholder="e.g. Mass" class="form-control unstyled upload-input-field"/>
                            </div>
                            <div id="genre_suggestion_menu" style="padding-left:120px"></div>
                            <div id="genres_error"></div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon" data-toggle="popover" data-placement="top" data-trigger="focus" data-html='true' title="<b>Number of Voices</b>: Required"
                                       data-viewport="#upload-box" data-content="Follow these rules for polyphonic instruments:<br><br>
                                      <ul>
                                       <li>The instrument should <b>not be counted</b> if the instrument has no independent part within the piece.</li>
                                       <li><b>Input '0' for the number of voices if</b>:</li>
                                          <ul>
                                            <li>The piece is a solo for the polyphonic instrument and has an unclear amount of voices.</li>
                                            <li>The piece is for one voice/instrument with the addition of the obbligato polyphonic instrument (more than just basso continuo).</li>
                                          </ul>
                                       <li>If the piece is a solo for a polyphonic instrument and has a distinct, listed, number of voices, <b>use this number</b> (ex: 4-part ricercar = 4 voices)</li>
                                      </ul>">
                                    Num. of Voices</span>
                                <input type='number' name="number_of_voices" autocomplete="off" placeholder="e.g. 2" id="number_of_voices" max="100" class="form-control unstyled upload-input-field" onkeypress='return event.charCode >= 48 && event.charCode <= 57'/>
                            </div>
                            <div id="number_of_voices_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon" data-toggle="popover" data-placement="top" data-trigger="focus" data-html='true' title="<b>Instrumentation:</b> Required"
                                      data-content="Use semicolons as a serperator for the list of instruments in the piece.">Instrumentation</span>
                                <input type='text' name="instruments_voices" autocomplete="off" id="instruments_voices" placeholder="e.g. Harpsichord" class="form-control unstyled upload-input-field"/>
                            </div>
                            <div id="instrumentation_suggestion_menu" style="padding-left:120px"></div>
                            <div id="instruments_voices_error"></div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon" data-toggle="popover" data-placement="top" data-trigger="focus" data-html='true' title="<b>Source:</b> Optional"
                                      data-content="Use this field to specify manuscript or print sources.">Sources</span>
                                <input type='text' name="sources" id="sources" autocomplete="off" placeholder="Manuscript" class="form-control unstyled upload-input-field"/>
                            </div>
                            <div id="source_suggestion_menu" style="padding-left:120px"></div>
                            <div id="sources_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                    <span class="input-group-addon" data-toggle="popover" data-placement="top" data-trigger="focus" data-html='true' title="<b>Location:</b> Optional"
                                          data-content="General locations are acceptable, and modern nation names are preferred.">Place of Origin</span>
                                <input type='text' name="locations" id='locations' autocomplete="off" placeholder="e.g. France" class="form-control unstyled upload-input-field"/>
                            </div>
                            <div id="location_suggestion_menu" style="padding-left:120px"></div>
                            <div id="locations_error"></div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="btn-group btn-group-justified form-inline radio" id="religiosity" data-toggle="buttons">
                            <label class="btn btn-default">
                                <input type="radio" name="religiosity" value="Sacred"> Sacred
                            </label>
                            <label class="btn btn-default">
                                <input type="radio" name="religiosity" value="Secular"> Secular
                            </label>
                            <label class="btn btn-default">
                                <input type="radio" name="religiosity" value="Ambiguous"> Ambiguous
                            </label>
                        </div>
                        <div id="religiosity_error"></div>
                    </div>
                    <div class="col-md-6">
                        <div class="btn-group btn-group-justified form-inline radio" id="vocalization" data-toggle="buttons">
                            <label class="btn btn-default">
                                <input type="radio" name="vocalization" value="Vocal"> Vocal
                            </label>
                            <label class="btn btn-default">
                                <input type="radio" name="vocalization" value="Instrumental"> Instrumental
                            </label>
                            <label class="btn btn-default">
                                <input type="radio" name="vocalization" value="Mixed"> Mixed
                            </label>
                        </div>
                        <div id="vocalization_error"></div>
                    </div>
                </div>
                <br>
                <h4>Comments</h4>
                <div class="form-group">
                  <textarea class="form-control" rows="7" name="comment" id="comment" style="resize:vertical"></textarea>
                </div>
                <br>
                <h4>Tags</h4>
                <div class="form-group">
                <hr>
                <span class="help-block">
                You may add any other tags you believe would help organize and define this piece here. Try not to
                duplicate information from the previous fields.
                </span>
                    <div class="input-group">
                        <span class="input-group-addon">Tags</span>
                        <input type='text' name="tags" id="tags" autocomplete="off" class="form-control unstyled"/>
                    </div>
                    <div id="tags_suggestion_menu" style="padding-left:120px"></div>
                    <div id="tags_error"></div>
                </div>
                <hr>

                <div class="text-right">
                    <button type='button' class='btn btn-primary back-tab'><span class='glyphicon glyphicon-chevron-left'></span> Back</button>
                    <button type='button' class='btn btn-success next-tab'>Next <span class='glyphicon glyphicon-chevron-right'></span></button>
                </div>
            </div>

            <div id="attachments" class="tab-pane fade">
                <h4>Upload Files</h4>

                <hr>
                <span class="help-block">
                    This table allows you to attach files to the piece itself. The source field is for information
                    regarding the source of the file itself, for instance "Choral wiki" or "Transcribed by Uploader",
                    or the name of the repository it comes from. You may add as many file groups as you like.
                    <strong>If you do not provide a source for your file, it will be ignored and not uploaded.</strong>
                </span>
                <div class="well">
                    <h4>Piece Files</h4>
                    <table class="table table-hover" >
                        <colgroup>
                            <col class="text-center" style="width: 5%;">
                            <col style="width: 5%;">
                            <col style="width: 50%;">
                            <col style="width: 24%;">
                        </colgroup>
                            <tbody id="piece_file_table">
                            <tr>
                                <th class="text-center">+/-</th>
                                <th class="text-center">#</th>
                                <th>File Source</th>
                                <th>Files</th>
                            </tr>
                            <!-- User can add rows for files here -->
                            </tbody>
                    </table>
                    <div><button id="new_piece_file" type="button" class="btn btn-default" >Add File</button></div>
                </div>
                <br>
                <span class="help-block">
                    This table allows you to define movements for the piece. Multiple fields from the previous
                    page may be overridden on a movement by movement basis by clicking the 'show advanced' button.
                    <strong>If you do not provide a name for a movement, it will be ignored and its files
                    not uploaded.</strong>
                </span>
                <div class="well">
                    <h4>Movements</h4>
                    <table class="table table-hover" >
                        <colgroup>
                            <col class="text-center" style="width: 5%;">
                            <col style="width: 5%;">
                            <col style="width: 50%;">
                            <col style="width: 15%;">
                            <col style="width: 5%;">
                        </colgroup>
                            <tbody id="movement_table">
                            <tr>
                                <th class="text-center">+/-</th>
                                <th class="text-center">#</th>
                                <th>Movement Title</th>
                                <th>Files</th>
                                <th>Advanced</th>
                            </tr>
                            <!-- User can add rows for files here -->
                            </tbody>
                    </table>
                    <hr>
                    <div><button id="new_mov" type="button" class="btn btn-default" >Add Movement</button></div>
                </div>
                <hr>
                <div class="text-right">
                    <button type='button' class='btn btn-primary back-tab'><span class='glyphicon glyphicon-chevron-left'></span> Back</button>
                    <button type='submit' id='piece-submit' class='btn btn-success'>Submit</button>
                </div>
            </div>
        </div>
        <br>
    </form>
</div>


{%  endblock %}

