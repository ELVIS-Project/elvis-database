function cartButtonRefresh(){var t=$("#collection-count");$(".cart-badge, .cart-button").off("click").tooltip().on("click",function(o){return o.preventDefault(),o.stopImmediatePropagation(),$button=$(this),$button.tooltip("hide"),$button.hasClass("disabled")?($button.blur(),!1):(type=$button.hasClass("cart-badge")?"badge":"button",action=$button.hasClass("btn-success")?"add":"remove",cart_timeout="add"===action?setTimeout(function(){$base_modal_header.html("<h4 class='modal-title'>Adding to Downloads...</h4>"),$base_modal_body.html("<p>Adding large collections or composer oeuvres to your downloads can take a little time...</p>"),$base_modal_footer.html("<div class='progress'><div class='progress-bar progress-bar-striped active' role='progressbar' style='width: 100%'></div> </div>"),$base_modal.modal("show")},1e3):setTimeout(function(){$base_modal_header.html("<h4 class='modal-title'>Removing from Downloads...</h4>"),$base_modal_body.html("<p>Removing large collections or composer oeuvres from your downloads can take a little time...</p>"),$base_modal_footer.html("<div class='progress'><div class='progress-bar progress-bar-striped active' role='progressbar' style='width: 100%'></div> </div>"),$base_modal.modal("show")},1e3),void $.ajax({type:"post",url:"/download-cart/",data:$button.parents(".recursive-patch-download-form").serialize(),success:function(o){clearTimeout(cart_timeout),$base_modal.modal("hide"),t.fadeOut(100,function(){t.text("("+o.count+")")}),t.fadeIn(100),init_cart_buttons()},error:function(t){$base_modal_header.html("<h4 class='modal-title'>Error modifying downloads!</h4>"),$base_modal_body.html("<p>Something went wrong and your cart was not modified!</p>"),$base_modal_footer.html("<button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>")}}))})}function init_cart_buttons(){null===$forms&&($forms=$(".recursive-patch-download-form")),null===items&&(items=build_item_dict($forms)),$.ajax({url:"/download-cart/",data:{check_in_cart:JSON.stringify(items)},success:function(t){for(var o=Object.keys(t),a=0;a<o.length;a++){var e=o[a];"button"==items[e].button_type?draw_button(t[e],items[e].$elem):draw_badge(t[e],items[e].$elem)}cartButtonRefresh()}})}function build_item_dict(t){items={};for(var o=0;o<t.size();o++){var a=t[o].children,e=null,n=null,l=null;for(var s in a){if(null!==e&&null!==n&&null!==l)break;var r=a[s];"item_type"!==r.name?("id"===r.name&&(n=r.value),"button_type"===r.name&&(l=r.value)):e=r.value}items[n]={type:e,button_type:l,$elem:$(t[o])}}return items}function draw_button(t,o){var a=$(o);a.children(":button").remove(),t.in_cart===!0?(a.children("[name=action]").val("remove"),a.prepend('<button type="button" class="btn btn-danger cart-button">Remove from Downloads </button>')):t.in_cart===!1&&(a.children("[name=action]").val("add"),a.prepend('<button type="button" class="btn btn-success cart-button">Add to Downloads </button>'))}function draw_badge(t,o){var a=$(o);a.children(":button").remove();var e="",n="";"Piece"===t.in_cart?(e='<button type="button" class="btn btn-mini btn-info disabled cart-badge" data-container="body" data-toggle="tooltip" data-placement="top" title="In cart under piece."><span class="glyphicon glyphicon-lock"> </span> </button>',n="add"):t.in_cart===!0?(e='<button type="button" class="btn btn-mini btn-danger cart-badge" data-container="body" data-toggle="tooltip" data-placement="top" title="Remove from Downloads"><span class="glyphicon glyphicon-minus"> </span> </button>',n="remove"):t.in_cart===!1&&(e='<button type="button" class="btn btn-mini btn-success cart-badge" data-container="body" data-toggle="tooltip" data-placement="top" title="Add to Downloads"><span class="glyphicon glyphicon-plus"> </span> </button> ',n="add"),a.prepend(e),a.children("[name=action]").val(n)}var type=null,action=null,$button=null,cart_timeout=null,items=null,$forms=null;