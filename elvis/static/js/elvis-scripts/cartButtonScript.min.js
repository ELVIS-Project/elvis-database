function cartButtonRefresh(){var t=$("#collection-count");$(".cart-badge, .cart-button").off("click").tooltip().on("click",function(n){return n.preventDefault(),n.stopImmediatePropagation(),$button=$(this),$button.tooltip("hide"),$button.hasClass("disabled")?($button.blur(),!1):($button.addClass("disabled"),type=$button.hasClass("cart-badge")?"badge":"button",action=$button.hasClass("btn-success")?"add":"remove",void $.ajax({type:"post",url:"/download-cart/",data:$button.parents(".recursive-patch-download-form").serialize(),success:function(n){clearTimeout(cart_timeout),$base_modal.modal("hide"),t.fadeOut(100,function(){t.text("("+n.count+")")}),t.fadeIn(100),init_cart_buttons()},error:function(t){$base_modal_header.html("<h4 class='modal-title'>Error modifying downloads!</h4>"),$base_modal_body.html("<p>Something went wrong and your cart was not modified!</p>"),$base_modal_footer.html("<button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>"),$base_modal.modal("show")}}))})}function redirect_to_login(){$(".cart-badge, .cart-button").off("click").tooltip().on("click",function(t){window.location="/login/?error=download"})}function init_cart_buttons(t){"undefined"==typeof t&&(t=!1),(null===$forms||t)&&($forms=$(".recursive-patch-download-form")),(null===items||t)&&(items=build_item_dict($forms)),$.ajax({url:"/download-cart/",type:"POST",data:{check_in_cart:JSON.stringify(light_items)},success:function(n){if(null!==n||t)for(var a=Object.keys(n),o=0;o<a.length;o++){var e=a[o],i=n[e].in_cart;(i!==items[e].in_cart||t)&&(items[e].in_cart=i,light_items[e].in_cart=i,"button"==items[e].button_type?draw_button(n[e],items[e].$elem):draw_badge(n[e],items[e].$elem))}cartButtonRefresh()},error:function(t){redirect_to_login()}})}function build_item_dict(t){items={};for(var n=0;n<t.size();n++){var a=t[n].children;items[a[2].value]={button_type:a[0].value,type:a[1].value,$elem:$(t[n]),in_cart:str_to_bool(a[3].value)},light_items[a[2].value]={type:a[1].value,in_cart:str_to_bool(a[3].value)}}return items}function str_to_bool(t){return"true"===t.toLowerCase()?!0:"init"===t.toLowerCase()?"init":!1}function draw_button(t,n){var a=$(n);a.children(":button").remove(),t.in_cart===!0?(a.children("[name=action]").val("remove"),a.append('<button type="button" class="btn btn-danger cart-button">Remove from Downloads </button>')):t.in_cart===!1&&(a.children("[name=action]").val("add"),a.append('<button type="button" class="btn btn-success cart-button">Add to Downloads </button>'))}function draw_badge(t,n){var a=$(n);a.children(":button").remove();var o="",e="";"Piece"===t.in_cart?(o='<button type="button" class="btn btn-mini btn-info disabled cart-badge" data-container="body" data-toggle="tooltip" data-placement="top" title="In cart under piece."><span class="glyphicon glyphicon-lock"> </span> </button>',e="add"):t.in_cart===!0?(o='<button type="button" class="btn btn-mini btn-danger cart-badge" data-container="body" data-toggle="tooltip" data-placement="top" title="Remove from Downloads"><span class="glyphicon glyphicon-minus"> </span> </button>',e="remove"):t.in_cart===!1&&(o='<button type="button" class="btn btn-mini btn-success cart-badge" data-container="body" data-toggle="tooltip" data-placement="top" title="Add to Downloads"><span class="glyphicon glyphicon-plus"> </span> </button> ',e="add"),a.append(o),a.children("[name=action]").val(e),a.children("[name=in_cart]").val(t.in_cart)}function create_download_form(t,n,a){var o=$("#"+a);o.append('<form class="recursive-patch-download-form" action="/download-cart/" method="post">             <input type="hidden" name="button_type" value="badge">             <input type="hidden" name="item_type"  value="'+t+'"/>             <input type="hidden" name="id"  value="'+n+'"/>             <input type="hidden" name="in_cart" value="false" />             <input type="hidden" name="action" value="add" />             <button type="button" class="btn btn-mini btn-success cart-badge" data-container="body" data-toggle="tooltip" data-placement="top" title="" data-original-title="Add to Downloads"><span class="glyphicon glyphicon-plus"> </span> </button>         </form>')}var type=null,action=null,$button=null,cart_timeout=null,items=null,light_items={},$forms=null;