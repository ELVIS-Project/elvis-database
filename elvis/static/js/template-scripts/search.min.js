$(document).ready(function(e){function t(t){t="undefined"!=typeof t?t:"result-page";var a=window.location.search.replace("?",""),s=e.parseParams(a),l=Object.keys(s);if(a){for(var n=0;n<l.length;n++)"typefilt[]"!==l[n]?"filefilt[]"!==l[n]?"sortby"!==l[n]?e("[name="+l[n]+"]").val(s[l[n]]):e("#sortby").multiselect("select",s[l[n]]):e("#filefilt").multiselect("select",s[l[n]]):e("#typefilt").multiselect("select",s[l[n]]);i(s,!1,t)}else e("#result-page").fadeOut(300)}function a(e,t){var a="?",i=Object.keys(e);for(var s in i)if("string"!=typeof e[i[s]]&&"page"!==i[s])for(var l=0;l<e[i[s]].length;l++)a+=i[s]+"="+e[i[s]][l]+"&";else a+=i[s]+"="+e[i[s]]+"&";a=a.slice(0,-1),window.history.pushState(t,"Search","/search/"+a)}function i(t,i,l){i="undefined"!=typeof i?i:!0,l="undefined"!=typeof l?l:"result-page",e.ajax({type:"get",url:"search",data:t,success:function(n){i&&a(t,n),e("#"+l).fadeOut(300,function(){s(n)}).fadeIn(300,function(){cartButtonRefresh()})}})}function s(t){var a=e("#search-results-list");if(a.html(""),e("#page-links").html(""),e("#accordion-facets").html(""),void 0===t.object_list||0===t.object_list.length)return e("#result-heading").hide(),e("#no-result-heading").show(),!1;e("#no-result-heading").hide(),e("#result-heading").show();for(var i=0;i<t.object_list.length;i++){var s=t.object_list[i];if("elvis_composer"!==s.type)if("elvis_collection"!==s.type)if("elvis_movement"!==s.type)if("elvis_piece"!==s.type);else{var c="<div class='row search-result-row row-eq-height'><div class='col-xs-1 search-result-add' id='result-list-add"+i+"'><div id='add"+i+"'></div></div><a href='/piece/"+s.item_id+"' id='result-list-item"+i+"' class='search-result-item col-xs-11'><span class='label label-success right-label'>Piece</span><h4> "+s.title+"</h4><p class='list-group-item-text'> Composer: "+s.composer_name+"</p><p class='list-group-item-text'> Date: "+s.composition_end_date.slice(0,4)+"</p>";void 0!==s.tags&&(c+="<p class='list-group-item-text'> Tags: "+s.tags+"</p>"),c+="</a></div>",a.append(c),create_download_form("elvis_piece",s.item_id,"add"+i)}else{var c="<div class='row search-result-row row-eq-height'><div class='col-xs-1 search-result-add' id='result-list-add"+i+"'><div id='add"+i+"'></div></div><a href='/movement/"+s.item_id+"' id='result-list-item"+i+"' class='search-result-item col-xs-11'><span class='label label-primary right-label'>Movement</span><h4>"+s.title+"</h4>";void 0!==s.parent_piece_name&&(c+="<p class='list-group-item-text'> Piece: "+s.parent_piece_name+"</p>"),c+="<p class='list-group-item-text'> Composer: "+s.composer_name+"</p><p class='list-group-item-text'> Date: "+s.composition_end_date.slice(0,4)+"</p>",void 0!==s.tags&&(c+="<p class='list-group-item-text'> Tags: "+s.tags+"</p>"),c+="</a></div>",a.append(c),create_download_form("elvis_movement",s.item_id,"add"+i)}else a.append("<div class='row search-result-row row-eq-height'><div class='col-xs-1 search-result-add' id='result-list-add"+i+"'><div id='add"+i+"'></div></div><a href='/collection/"+s.item_id+"' id='result-list-item"+i+"' class='search-result-item col-xs-11'><span class='label label-info right-label' style='margin-top:10px'>Collection</span><h4>"+s.title+"</h4><p class='list-group-item-text'>Created By: "+s.creator_name+" on "+s.created.substring(0,10)+"</p></a></div>"),create_download_form("elvis_collection",s.item_id,"add"+i);else{if(s.birth_date)var r=s.birth_date.slice(0,4);else r="Unknown";if(s.death_date)var d=s.death_date.slice(0,4);else d="Unknown";a.append("<div class='row search-result-row row-eq-height'><div class='col-xs-1 search-result-add' id='result-list-add"+i+"'><div id='add"+i+"'></div></div><a href='/composer/"+s.item_id+"' id='result-list-item"+i+"' class='search-result-item col-xs-11'><span class='label label-default right-label'>Composer</span><h4>"+s.name+"</h4><p class='list-group-item-text'>"+r+"-"+d+"</p></a></div>"),create_download_form("elvis_composer",s.item_id,"add"+i)}}l(t),n(t),o()}function l(t){var a=e("#page-links"),s="<ul class='pagination'>";return void 0===t.object_list?(a.html(""),!1):(1===t.number?(s+="<li class='disabled'><a href='first' onClick='return false;' id='first-button'>First</a></li>",s+="<li class='disabled'><a href='previous' onClick='return false;' id='previous-button'>Previous</a></li>"):(s+="<li><a href='first' onClick='return false;' id='first-button'>First</a></li>",s+="<li><a href='previous' onClick='return false;' id='previous-button'>Previous</a></li>"),s+="<li class='disabled'><a href='#' onClick='return false;'>Page "+t.number+" of "+t.paginator.total_pages+"</a></li>",t.number===t.paginator.total_pages?(s+="<li class='disabled'><a href='next' onClick='return false;' id='next-button'>Next</a></li>",s+="<li class='disabled'><a href='last' onClick='return false;' id='  last-button'> Last </a></li>"):(s+="<li><a href='next' onClick='return false;' id='next-button'>Next</a></li>",s+="<li><a href='last' onClick='return false;' id='last-button'> Last </a></li>"),s+="</ul>",a.html(s),e("#first-button").click(function(){if(!e(this.parentElement).hasClass("disabled")){var t=e.parseParams(window.location.search.replace("?",""));delete t.page,i(t,!0)}}),e("#previous-button").click(function(){if(!e(this.parentElement).hasClass("disabled")){var a=e.parseParams(window.location.search.replace("?",""));a.page=t.number-1,i(a,!0)}}),e("#next-button").click(function(){if(!e(this.parentElement).hasClass("disabled")){var a=e.parseParams(window.location.search.replace("?",""));a.page=t.number+1,i(a,!0)}}),void e("#last-button").click(function(){if(!e(this.parentElement).hasClass("disabled")){var a=e.parseParams(window.location.search.replace("?",""));a.page=t.paginator.total_pages,i(a,!0)}}))}function n(a){var i=e("#accordion-facets"),s=Object.keys(a.facet_names),l=a.facets.facet_fields,n="";for(var o in s)if(0!==Object.keys(l[s[o]]).length){var r=s[o],d="<div class='panel panel-default'><div class='panel-heading facets'><h3 class='panel-title facets' data-toggle='collapse' data-target='#collapse-"+r+"'>"+a.facet_names[s[o]]+"</h3></div>",p="<div id='collapse-"+r+"' class='panel-collapse collapse facets in'><div class='panel-body facets' id='facet-panel-"+r+"'>",u=l[s[o]];for(var f in u){var h=l[s[o]];if("type"===s[o])var m=f.slice(6)[0].toUpperCase()+f.slice(7);else var m=f;p+="<div class='facet-list'><div id='facet-"+s[o]+"-"+c(f)+"' class='facet-wrapper'><label class='facet-label' for='facet-link-"+c(f)+"-"+s[o]+"'><input type='checkbox' class='facet-link' style='margin: 4px 4px 0' data-facet-name='"+s[o]+"' data-facet-value='"+c(f)+"' id='facet-link-"+c(f)+"-"+s[o]+"'>"+m+"  ("+h[f]+")</label></div></div>"}p+="</div></div></div>",n+=d+p}i.html(n);for(var v=window.location.search.replace("?",""),b=e.parseParams(v),s=Object.keys(b),f=0;f<s.length;f++)"object"==typeof b[s[f]]?e.each(b[s[f]],function(t){e("input[data-facet-name='"+s[f]+"'][id='facet-link-"+c(b[s[f]][t])+"-"+s[f]+"']").attr("checked",!0)}):e("input[data-facet-name='"+s[f]+"'][id='facet-link-"+c(b[s[f]])+"-"+s[f]+"']").attr("checked",!0);e(".facet-link").on("click",function(){var i=e(this).data("facet-name"),s=e(this).data("facet-value");e(this).is(":checked")?(v=window.location.search.replace("?",""),v+="&"+i+"="+s,window.history.pushState(a,"Search","/search/?"+v),t("search-results-list")):(v=window.location.search.replace("?",""),v=v.replace("&"+i+"="+s,""),window.history.pushState(a,"Search","/search/?"+v),t("search-results-list"))})}function o(){for(var t=e(".recursive-patch-download-form"),a=[],i=0;i<t.size();i++)a.push({type:t[i][0].value,id:t[i][1].value,num:i});e.ajax({url:"/downloads/",data:{check_in_cart:JSON.stringify(a)},success:function(a){console.log(a);for(var i=0;i<t.size();i++)"Piece"!==a[i].in_cart?a[i].in_cart!==!0?a[i].in_cart===!1&&e(t[i]).prepend('<button type="button" class="btn btn-mini btn-success cart-badge" data-container="body" data-toggle="tooltip" data-placement="top" title="Add to Downloads"><span class="glyphicon glyphicon-plus"> </span> </button> '):(e(t[i].children[2]).val("remove"),e(t[i]).prepend('<button type="button" class="btn btn-mini btn-danger cart-badge" data-container="body" data-toggle="tooltip" data-placement="top" title="Remove from Downloads"><span class="glyphicon glyphicon-minus"> </span> </button>')):e(t[i]).prepend('<button type="button" class="btn btn-mini btn-info disabled" data-container="body" data-toggle="tooltip" data-placement="top" title="Movement in Downloads under parent Piece. Remove Piece to modify."><span class="glyphicon glyphicon-lock"> </span> </button>')}})}function c(e){var t=encodeURI(e);return t=t.replace("'","%27")}e(".input-group-addon").tooltip(),e("#typefilt").multiselect({checkboxName:"typefilt[]"}),e("#sortby").multiselect({checkboxName:"sortby"}),e("#filefilt").multiselect({checkboxName:"filefilt[]"}),autocomplete("namefilt","namefilt-suggestions","composerSuggest","bool"),autocomplete("tagfilt","tagfilt-suggestions","tagSuggest","bool"),t(),e(window).bind("popstate",function(){t()}),e("#asearch-submit").click(function(){e(this).blur(),e("#advanced-search-form").submit()}),e(".asearch-input").on("keydown",function(t){13===t.keyCode&&e("#advanced-search-form").submit()}),e("#advanced-search-form").submit(function(t){t.preventDefault();var a=e.parseParams(e(this).serialize());for(var s in a)""===a[s]&&delete a[s];i(a)}),e("#gsearch-submit").click(function(){e(this).blur(),e("#general-search-form").submit()}),e("#general-search-form").submit(function(t){t.preventDefault();var a=e("#gsearch-input").val();i({q:a})}),e("#all-download").click(function(){document.getElementById("search_query").value=window.location.href,e.ajax({type:"post",url:"/downloads/",data:e("#all-patch-download-form").serialize(),success:function(t){var a=e("#collection-count");a.fadeOut(100,function(){a.text("("+t.count+")")}),a.fadeIn(100)}})}),e("#datefiltt, #datefiltf ").keypress(function(e){return 0!==e.which&&8!==e.which&&(this.value.length>3||e.which<48||e.which>57)?!1:void 0})});