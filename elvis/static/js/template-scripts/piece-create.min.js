$(document).ready(function(e){function o(o){for(var t="",r=e(":input"),a=0;a<r.length;a++){var s=r[a].getAttribute("aria-label");o.errors[r[a].name]&&"Religious Nature"!==s&&"Voice Type"!==s?(t+="<strong>"+s+"</strong> is required. <br>",e("#"+r[a].id).addClass("validation-error")):e("#"+r[a].id).removeClass("validation-error")}if(o.errors.religiosity?(t+="<strong>Religious Nature</strong> is required. <br>",e("#religiosity").children().addClass("validation-error")):e("#religiosity").children().removeClass("validation-error"),o.errors.vocalization?(t+="<strong>Voice Type</strong> is required. <br>",e("#vocalization").children().addClass("validation-error")):e("#vocalization").children().removeClass("validation-error"),o.errors.__all__)for(var a=0;a<o.errors.__all__.length;a+=2){var i=o.errors.__all__[a];if(-1!==i.indexOf("files")){var n=i.replace(/^\D+/g,""),l=e("[id$=files_"+n+"]").val();if(l){var c=l.split("\\"),d=c[c.length-1];t+="<strong>File</strong><em> "+d+"</em> requires a source.",e("#"+i).css("border-color","#FF9494").addClass("validation-error")}}}return e(".validation-error").on("focus click",function(){"vocalization"===this.parentElement.id?e("#vocalization").children().css("border-color","#ccc").removeClass("validation-error"):"religiosity"===this.parentElement.id?e("#religiosity").children().css("border-color","#ccc").removeClass("validation-error"):e(this).css("border-color","#ccc").removeClass("validation-error")}),t}autocomplete("title","title_suggestion_menu","pieceSuggest"),autocomplete("composer","composer_suggestion_menu","composerSuggest"),autocomplete("collections","collection_suggestion_menu","collectionSuggest","list"),autocomplete("languages","language_suggestion_menu","languageSuggest","list"),autocomplete("genres","genre_suggestion_menu","genreSuggest","list"),autocomplete("locations","location_suggestion_menu","locationSuggest","list"),autocomplete("sources","source_suggestion_menu","sourceSuggest","list"),autocomplete("instruments_voices","instrumentation_suggestion_menu","instrumentSuggest","list"),autocomplete("tags","tags_suggestion_menu","tagSuggest","list");var t=e("#movement_table");t.dynamicTable({button:e("#new_mov"),table_name:"mov",movement:!0}).dynamicTable("addRow");var r=e("#piece_file_table");r.dynamicTable({button:e("#new_piece_file"),table_name:"files"}).dynamicTable("addRow"),e('[data-toggle="popover"]').popover();var a=e("#composer-create-new-menu"),s=e("#composer");a.hide(),s.on("focusout",function(o){var t=e("#composer").val();t.length>0&&e.ajax({url:"/composers/",data:{q:t},success:function(e){0==e.count&&(a.children().remove(".top-message"),a.prepend("<div class='top-message'><span class='help-block'><hr>We don't have <strong>"+t+"</strong> in our database. Submitting a piece by an unknown composer will add the composer to the database. <br>Do you have additional information to add to this new composer?<br><br></span></div>"),a.slideDown("slow"))}})}),s.on("keydown",function(e){13!==e.keyCode&&a.slideUp("slow")}),e(":input").on("input",function(){e(window).on("beforeunload",function(o){return"goto-piece"!==o.target.activeElement.id?"Leaving this page will clear your form.":void e(window).off("beforeunload")}),e(":input").off("input")}),e("input:not(#comment)").on("keydown",function(e){13===e.keyCode&&e.preventDefault()}),e("#piece-submit").click(function(){e("#new-piece-form").submit()}),e("#new-piece-form").submit(function(t){t.preventDefault(),$base_modal_header.html("<h4 class='modal-title'>Creating Piece...</h4>"),$base_modal_body.html("<div class='progress'><div class='progress-bar progress-bar-striped active' role='progressbar' style='width: 100%'></div> </div>"),$base_modal.modal("show"),e.ajax({type:"post",url:"/pieces/",data:new FormData(this),processData:!1,contentType:!1,success:function(e){void 0===e.errors&&($base_modal_header.html("<h4 class='modal-title'>Done!</h4>"),$base_modal_body.html("<p>Piece succesfuly uploaded!</p>"),$base_modal_footer.html(".modal-footer").html(" <button type='button' class='btn btn-default' data-dismiss='modal'>Close</button><a href='"+e.url+"' class='btn btn-default' id='goto-piece'>Go to Piece</a>"))},error:function(t){if(void 0==t.responseJSON||void 0===t.responseJSON.errors)$base_modal_header.html("<h4 class='modal-title'>Server Error<h4>"),$base_modal_body.html("<p>An error occurred while updating this piece. Please try again, or, if the error persists, <a href='mailto:elvisdatabase@gmail.com?Subject=Upload%20Error'>contact us</a></p>"),$base_modal_footer.html("<button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>");else{var r=o(t.responseJSON);$base_modal_header.html("<h4 class='modal-title'>Form Error<h4>"),$base_modal_body.html("<p>Your submission has the following errors: <br>"+r+"</p>"),$base_modal_footer.html("<button id='close-and-goto-button' type='button' class='btn btn-default' data-dismiss='modal'>Close</button>"),e("#close-and-goto-button").click(function(){e("html, body").animate({scrollTop:e(".validation-error").offset().top-10},500)})}}})});var i=e(".upload-input-field");i.focus(function(o){e(o.target.parentElement.children[0]).popover("toggle")}),i.focusout(function(o){e(o.target.parentElement.children[0]).popover("hide")}),e("input[type=number]").keypress(function(e){return 0!==e.which&&8!==e.which&&(this.value.length>3||e.which<48||e.which>57)?!1:void 0})});