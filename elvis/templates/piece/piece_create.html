{% extends "base.html" %}


<!-- The javascript function for the typeahead functionality on the fields. -->

{% block extra_hd %}
    <title>Create Piece</title>

    <script type='text/javascript' src="{{ STATIC_URL }}js/elvis-scripts/autocomplete.js"></script>
    <script type='text/javascript' src="{{ STATIC_URL }}js/elvis-scripts/dynamicFileTable.js"></script>
    <script type='text/javascript' src="{{ STATIC_URL }}bootstrap/plugins/bootstrap-filestyle.js"></script>

<script>
$(document).ready(function($)
{
    autocomplete("title", "title_suggestion_menu", "pieceSuggest");
    autocomplete("composer", "composer_suggestion_menu", "composerSuggest");
    autocomplete("collections", "collection_suggestion_menu", "collectionSuggest", true);
    autocomplete("languages", "language_suggestion_menu", "languageSuggest", true);
    autocomplete("genres", "genre_suggestion_menu", "genreSuggest", true);
    autocomplete("locations", "location_suggestion_menu", "locationSuggest", true);
    autocomplete("sources", "source_suggestion_menu", "sourceSuggest", true);
    autocomplete("instrument_voices", "instrumentation_suggestion_menu", "instrumentSuggest", true);
    dynamicFileTable("new_mov", "movement_table", "mov", "Movement Files");
    dynamicFileTable("new_piece_file", "piece_file_table", "piece", "Piece Files");

    $("#id_comp_pic").filestyle({input:false, iconName: "glyphicon-picture", buttonText: "Composer Picture", disabled: "true"});


    // The dropdown form for additional composer information.
    var $newComposerMenu = $("#composer-create-new-menu");
    var $composerInput = $("#composer");
    $newComposerMenu.hide();

    $composerInput.on("focusout", function(event)
    {
        var query = $("#composer").val();

        if (query.length > 0)
        {
             $.ajax({
                url: "/composers/",
                data: {q: query},
                success: function (data)
                {
                    if (data['count'] == 0)
                    {
                        $newComposerMenu.children().remove(".top-message");
                        $newComposerMenu.prepend("<div class='top-message'><span class='help-block'>" +
                            "<hr>We don't have <strong>" + query + "</strong> in our database. " +
                            "Submitting a piece by an unknown composer will add the composer to the database. <br>" +
                            "Do you have additional information to add to this new composer?<br><br></span></div>");
                        $newComposerMenu.slideDown("slow");
                    }
                }
            });
        }
    });

    $composerInput.on("keydown", function(event)
    {
        if (event['keyCode'] !== 13)
        {
            $newComposerMenu.slideUp("slow");
        }
    });


    //The next buttons on the tabs
    $("[id^=nexttab]").on("click", function()
    {
        event.preventDefault();
        $('#upload-tabs').children().filter('.active').next('li').find('a[data-toggle="tab"]').tab('show');
    });


    $('input:not(#comment)').on("keydown", function(event){
        if (event.keyCode === 13)
        {
            event.preventDefault()
        }
    });

    var upload_modal_clone = $('#upload_modal').clone();

    $("#new-piece-form").submit(function(event)
    {
        event.preventDefault();
        $('#upload_modal').replaceWith(upload_modal_clone.clone());
        $('#upload_modal').modal('show');
        debugger;

        $.ajax({
            type: "post",
            url: "/pieces/",
            data: new FormData(this),
            processData: false,
            contentType: false,
            success: function (data) {
                if(data['errors'] === undefined)
                {
                    var $upload_modal = $('#upload_modal');
                    $upload_modal.find('.modal-title').html("Done!");
                    $upload_modal.find('.modal-footer').html("<a href='/pieces/create/'><button class='btn btn-default pull-left'>Upload Another Piece</button></a>" +
                                                             "<a href='"+data['url']+"'><button class='btn btn-default'>Go to Piece</button></a>");
                    $upload_modal.find('.progress-bar').removeClass("progress-bar-striped active");
                }
                else
                {
                    var errors = "";
                    for (var key in data['errors'])
                    {
                        $("#" + key).parent().addClass("has-error");
                        $("#" + key + "_label").attr("title", data['errors'][key][0]);
                        //$("#" + key + "_label").tooltip('show');
                        errors = errors + "<strong>"+ key.charAt(0).toUpperCase() + key.slice(1) + "</strong>: " + data['errors'][key][0] + "<br>"
                    }

                    var first_error_tab_id = $("#"+Object.keys(data['errors'])[0]).parents('.tab-pane').attr('id');

                    var $upload_modal = $('#upload_modal');
                    $upload_modal.find('.modal-title').html("Flagrant Error");
                    $upload_modal.find('.progress').hide();
                    $upload_modal.find('.modal-body').prepend("Your submission has the following errors: <br>" + errors);
                    $upload_modal.find('.modal-footer').html("<button class='btn btn-default' id='close_modal'>Close</button>");

                    $('#close_modal').click(function(){
                        $upload_modal.modal('hide');
                        $('#upload-tabs').find("#tab_" + first_error_tab_id).find('a[data-toggle="tab"]').tab('show');
                        $("#title_label").tooltip('show');
                        debugger;
                    });
                }
            }
        });
    })

})

</script>



{% endblock %}


{% block wrap %}

<!-- Modal -->
<div class="modal fade" id="upload_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Creating Piece</h4>
            </div>
            <div class="modal-body">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                        <span class="sr-only">100% Complete</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">

            </div>
        </div>
    </div>
</div>

<div class="page-header">
    <h2>Upload a Piece</h2>
</div>

<div class="upload-form">
    <ul class="nav nav-tabs" id="upload-tabs">
        <li class="active" id="tab_basics"><a data-toggle="tab"href="#basics">Basics</a></li>
        <li id="tab_advanced"><a data-toggle="tab" href="#advanced">Advanced</a></li>
        <li id="tab_attachments"><a data-toggle="tab" href="#attachments">Files</a></li>
    </ul>
    <form action="/pieces/" method="post" id="new-piece-form" enctype="multipart/form-data">
    {% csrf_token %}

        <div class="tab-content" style="padding-left:50px; padding-right:50px">

            <div id="basics" class="tab-pane fade in active">
                <h4>Basic Piece Information</h4>
                <hr>
                <span class="help-block">
                A title and composer are required fields to create a piece. Suggestions are offered for composers
                which already exist in the database, and selecting one of these suggestions will add the piece
                to the existing composers oeuvre.
                </span>
                <div class="input-group">
                  <span class="input-group-addon" id="title_label" data-toggle="tooltip" data-placement="top" title="">Title</span>
                  <input type="text" id="title" name="title" autocomplete="off" class="form-control" placeholder="e.g. Ach Gott, vom Himmel sieh darein, BWV 2">
                </div>
                <div id="title_suggestion_menu" style="padding-left:120px"></div>
                <br>
                <div class="input-group">
                    <span class="input-group-addon">Composer</span>
                    <input type="text" id="composer" autocomplete="off" name="composer" class="form-control" placeholder="e.g. Bach, Johann Sebastian">
                </div>
                <div id="composer_suggestion_menu" style="padding-left:120px"></div>
                <div id="composer-create-new-menu" style="padding-left:50px; padding-right:50px">
                    <div class="row" style="padding-left:20px; padding-right:20px">
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="input-group">
                                    <input type='date' name="composer_birth_date" id="composer_birth_date" max="2000-01-01" class="form-control unstyled"/>
                                    <span class="input-group-addon">Birth</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="input-group">
                                    <input type='date' name="composer_death_date" id="composer_death_date" max="2000-01-01" class="form-control unstyled"/>
                                    <span class="input-group-addon">Death</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <div class="input-group">
                                    <input name="comp_pic" id="id_comp_pic" type="file" multiple="multiple"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                </div>
                <br>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon">Composition Start Date</span>
                                <input type='date' name="composition_start_date" id="composition_start_date" max="2000-01-01" class="form-control unstyled"/>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon">Composition End Date</span>
                                <input type='date' name="composition_end_date" id="composition_end_date" max="2000-01-01" class="form-control unstyled"/>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="text-right">
                    <button type='button' id='nexttab1'  class='btn btn-success'>Next<span class='glyphicon glyphicon-chevron-right'></span></button>
                </div>
            </div>

            <div id="advanced" class="tab-pane fade">
                <h4>Additional Information</h4>
                <hr>
                <span class="help-block">
                These fields make it easier to find the piece using the database search engine. Each field can accept multiple inputs seperated by semicolons.
                For example, if the piece has a harpsichord, violin and cello, you can input "harpsichord; violin; chello" in the instrumentation field.
                </span>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon">Collections</span>
                                <input type="text" id="collections" name="collections" autocomplete="off" class="form-control" placeholder="e.g. Prof.Fujinaga's Collection; McGill Collection">
                            </div>
                            <div id="collection_suggestion_menu" style="padding-left:120px"></div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon">Languages</span>
                                <input type='text' name="languages" id="languages" autocomplete="off" placeholder="e.g. English; German" class="form-control unstyled"/>
                            </div>
                            <div id="language_suggestion_menu" style="padding-left:120px"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon">Genres</span>
                                <input type='text' name="genres" id="genres" autocomplete="off" placeholder="e.g. Mass" class="form-control unstyled"/>
                            </div>
                            <div id="genre_suggestion_menu" style="padding-left:120px"></div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon">Num. of Voices</span>
                                <input type='number' name="number_of_voices" autocomplete="off" placeholder="e.g. 2" id="number_of_voices" max="100" class="form-control unstyled"/>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon">Place of Origin</span>
                                <input type='text' name="locations" id=locations autocomplete="off" placeholder="e.g. France" class="form-control unstyled"/>
                            </div>
                            <div id="location_suggestion_menu" style="padding-left:120px"></div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon">Sources</span>
                                <input type='text' name="sources" id="sources" autocomplete="off" placeholder="e.g. McGill" class="form-control unstyled"/>
                            </div>
                            <div id="source_suggestion_menu" style="padding-left:120px"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon">Instrumentation</span>
                                <input type='text' name="instrument_voices" autocomplete="off" id="instrument_voices" placeholder="e.g. Harpsichord" class="form-control unstyled"/>
                            </div>
                            <div id="instrumentation_suggestion_menu" style="padding-left:120px"></div>
                        </div>
                    </div>
                </div>
                <br>
                <h4>Piece Comment</h4>
                <div class="form-group">
                  <textarea class="form-control" rows="7" name="comment" id="comment" style="resize:vertical"></textarea>
                </div>
                <hr>
                <div class="text-right">
                    <button type='button' id='nexttab2' class='btn btn-success'>Next<span class='glyphicon glyphicon-chevron-right'></span></button>
                </div>
            </div>

            <div id="attachments" class="tab-pane fade">
                <h4>Upload Files</h4>
                <hr>
                <span class="help-block">
                    Depending on whether the piece is split into movements or not, you may upload files to attach
                    to the piece itself or create movements and attach pieces to them individually.
                </span>
                <div class="well">
                    <h4>Piece Files</h4>
                    <table class="table table-hover" >
                        <colgroup>
                            <col class="text-center" style="width: 5%;">
                            <col style="width: 5%;">
                            <col style="width: 70%;">
                            <col style="width: 20%;">
                        </colgroup>
                            <tbody id="piece_file_table">
                            <tr>
                                <th class="text-center">+/-</th>
                                <th class="text-center">#</th>
                                <th>File Source</th>
                                <th>Files</th>
                            </tr>
                            <!-- User can add rows for files here -->
                            </tbody>
                    </table>
                    <div><button id="new_piece_file" type="button" class="btn btn-default" >Add File</button></div>
                </div>
                <br>
                <div class="well">
                    <h4>Movements</h4>
                    <table class="table table-hover" >
                        <colgroup>
                            <col class="text-center" style="width: 5%;">
                            <col style="width: 5%;">
                            <col style="width: 70%;">
                            <col style="width: 20%;">
                        </colgroup>
                            <tbody id="movement_table">
                            <tr>
                                <th class="text-center">+/-</th>
                                <th class="text-center">#</th>
                                <th>Movement Title</th>
                                <th>Files</th>
                            </tr>
                            <!-- User can add rows for files here -->
                            </tbody>
                    </table>
                    <div><button id="new_mov" type="button" class="btn btn-default" >Add Movement</button></div>
                </div>
                <div class="text-right">
                    <button type='submit' id='piece-submit' class='btn btn-success'>Submit<span class='glyphicon glyphicon-chevron-right'></span></button>
                </div>
            </div>
        </div>
        <br>
    </form>
</div>


{%  endblock %}

